<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

/**
 * Broker
 * @package Broker
 */
namespace Broker;

/**
 * Parser json request
 */
class Parser {
  /**
   * Request to broker
   *
   * @var string
   */
  private $brokerRequest = null;
  /**
   * Status key
   * 
   * @var string
   */
  private $statusKey = null;
  /**
   * Url solr
   *
   * @var string
   */
  private $solrUrl = null;
  /**
   * Solr shards
   *
   * @var array
   */
  private $solrShards = null;
  /**
   * Solr request
   *
   * @var string
   */
  private $solrRequest = null;
  /**
   * Solr request addition
   *
   * @var string
   */
  private $solrRequestAddition = null;
  /**
   * Solr configuration
   *
   * @var string
   */
  private $solrConfiguration = null;
  /**
   * Collection ids
   *
   * @var array
   */
  private $collectionIds = array ();
  /**
   * Response joins
   *
   * @var array
   */
  private $responseJoins = null;
  /**
   * Warnings
   *
   * @var array
   */
  private $warnings = array ();
  /**
   * Errors
   *
   * @var array errors
   */
  private $errors = array ();
  /**
   * Cache
   *
   * @var \Broker\Cache
   */
  private $cache = null;
  /**
   * Cache enables
   *
   * @var boolean
   */
  private $cacheEnabled = true;
  /**
   * Configuration
   *
   * @var object
   */
  private $configuration = null;
  /**
   * Expansion cache
   *
   * @var \Broker\ExpansionCache
   */
  private $expansionCache = null;
  /**
   * Configurations
   *
   * @var array
   */
  private $__configurations = array ();
  /**
   * Collection
   *
   * @var \Broker\Collection
   */
  private $collection = null;
  /**
   * Constructor
   *
   * @param object $request          
   * @param array $configuration          
   * @param \Broker\Cache $cache          
   * @param \Broker\Collection $collection          
   * @param \Broker\ExpansionCache $expansionCache          
   * @param string $statusKey         
   * @throws \Exception
   */
  public function __construct($request, $configuration, $cache, $collection, $expansionCache, $statusKey) {
    if ($collection != null) {
      $this-&gt;collection = $collection;
    }
    $this-&gt;cache = $cache;
    $this-&gt;brokerRequest = is_string ( $request ) ? json_decode ( $request, false ) : $request;
    if ($statusKey != null &amp;&amp; (! is_string ( $statusKey ) || strlen ( $statusKey ) &lt; 10)) {
      throw new \Exception ( &quot;Could not parse request: invalid key&quot; );
    } else if($statusKey!=null) {
      $this-&gt;statusKey = $statusKey;      
    }
    $this-&gt;configuration = $configuration;
    $this-&gt;responseJoins = new \stdClass ();
    if ($this-&gt;brokerRequest != null &amp;&amp; json_last_error () == JSON_ERROR_NONE) {
      $this-&gt;parse ();
    } else {
      throw new \Exception ( &quot;Could not parse request: invalid or empty json&quot; );
    }
  }
  /**
   * Get solr request
   *
   * @return string
   */
  public function getRequest() {
    if (count ( $this-&gt;errors ) == 0) {
      return $this-&gt;solrRequest;
    } else {
      return null;
    }
  }
  /**
   * Get addition solr request
   *
   * @return string
   */
  public function getRequestAddition() {
    if (count ( $this-&gt;errors ) == 0) {
      return $this-&gt;solrRequestAddition;
    } else {
      return null;
    }
  }
  /**
   * Get status key
   *
   * @return string
   */  
  public function getStatusKey() {
    return $this-&gt;statusKey;
  }
  /**
   * Get solr url
   *
   * @return string
   */
  public function getUrl() {
    if (count ( $this-&gt;errors ) == 0) {
      return $this-&gt;solrUrl;
    } else {
      return null;
    }
  }
  /**
   * Get (or create) cache
   *
   * @return \Broker\Cache
   */
  public function getCache() {
    if ($this-&gt;cache == null &amp;&amp; $this-&gt;cacheEnabled) {
      $this-&gt;cache = new \Broker\Cache ( SITE_CACHE_DATABASE_DIR, $this-&gt;configuration );
    }
    return $this-&gt;cache;
  }
  /**
   * Get shards
   *
   * @return array
   */
  public function getShards() {
    if (count ( $this-&gt;errors ) == 0) {
      return $this-&gt;solrShards;
    } else {
      return null;
    }
  }
  /**
   * Get solr configuration
   *
   * @return array
   */
  public function getConfiguration() {
    if (count ( $this-&gt;errors ) == 0) {
      return $this-&gt;solrConfiguration;
    } else {
      return null;
    }
  }
  /**
   * Get errors
   *
   * @return array
   */
  public function getErrors() {
    return $this-&gt;errors;
  }
  /**
   * Get warnings
   *
   * @return array
   */
  public function getWarnings() {
    return $this-&gt;warnings;
  }
  /**
   * Get (or create) collection
   *
   * @return \Broker\Collection
   */
  public function getCollection() {
    if ($this-&gt;collection == null) {
      $this-&gt;collection = new \Broker\Collection ( SITE_CACHE_DATABASE_DIR, $this-&gt;configuration );
    }
    return $this-&gt;collection;
  }
  /**
   * Get collection ids
   *
   * @return array
   */
  public function getCollectionIds() {
    return $this-&gt;collectionIds;
  }
  /**
   * Get response joins
   *
   * @return object
   */
  public function getResponseJoins() {
    return $this-&gt;responseJoins;
  }
  /**
   * parse
   */
  private function parse() {
    $this-&gt;solrConfiguration = null;
    $__facetQueries = array ();
    $__mtasStats = array ();
    $requestList = array ();
    $requestAdditionalList = array (); 
    //$requestAdditionalList[] = &quot;debug=true&quot;;
    foreach ( $this-&gt;brokerRequest as $key =&gt; $value ) {
      if ($key == &quot;condition&quot;) {
        $this-&gt;brokerRequest-&gt;condition = $this-&gt;checkCondition ( $value );
      } else if ($key == &quot;filter&quot;) {
        $this-&gt;brokerRequest-&gt;filter = $this-&gt;checkFilters ( $value );
      } else if ($key == &quot;response&quot;) {
        $this-&gt;brokerRequest-&gt;response = $this-&gt;checkResponse ( $value );
      } else if ($key == &quot;sort&quot;) {
        $this-&gt;brokerRequest-&gt;sort = $this-&gt;checkSort ( $value );
      } else if ($key == &quot;debug&quot;) {
        $this-&gt;brokerRequest-&gt;debug = $this-&gt;checkDebug ( $value );
      } else if ($key == &quot;cache&quot;) {
        $this-&gt;brokerRequest-&gt;cache = $this-&gt;checkCache ( $value );
      } else if ($key == &quot;timeAllowed&quot;) {
        $this-&gt;brokerRequest-&gt;timeAllowed = $this-&gt;checkTimeAllowed ( $value );
      } else if ($key == &quot;configuration&quot;) {
        if ($value &amp;&amp; is_string ( $value )) {
          $this-&gt;solrConfiguration = $value;
        } else {
          $this-&gt;errors [] = &quot;configuration - configuration should be a string&quot;;
        }
      } else {
        $this-&gt;warnings [] = &quot;request - '{$key}' not recognized&quot;;
      }
    }
    if (count ( $this-&gt;errors ) == 0) {
      // compute configuration
      if (($config = $this-&gt;computeConfiguration ( $this-&gt;solrConfiguration )) == null) {
        if ($this-&gt;solrConfiguration) {
          $this-&gt;errors [] = &quot;solr - configuration '{$this-&gt;solrConfiguration}' does not match all requirements&quot;;
        } else {
          $this-&gt;errors [] = &quot;solr - could not find configuration matching all requirements&quot;;
        }
        $this-&gt;solrUrl = null;
        $this-&gt;solrShards = null;
      } else {
        $tmpList = $this-&gt;configuration-&gt;getConfig ( &quot;solr&quot; );
        $__config = $tmpList [$config];
        $this-&gt;solrUrl = isset ( $__config [&quot;url&quot;] ) ? $__config [&quot;url&quot;] : &quot;&quot;;
        $this-&gt;solrShards = isset ( $__config [&quot;shards&quot;] ) ? $__config [&quot;shards&quot;] : &quot;&quot;;
        $this-&gt;solrConfiguration = $config;
        //check timeAllowed for configuration
        if(isset($this-&gt;brokerRequest-&gt;timeAllowed)) {
          if(isset($__config [&quot;timeAllowed&quot;]) &amp;&amp; (intval($__config [&quot;timeAllowed&quot;])&gt;0)) {
            $this-&gt;brokerRequest-&gt;timeAllowed = min($this-&gt;brokerRequest-&gt;timeAllowed, intval($__config [&quot;timeAllowed&quot;]));
          }
        } else if(isset($__config [&quot;timeAllowed&quot;]) &amp;&amp; (intval($__config [&quot;timeAllowed&quot;])&gt;0)) {
          $this-&gt;brokerRequest-&gt;timeAllowed = intval($__config [&quot;timeAllowed&quot;]);
        }
      }
      // compute query
      if (isset ( $this-&gt;brokerRequest-&gt;filter )) {
        list ( $this-&gt;brokerRequest-&gt;filter, $filter_requestList, $filter_facetQueries, $filter_mtasStats ) = $this-&gt;parseFilters ( $this-&gt;brokerRequest-&gt;filter, $this-&gt;solrConfiguration );
        if ($filter_requestList &amp;&amp; count ( $filter_requestList ) &gt; 0) {
          $requestList = array_merge ( $requestList, $filter_requestList );
          $__facetQueries = array_merge ( $__facetQueries, $filter_facetQueries );
          $__mtasStats = array_merge ( $__mtasStats, $filter_mtasStats );
        }
      }
      if (isset ( $this-&gt;brokerRequest-&gt;condition )) {
        $this-&gt;brokerRequest-&gt;condition = $this-&gt;parseCondition ( $this-&gt;brokerRequest-&gt;condition, $this-&gt;solrConfiguration );
        if ($this-&gt;brokerRequest-&gt;condition &amp;&amp; is_object ( $this-&gt;brokerRequest-&gt;condition ) &amp;&amp; isset ( $this-&gt;brokerRequest-&gt;condition-&gt;__query )) {
          $requestList [] = &quot;q=&quot; . urlencode ( $this-&gt;brokerRequest-&gt;condition-&gt;__query );
          $__facetQueries = array_merge ( $__facetQueries, $this-&gt;brokerRequest-&gt;condition-&gt;__facetQueries );
          $__mtasStats = array_merge ( $__mtasStats, $this-&gt;brokerRequest-&gt;condition-&gt;__mtasStats );
        }
      } else {
        $requestList [] = &quot;q=*:*&quot;;
      }
      $__facetQueriesKeyList = array ();
      $this-&gt;checkResponseFacetQueries ( $__facetQueries, $__facetQueriesKeyList );
      if (count ( $this-&gt;errors ) == 0) {
        if (isset ( $this-&gt;brokerRequest-&gt;response ) || $this-&gt;statusKey != null) {
          if (! isset ( $this-&gt;brokerRequest-&gt;response )) {
            $this-&gt;brokerRequest-&gt;response = null;
          }
          $this-&gt;brokerRequest-&gt;response = $this-&gt;parseResponse ( $this-&gt;brokerRequest-&gt;response, $__facetQueries, $__mtasStats );
          if ($this-&gt;brokerRequest-&gt;response) {
            $requestList = array_merge ( $requestList, $this-&gt;brokerRequest-&gt;response-&gt;__requestList );
            $requestAdditionalList = array_merge ( $requestAdditionalList, $this-&gt;brokerRequest-&gt;response-&gt;__requestAdditionalList );            
          }
        }
        if (isset ( $this-&gt;brokerRequest-&gt;sort )) {
          $requestSort = $this-&gt;parseSort ( $this-&gt;brokerRequest-&gt;sort );
          if ($requestSort) {
            $requestList [] = $requestSort;
          }
        }
        if (isset ( $this-&gt;brokerRequest-&gt;debug )) {
          $requestDebug = $this-&gt;parseDebug ( $this-&gt;brokerRequest-&gt;debug );
          if ($requestDebug) {
            $requestList [] = $requestDebug;
          }
        }
        if (isset ( $this-&gt;brokerRequest-&gt;cache )) {
          $requestCache = $this-&gt;parseCache ( $this-&gt;brokerRequest-&gt;cache );
          if ($requestCache) {
            $requestList [] = $requestCache;
          }
        }
        if (isset ( $this-&gt;brokerRequest-&gt;timeAllowed )) {
          $requestTimeAllowed = $this-&gt;parseTimeAllowed ( $this-&gt;brokerRequest-&gt;timeAllowed );
          if ($requestTimeAllowed) {
            $requestAdditionalList [] = $requestTimeAllowed;
          }
        }
      }
    }
    $requestList [] = &quot;wt=json&quot;;
    $requestList [] = &quot;echoParams=none&quot;;
    $this-&gt;solrRequest = implode ( &quot;&amp;&quot;, $requestList );
    $this-&gt;solrRequestAddition = (count($requestAdditionalList)&gt;0)?implode(&quot;&amp;&quot;, $requestAdditionalList):null;    
  }
  /**
   * Check cache in request
   *
   * @param object $object          
   * @return object
   */
  private function checkCache($object) {
    if (is_bool ( $object )) {
      $this-&gt;cacheEnabled = $object;
      return $object;
    } else {
      $this-&gt;errors [] = &quot;cache - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check timeAllowed in request
   *
   * @param object $object
   * @return object
   */
  private function checkTimeAllowed($object) {
    if (is_numeric ( $object )) {
      $this-&gt;timeAllowed = $object;
      return $object;
    } else {
      $this-&gt;errors [] = &quot;timeAllowed - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check debug in request
   *
   * @param object $object          
   * @return object
   */
  private function checkDebug($object) {
    if ($object &amp;&amp; is_string ( $object )) {
      return $object;
    } else {
      $this-&gt;errors [] = &quot;debug - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check sort in request
   *
   * @param object $object          
   * @return object
   */
  private function checkSort($object) {
    if ($object &amp;&amp; is_array ( $object ) &amp;&amp; count ( $object ) &gt; 0) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        $object [$i] = $this-&gt;checkSortitem ( $object [$i] );
      }
      return $object;
    } else {
      $this-&gt;errors [] = &quot;sort - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check sortItem in sort
   *
   * @param object $object          
   * @return object
   */
  private function checkSortitem($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $configurations = $this-&gt;getConfigurationsForField ( $object-&gt;field );
        if (count ( $configurations ) &gt; 0) {
          $this-&gt;__configurations [] = $configurations;
        } else if (preg_match ( &quot;/^(\&quot;[^\&quot;]+\&quot;|'[^']+')$/&quot;, $object-&gt;field ) || preg_match ( &quot;/^[^\(]+\(.*\)$/&quot;, $object-&gt;field )) {
          // ignore, function
        } else if ($object-&gt;field !== &quot;score&quot;) {
          $this-&gt;warnings [] = &quot;sort - sortitem - field '&quot; . $object-&gt;field . &quot;' not found in any configuration&quot;;
        }
        $ignoreItems = array (
            &quot;field&quot; 
        );
        if (isset ( $object-&gt;direction )) {
          $ignoreItems [] = &quot;direction&quot;;
          if (! is_string ( $object-&gt;direction ) || ($object-&gt;direction != &quot;asc&quot; &amp;&amp; $object-&gt;direction != &quot;desc&quot;)) {
            $this-&gt;warnings [] = &quot;sort - sortitem - direction should be \&quot;asc\&quot; or \desc\&quot;&quot;;
            unset ( $object-&gt;direction );
          }
        }
        foreach ( $object as $key =&gt; $value ) {
          if (! in_array ( $key, $ignoreItems )) {
            $this-&gt;warnings [] = &quot;sort - sortitem - {$key} not expected&quot;;
          }
        }
      } else {
        $this-&gt;errors [] = &quot;sort - sortitem - no (valid) field&quot;;
      }
      return $object;
    } else {
      $this-&gt;errors [] = &quot;sort - sortitem - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check response in request
   *
   * @param object $object          
   * @return object
   */
  private function checkResponse($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;documents&quot;) {
          $object-&gt;documents = $this-&gt;checkResponseDocuments ( $value );
        } else if ($key == &quot;facets&quot;) {
          $object-&gt;facets = $this-&gt;checkResponseFacets ( $value );
        } else if ($key == &quot;stats&quot;) {
          $object-&gt;stats = $this-&gt;checkResponseStats ( $value );
        } else if ($key == &quot;mtas&quot;) {
          $object-&gt;mtas = $this-&gt;checkResponseMtas ( $value );
        } else {
          $this-&gt;warnings [] = &quot;response - {$key} not expected&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;response - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check documents in response
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseDocuments($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;fields&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            $__fields = array ();
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $item = $value [$i];
              if ($item != null) {
                if (is_string ( $item )) {
                  $__fields [] = $item;
                  if ($item == &quot;*&quot; || preg_match ( &quot;/^\[[^\]]*\]$/&quot;, $item )) {
                    // do nothing
                  } else {
                    if (preg_match ( &quot;/^([^:]+):([^:]+)$/&quot;, $item, $match )) {
                      $checkItem = $match [2];
                    } else {
                      $checkItem = $item;
                    }
                    if (filter_var ( $checkItem, FILTER_VALIDATE_INT ) !== false || filter_var ( $checkItem, FILTER_VALIDATE_FLOAT ) !== false || preg_match ( &quot;/^(\&quot;[^\&quot;]+\&quot;|'[^']+')$/&quot;, $checkItem ) || preg_match ( &quot;/^[^\(]+\(.*\)$/&quot;, $checkItem )) {
                      // function, do nothing
                    } else {
                      $configurations = $this-&gt;getConfigurationsForField ( $checkItem );
                      if (count ( $configurations ) &gt; 0) {
                        $this-&gt;__configurations [] = $configurations;
                      } else if ($checkItem !== &quot;score&quot;) {
                        $this-&gt;warnings [] = &quot;documents - field '&quot; . $checkItem . &quot;' not found in any configuration&quot;;
                      }
                    }
                  }
                } else if (is_object ( $item )) {
                  $value [$i] = $this-&gt;checkResponseDocumentsJoin ( $item );
                } else {
                  $this-&gt;errors [] = &quot;documents - unrecognized field type&quot;;
                }
              }
            }
          } else {
            $this-&gt;errors [] = &quot;documents - fields should be array&quot;;
          }
        } else if ($key == &quot;start&quot;) {
          if ($value === null || ! is_int ( $value )) {
            $this-&gt;errors [] = &quot;documents - start should be integer&quot;;
          }
        } else if ($key == &quot;rows&quot;) {
          if ($value === null || ! is_int ( $value )) {
            $this-&gt;errors [] = &quot;documents - rows should be integer&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;documents - {$key} not expected&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;documents - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check documents join in response
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseDocumentsJoin($object) {
    if (is_object ( $object ) &amp;&amp; isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type ) &amp;&amp; $object-&gt;type == &quot;join&quot;) {
      if (! isset ( $object-&gt;name ) || ! is_string ( $object-&gt;name )) {
        $this-&gt;errors [] = &quot;documents - join - no (valid) name provided for join&quot;;
      }
      if (! isset ( $object-&gt;to ) || ! is_string ( $object-&gt;to )) {
        $this-&gt;errors [] = &quot;documents - join - no (valid) to field provided for join&quot;;
      }
      if (! isset ( $object-&gt;from ) || ! is_string ( $object-&gt;from )) {
        $this-&gt;errors [] = &quot;documents - join - no (valid) from field provided for join&quot;;
      }
      if (! isset ( $object-&gt;fields ) || ! is_array ( $object-&gt;fields ) || count ( $object-&gt;fields ) == 0) {
        $this-&gt;errors [] = &quot;documents - join - no (valid) fields provided for join&quot;;
      } else {
        foreach ( $object-&gt;fields as $fieldsItem ) {
          if (! is_string ( $fieldsItem ) &amp;&amp; ! is_object ( $fieldsItem )) {
            $this-&gt;errors [] = &quot;documents - join - invalid field provided for join&quot;;
          }
        }
      }
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;type&quot; || $key == &quot;name&quot; || $key == &quot;to&quot; || $key == &quot;from&quot; || $key == &quot;fields&quot;) {
          // ignore
        } else if ($key == &quot;configuration&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;documents - join - invalid configuration provided for join&quot;;
          }
        } else if ($key == &quot;filter&quot; || $key == &quot;condition&quot;) {
          if (! is_object ( $value )) {
            $this-&gt;errors [] = &quot;documents - join - invalid {$key} provided for join&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;documents - join - {$key} not expected in join&quot;;
        }
      }
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Check facets in response
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseFacets($object) {
    if (($object &amp;&amp; is_object ( $object ))) {
      $facetFieldKeyList = array ();
      $facetQueryKeyList = array ();
      $facetRangeKeyList = array ();
      $facetPivotKeyList = array ();
      $facetHeatmapKeyList = array ();
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;facetfields&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            list ( $object-&gt;facetfields, $facetFieldKeyList ) = $this-&gt;checkResponseFacetFields ( $object-&gt;facetfields, $facetFieldKeyList );
          } else {
            $this-&gt;errors [] = &quot;facets - facetfields should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;facetqueries&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            list ( $object-&gt;facetqueries, $facetQueryKeyList ) = $this-&gt;checkResponseFacetQueries ( $object-&gt;facetqueries, $facetQueryKeyList );
          } else {
            $this-&gt;errors [] = &quot;facets - facetqueries should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;facetranges&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            list ( $object-&gt;facetranges, $facetRangeKeyList ) = $this-&gt;checkResponseFacetRanges ( $object-&gt;facetranges, $facetRangeKeyList );
          } else {
            $this-&gt;errors [] = &quot;facets - facetranges should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;facetpivots&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            list ( $object-&gt;facetpivots, $facetPivotKeyList ) = $this-&gt;checkResponseFacetPivots ( $object-&gt;facetpivots, $facetPivotKeyList );
          } else {
            $this-&gt;errors [] = &quot;facets - facetpivots should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;facetheatmaps&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            list ( $object-&gt;facetheatmaps, $facetHeatmapKeyList ) = $this-&gt;checkResponseFacetHeatmaps ( $object-&gt;facetheatmaps, $facetHeatmapKeyList );
          } else {
            $this-&gt;errors [] = &quot;facets - facetheatmaps should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;prefix&quot; || $key == &quot;sort&quot; || $key == &quot;method&quot; || $key == &quot;contains&quot;) {
          if ($value != null &amp;&amp; is_string ( $value )) {
            if ($key == &quot;sort&quot; &amp;&amp; ($value != &quot;index&quot; &amp;&amp; $value != &quot;count&quot;)) {
              $this-&gt;warnings [] = &quot;facets - sort \&quot;&quot; . $value . &quot;\&quot; should be \&quot;index\&quot; or \&quot;count\&quot;&quot;;
            } else if ($key == &quot;method&quot; &amp;&amp; ($value != &quot;enum&quot; &amp;&amp; $value != &quot;fc&quot; &amp;&amp; $value != &quot;fcs&quot;)) {
              $this-&gt;warnings [] = &quot;facets - method \&quot;&quot; . $value . &quot;\&quot; should be \&quot;enum\&quot;, \&quot;fc\&quot; or \&quot;fcs\&quot;&quot;;
            }
          } else {
            $this-&gt;warnings [] = &quot;facets - {$key} should be a string&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;limit&quot; || $key == &quot;offset&quot; || $key == &quot;mincount&quot;) {
          if ($value == null || ! is_integer ( $value )) {
            $this-&gt;warnings [] = &quot;facets - {$key} should be an integer&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;missing&quot;) {
          if ($value == null || ! is_bool ( $value )) {
            $this-&gt;warnings [] = &quot;facets - {$key} should be a boolean&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;excludeTerms&quot;) {
          if ($value == null || ! is_array ( $value ) || count ( $value ) == 0) {
            $this-&gt;warnings [] = &quot;facets - {$key} should be an  non-empty array&quot;;
            unset ( $object-&gt;{$key} );
          } else {
            foreach ( $value as $valueItem ) {
              if (! is_string ( $valueItem )) {
                $this-&gt;warnings [] = &quot;facets - {$key} - items in array should be string&quot;;
                unset ( $object-&gt;{$key} );
                break;
              }
            }
          }
        } else {
          $this-&gt;warnings [] = &quot;facets - {$key} not expected&quot;;
        }
      }
      $object-&gt;__facetqueriesKeylist = $facetQueryKeyList;
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;facets - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check facet fields in response
   *
   * @param array $facetfields          
   * @param array $keyList          
   */
  private function checkResponseFacetFields($facetfields, $keyList) {
    if (count ( $facetfields ) &gt; 0) {
      for($i = 0; $i &lt; count ( $facetfields ); $i ++) {
        list ( $facetfields [$i], $keyList ) = $this-&gt;checkResponseFacetField ( $facetfields [$i], $keyList );
      }
    }
    return array (
        $facetfields,
        $keyList 
    );
  }
  /**
   * Check facet field
   *
   * @param object $object          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseFacetField($object, $keyList) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $configurations = $this-&gt;getConfigurationsForField ( $object-&gt;field );
        if (count ( $configurations ) &gt; 0) {
          $this-&gt;__configurations [] = $configurations;
          if (isset ( $object-&gt;__options )) {
            $this-&gt;warnings [] = &quot;facets - facetfields - __options not expected&quot;;
          }
          $object-&gt;__options = array ();
          if (isset ( $object-&gt;key )) {
            if (is_string ( $object-&gt;key )) {
              $counter = 0;
              if (in_array ( $object-&gt;key, $keyList )) {
                $this-&gt;warnings [] = &quot;facets - facetfields - key &quot; . $object-&gt;key . &quot; already exists&quot;;
                $counter = 0;
                $originalKey = $object-&gt;key;
                while ( in_array ( $object-&gt;key, $keyList ) ) {
                  $counter ++;
                  $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
                }
              }
            } else {
              unset ( $object-&gt;key );
              $this-&gt;warnings [] = &quot;facets - facetfields - key should be a string&quot;;
            }
          }
          if (! isset ( $object-&gt;key )) {
            $counter = 0;
            $object-&gt;key = $object-&gt;field;
            $originalKey = $object-&gt;key;
            while ( in_array ( $object-&gt;key, $keyList ) ) {
              $counter ++;
              $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
            }
          }
          $object-&gt;__options [] = &quot;key=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;key ) . &quot;\&quot;&quot;;
          $keyList [] = $object-&gt;key;
          if (isset ( $object-&gt;ex )) {
            if (is_string ( $object-&gt;ex )) {
              $object-&gt;__options [] = &quot;ex=\&quot;&quot; . implode ( &quot;,&quot;, array_map ( &quot;base64_encode&quot;, explode ( &quot;,&quot;, $object-&gt;ex ) ) ) . &quot;\&quot;&quot;;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetfields - ex should be a string&quot;;
            }
          }
          foreach ( $object as $key =&gt; $value ) {
            if ($key == &quot;field&quot; || $key == &quot;key&quot; || $key == &quot;ex&quot; || $key == &quot;__options&quot;) {
              // ignore
            } else if ($key == &quot;prefix&quot; || $key == &quot;sort&quot; || $key == &quot;method&quot; || $key == &quot;contains&quot;) {
              if (is_string ( $value )) {
                if ($key == &quot;sort&quot; &amp;&amp; ($value != &quot;index&quot; &amp;&amp; $value != &quot;count&quot;)) {
                  $this-&gt;warnings [] = &quot;facets - facetfields - sort \&quot;&quot; . $value . &quot;\&quot; should be \&quot;index\&quot; or \&quot;count\&quot;&quot;;
                } else if ($key == &quot;method&quot; &amp;&amp; ($value != &quot;enum&quot; &amp;&amp; $value != &quot;fc&quot; &amp;&amp; $value != &quot;fcs&quot;)) {
                  $this-&gt;warnings [] = &quot;facets - facetfields - method \&quot;&quot; . $value . &quot;\&quot; should be \&quot;enum\&quot;, \&quot;fc\&quot; or \&quot;fcs\&quot;&quot;;
                } else {
                  $object-&gt;__options [] = &quot;facet.&quot; . $key . &quot;=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $value ) . &quot;\&quot;&quot;;
                }
              } else {
                $this-&gt;warnings [] = &quot;facets - facetfields - {$key} should be a string&quot;;
              }
            } else if ($key == &quot;limit&quot; || $key == &quot;offset&quot; || $key == &quot;mincount&quot;) {
              if (! is_integer ( $value )) {
                $this-&gt;warnings [] = &quot;facets - facetfields - {$key} should be an integer&quot;;
              }
            } else if ($key == &quot;missing&quot;) {
              if (! is_bool ( $value )) {
                $this-&gt;warnings [] = &quot;facets - facetfields - {$key} should be a boolean&quot;;
              } else {
                $object-&gt;__options [] = &quot;facet.&quot; . $key . &quot;=\&quot;&quot; . ($value ? &quot;true&quot; : &quot;false&quot;) . &quot;\&quot;&quot;;
              }
            } else if ($key == &quot;excludeTerms&quot;) {
              if ($value == null || ! is_array ( $value ) || count ( $value ) == 0) {
                $this-&gt;warnings [] = &quot;facets - facetfields - {$key} should be an  non-empty array&quot;;
              } else {
                $validArrayOfStrings = true;
                foreach ( $value as $valueItem ) {
                  if (! is_string ( $valueItem )) {
                    $this-&gt;warnings [] = &quot;facets - {$key} - items in array should be string&quot;;
                    $validArrayOfStrings = false;
                    break;
                  }
                }
                if ($validArrayOfStrings) {
                  $object-&gt;__options [] = &quot;facet.&quot; . $key . &quot;=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, implode ( &quot;,&quot;, $value ) ) . &quot;\&quot;&quot;;
                }
              }
            } else if ($key == &quot;join&quot;) {
              if (! is_object ( $value )) {
                $this-&gt;warnings [] = &quot;facets - facetfields - {$key} should be an object&quot;;
              } else {
                $object-&gt;join = $this-&gt;checkResponseFacetFieldJoin ( $value );
              }
            } else {
              $this-&gt;warnings [] = &quot;facets - facetfields - {$key} not expected&quot;;
            }
          }
          return array (
              $object,
              $keyList 
          );
        } else {
          $this-&gt;errors [] = &quot;facets - facetfields - field '&quot; . $object-&gt;field . &quot;' not found in any configuration&quot;;
          return array (
              null,
              $keyList 
          );
        }
      } else {
        $this-&gt;errors [] = &quot;facets - facetfields - no (valid) field provided&quot;;
        return array (
            null,
            $keyList 
        );
      }
    } else {
      $this-&gt;warnings [] = &quot;facets - facetfields - unexpected type&quot;;
      return array (
          null,
          $keyList 
      );
    }
  }
  /**
   * Check join facet field
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseFacetFieldJoin($object) {
    if (is_object ( $object )) {
      if (! isset ( $object-&gt;to ) || ! is_string ( $object-&gt;to )) {
        $this-&gt;errors [] = &quot;facets - facetfields - no (valid) to field provided for join&quot;;
        return null;
      } else if (! isset ( $object-&gt;fields ) || ! is_array ( $object-&gt;fields ) || count ( $object-&gt;fields ) == 0) {
        $this-&gt;errors [] = &quot;facets - facetfields - no (valid) fields provided for join&quot;;
        return null;
      } else {
        foreach ( $object-&gt;fields as $fieldsItem ) {
          if (! is_string ( $fieldsItem ) &amp;&amp; ! is_object ( $fieldsItem )) {
            $this-&gt;errors [] = &quot;facets - facetfields - invalid field provided for join&quot;;
          }
        }
      }
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;to&quot; || $key == &quot;fields&quot;) {
          // ignore
        } else if ($key == &quot;configuration&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;facets - facetfields - invalid configuration provided for join&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;facets - facetfields - {$key} not expected in join&quot;;
        }
      }
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Check facet queries
   *
   * @param array $facetqueries          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseFacetQueries($facetqueries, $keyList) {
    if (count ( $facetqueries ) &gt; 0) {
      for($i = 0; $i &lt; count ( $facetqueries ); $i ++) {
        list ( $facetqueries [$i], $keyList ) = $this-&gt;checkResponseFacetQuery ( $facetqueries [$i], $keyList );
      }
    }
    return array (
        $facetqueries,
        $keyList 
    );
  }
  /**
   * Check facet query
   *
   * @param object $object          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseFacetQuery($object, $keyList) {
    if ($object &amp;&amp; is_object ( $object )) {
      // generated
      if (isset ( $object-&gt;__query ) &amp;&amp; $object-&gt;__query &amp;&amp; is_string ( $object-&gt;__query )) {
        foreach ( $object as $key =&gt; $value ) {
          if ($key == &quot;key&quot;) {
            if ($value == null || ! is_string ( $value )) {
              $this-&gt;warnings [] = &quot;facets - facetquery (generated) - key should be a string&quot;;
            } else {
              if (in_array ( $value, $keyList )) {
                $this-&gt;errors [] = &quot;facets - facetquery (generated) - key '&quot; . $value . &quot;' already used&quot;;
              } else {
                $keyList [] = $value;
              }
            }
          } else if ($key == &quot;ex&quot;) {
            if ($value == null || ! is_string ( $value )) {
              $this-&gt;warnings [] = &quot;facets - facetquery (generated) - ex should be a string&quot;;
            }
          } else if ($key == &quot;tag&quot;) {
            if ($value == null || ! is_string ( $value )) {
              $this-&gt;warnings [] = &quot;facets - facetquery (generated) - tag should be a string&quot;;
            }
          } else if ($key == &quot;__query&quot;) {
            if ($value == null || ! is_string ( $value )) {
              $this-&gt;errors [] = &quot;facets - facetquery (generated) - no query&quot;;
            }
          }
        }
        if (! isset ( $object-&gt;__query )) {
          $this-&gt;errors [] = &quot;facets - facetqueries (generated) - no (valid) query provided&quot;;
          return array (
              null,
              $keyList 
          );
        } else {
          return array (
              $object,
              $keyList 
          );
        }
        // provided
      } else {
        foreach ( $object as $key =&gt; $value ) {
          if ($key == &quot;key&quot;) {
            if ($value == null || ! is_string ( $value )) {
              $this-&gt;warnings [] = &quot;facets - facetquery - key should be a string&quot;;
            } else {
              if (in_array ( $value, $keyList )) {
                $this-&gt;errors [] = &quot;facets - facetquery - key '&quot; . $value . &quot;' already used&quot;;
              } else {
                $keyList [] = $value;
              }
            }
          } else if ($key == &quot;ex&quot;) {
            if ($value == null || ! is_string ( $value )) {
              $this-&gt;warnings [] = &quot;facets - facetquery - ex should be a string&quot;;
            }
          } else if ($key == &quot;tag&quot;) {
            if ($value == null || ! is_string ( $value )) {
              $this-&gt;warnings [] = &quot;facets - facetquery - tag should be a string&quot;;
            }
          } else if ($key == &quot;condition&quot;) {
            $object-&gt;condition = $this-&gt;checkCondition ( $object-&gt;condition );
          }
        }
        if (! isset ( $object-&gt;condition ) || $object-&gt;condition == null) {
          $this-&gt;errors [] = &quot;facets - facetqueries - no (valid) condition provided&quot; . var_export ( $object, true );
          return array (
              null,
              $keyList 
          );
        } else {
          return array (
              $object,
              $keyList 
          );
        }
      }
    } else {
      $this-&gt;warnings [] = &quot;facets - facetqueries - unexpected type&quot;;
      return array (
          null,
          $keyList 
      );
    }
  }
  /**
   * Check facet ranges
   *
   * @param array $facetranges          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseFacetRanges($facetranges, $keyList) {
    if (count ( $facetranges ) &gt; 0) {
      for($i = 0; $i &lt; count ( $facetranges ); $i ++) {
        list ( $facetranges [$i], $keyList ) = $this-&gt;checkResponseFacetRange ( $facetranges [$i], $keyList );
      }
    }
    return array (
        $facetranges,
        $keyList 
    );
  }
  /**
   * Check facet range
   *
   * @param object $object          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseFacetRange($object, $keyList) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $configurations = $this-&gt;getConfigurationsForField ( $object-&gt;field );
        if (count ( $configurations ) &gt; 0) {
          $this-&gt;__configurations [] = $configurations;
          if (isset ( $object-&gt;__options )) {
            $this-&gt;warnings [] = &quot;facets - facetranges - __options not expected&quot;;
          }
          $object-&gt;__options = array ();
          $ignoreList = array (
              &quot;__options&quot;,
              &quot;field&quot;,
              &quot;key&quot; 
          );
          $optionalItems = array (
              &quot;include&quot;,
              &quot;other&quot;,
              &quot;tag&quot; 
          );
          foreach ( $optionalItems as $optionalItem ) {
            if (isset ( $object-&gt;{$optionalItem} )) {
              $ignoreList [] = $optionalItem;
              if (is_string ( $object-&gt;{$optionalItem} )) {
                $object-&gt;__options [] = $optionalItem . &quot;=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;{$optionalItem} ) . &quot;\&quot;&quot;;
              } else {
                $this-&gt;warnings [] = &quot;facets - facetranges - &quot; . $optionalItem . &quot; should be a string&quot;;
              }
            }
          }
          if (isset ( $object-&gt;ex )) {
            $ignoreList [] = &quot;ex&quot;;
            if (is_string ( $object-&gt;ex )) {
              $object-&gt;__options [] = &quot;ex=\&quot;&quot; . implode ( &quot;,&quot;, array_map ( &quot;base64_encode&quot;, explode ( &quot;,&quot;, $object-&gt;ex ) ) ) . &quot;\&quot;&quot;;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetranges - ex should be a string&quot;;
            }
          }
          if (isset ( $object-&gt;other )) {
            $ignoreList [] = &quot;other&quot;;
            if (is_string ( $object-&gt;other )) {
              $object-&gt;__options [] = &quot;facet.range.other=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;other) . &quot;\&quot;&quot;;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetranges - ex should be a string&quot;;
            }
          }
// disabled: solr-problem with sharding
//           if (isset ( $object-&gt;mincount )) {
//             $ignoreList [] = &quot;mincount&quot;;
//             if (is_numeric ( $object-&gt;mincount )) {
//               $object-&gt;__options [] = &quot;facet.mincount=&quot;.$object-&gt;mincount;
//             } else {
//               $this-&gt;warnings [] = &quot;facets - facetranges - mincount should be numeric&quot;;
//             }
//           }
          if (isset ( $object-&gt;key )) {
            if (is_string ( $object-&gt;key )) {
              $counter = 0;
              if (in_array ( $object-&gt;key, $keyList )) {
                $this-&gt;warnings [] = &quot;facets - facetranges - key &quot; . $object-&gt;key . &quot; already exists&quot;;
                $counter = 0;
                $originalKey = $object-&gt;key;
                while ( in_array ( $object-&gt;key, $keyList ) ) {
                  $counter ++;
                  $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
                }
              }
            } else {
              unset ( $object-&gt;key );
              $this-&gt;warnings [] = &quot;facets - facetranges - key should be a string&quot;;
            }
          }
          if (! isset ( $object-&gt;key )) {
            $counter = 0;
            $object-&gt;key = $object-&gt;field;
            $originalKey = $object-&gt;key;
            while ( in_array ( $object-&gt;key, $keyList ) ) {
              $counter ++;
              $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
            }
          }
          $object-&gt;__options [] = &quot;key=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;key ) . &quot;\&quot;&quot;;
          $keyList [] = $object-&gt;key;
          $obligatoryOptions = array (
              &quot;start&quot;,
              &quot;end&quot;,
              &quot;gap&quot; 
          );
          foreach ( $obligatoryOptions as $obligatoryOption ) {
            $ignoreList [] = $obligatoryOption;
            if (isset ( $object-&gt;{$obligatoryOption} )) {
              if (is_string ( $object-&gt;{$obligatoryOption} ) || is_int ( $object-&gt;{$obligatoryOption} )) {
                $object-&gt;__options [] = &quot;facet.range.&quot; . $obligatoryOption . &quot;=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;{$obligatoryOption} ) . &quot;\&quot;&quot;;
              } else {
                $this-&gt;errors [] = &quot;facets - facetranges - &quot; . $obligatoryOption . &quot; should be a string or an integer&quot;;
              }
            } else {
              $this-&gt;errors [] = &quot;facets - facetranges - &quot; . $obligatoryOption . &quot; not set&quot;;
            }
          }
          foreach ( $object as $key =&gt; $value ) {
            if (in_array ( $key, $ignoreList )) {
              // ignore
            } else {
              $this-&gt;warnings [] = &quot;facets - facetranges - {$key} not expected&quot;;
            }
          }
          return array (
              $object,
              $keyList 
          );
        } else {
          $this-&gt;warnings [] = &quot;facets - facetranges - unexpected type&quot;;
          return array (
              null,
              $keyList 
          );
        }
      } else {
        $this-&gt;errors [] = &quot;facets - facetranges - no (valid) field provided&quot;;
        return array (
            null,
            $keyList 
        );
      }
    } else {
      $this-&gt;warnings [] = &quot;facets - facetranges - unexpected type&quot;;
      return array (
          null,
          $keyList 
      );
    }
  }
  /**
   * Check facet pivots
   *
   * @param array $facetpivots          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseFacetPivots($facetpivots, $keyList) {
    if (count ( $facetpivots ) &gt; 0) {
      for($i = 0; $i &lt; count ( $facetpivots ); $i ++) {
        list ( $facetpivots [$i], $keyList ) = $this-&gt;checkResponseFacetPivot ( $facetpivots [$i], $keyList );
      }
    }
    return array (
        $facetpivots,
        $keyList 
    );
  }
  /**
   * Check facet pivot
   *
   * @param object $object          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseFacetPivot($object, $keyList) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (isset ( $object-&gt;pivot ) &amp;&amp; is_array ( $object-&gt;pivot )) {
        if (isset ( $object-&gt;__options )) {
          $this-&gt;warnings [] = &quot;facets - facetpivots - __options not expected&quot;;
        }
        $object-&gt;__options = array ();
        foreach ( $object-&gt;pivot as $pivot ) {
          if (is_string ( $pivot )) {
            $configurations = $this-&gt;getConfigurationsForField ( $pivot );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            }
          } else {
            $this-&gt;errors [] = &quot;facets - facetpivots - pivot should be a string&quot;;
          }
        }
        $ignoreList = array (
            &quot;__options&quot;,
            &quot;pivot&quot;,
            &quot;key&quot; 
        );
        if (isset ( $object-&gt;ex )) {
          $ignoreList [] = &quot;ex&quot;;
          if (is_string ( $object-&gt;ex )) {
            $object-&gt;__options [] = &quot;ex=\&quot;&quot; . implode ( &quot;,&quot;, array_map ( &quot;base64_encode&quot;, explode ( &quot;,&quot;, $object-&gt;ex ) ) ) . &quot;\&quot;&quot;;
          } else {
            $this-&gt;warnings [] = &quot;facets - facetpivots - ex should be a string&quot;;
          }
        }
        $stringSpecialList = array (
            &quot;query&quot;,
            &quot;range&quot;,
            &quot;stats&quot; 
        );
        $integerList = array (
            &quot;limit&quot;,
            &quot;offset&quot; 
        );
        foreach ( $stringSpecialList as $stringItem ) {
          if (isset ( $object-&gt;{$stringItem} )) {
            $ignoreList [] = $stringItem;
            if (is_string ( $object-&gt;{$stringItem} )) {
              $object-&gt;__options [] = $stringItem . &quot;=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;{$stringItem} ) . &quot;\&quot;&quot;;
            } else {
              unset ( $object-&gt;{$stringItem} );
            }
          }
        }
        foreach ( $integerList as $integerItem ) {
          if (isset ( $object-&gt;{$integerItem} )) {
            $ignoreList [] = $integerItem;
            if (is_int ( $object-&gt;{$integerItem} )) {
              $object-&gt;__options [] = &quot;facet.&quot; . $integerItem . &quot;=&quot; . $object-&gt;{$integerItem};
            } else {
              unset ( $object-&gt;{$stringItem} );
            }
          }
        }
        if (isset ( $object-&gt;key )) {
          if (is_string ( $object-&gt;key )) {
            $counter = 0;
            if (in_array ( $object-&gt;key, $keyList )) {
              $this-&gt;warnings [] = &quot;facets - facetpivots - key &quot; . $object-&gt;key . &quot; already exists&quot;;
              $counter = 0;
              $originalKey = $object-&gt;key;
              while ( in_array ( $object-&gt;key, $keyList ) ) {
                $counter ++;
                $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
              }
            }
          } else {
            unset ( $object-&gt;key );
            $this-&gt;warnings [] = &quot;facets - facetpivots - key should be a string&quot;;
          }
        }
        if (! isset ( $object-&gt;key )) {
          $counter = 0;
          $object-&gt;key = implode ( &quot;,&quot;, $object-&gt;pivot );
          $originalKey = $object-&gt;key;
          while ( in_array ( $object-&gt;key, $keyList ) ) {
            $counter ++;
            $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
          }
        }
        $object-&gt;__options [] = &quot;key=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;key ) . &quot;\&quot;&quot;;
        $keyList [] = $object-&gt;key;
        foreach ( $object as $key =&gt; $value ) {
          if (in_array ( $key, $ignoreList )) {
            // ignore
          } else if ($key == &quot;sort&quot;) {
            if (is_string ( $value )) {
              if ($key == &quot;sort&quot; &amp;&amp; ($value != &quot;index&quot; &amp;&amp; $value != &quot;count&quot;)) {
                $this-&gt;warnings [] = &quot;facets - facetpivots - sort \&quot;&quot; . $value . &quot;\&quot; should be \&quot;index\&quot; or \&quot;count\&quot;&quot;;
              } else {
                $object-&gt;__options [] = &quot;facet.&quot; . $key . &quot;=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $value ) . &quot;\&quot;&quot;;
              }
            } else {
              unset ( $object-&gt;key );
              $this-&gt;warnings [] = &quot;facets - facetpivots - {$key} should be a string&quot;;
            }
          } else {
            $this-&gt;warnings [] = &quot;facets - facetpivots - {$key} not expected&quot;;
          }
        }
        return array (
            $object,
            $keyList 
        );
      } else {
        $this-&gt;warnings [] = &quot;facets - facetpivots - unexpected type&quot;;
        return array (
            null,
            $keyList 
        );
      }
    } else {
      $this-&gt;errors [] = &quot;facets - facetpivots - no (valid) pivot provided&quot;;
      return array (
          null,
          $keyList 
      );
    }
  }
  /**
   * Check facet heatmaps
   *
   * @param array $facetheatmaps
   * @param array $keyList
   * @return array
   */
  private function checkResponseFacetHeatmaps($facetheatmaps, $keyList) {
    if (count ( $facetheatmaps ) &gt; 0) {
      for($i = 0; $i &lt; count ( $facetheatmaps ); $i ++) {
        list ( $facetheatmaps [$i], $keyList ) = $this-&gt;checkResponseFacetHeatmap ( $facetheatmaps [$i], $keyList );
      }
    }
    return array (
        $facetheatmaps,
        $keyList
    );
  }
  /**
   * Check facet pivot
   *
   * @param object $object
   * @param array $keyList
   * @return array
   */
  private function checkResponseFacetHeatmap($object, $keyList) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $configurations = $this-&gt;getConfigurationsForField ( $object-&gt;field );
        if (count ( $configurations ) &gt; 0) {
          $this-&gt;__configurations [] = $configurations;
          if (isset ( $object-&gt;__options )) {
            $this-&gt;warnings [] = &quot;facets - facetheatmaps - __options not expected&quot;;
          }
          $object-&gt;__options = array ();
          $ignoreList = array (
              &quot;__options&quot;,
              &quot;field&quot;,
              &quot;key&quot;
          );
          if (isset ( $object-&gt;geom )) {
            $ignoreList [] = &quot;geom&quot;;
            if (is_string ( $object-&gt;geom )) {
              $object-&gt;__options [] = &quot;facet.heatmap.geom=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;geom ) . &quot;\&quot;&quot;;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetranges - geom should be a string&quot;;
            }
          }
          if (isset ( $object-&gt;gridLevel )) {
            $ignoreList [] = &quot;gridLevel&quot;;
            if (is_int ( $object-&gt;gridLevel )) {
              $object-&gt;__options [] = &quot;facet.heatmap.gridLevel=&quot;.$object-&gt;gridLevel;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetheatmaps - gridLevel should be an integer&quot;;
            }
          }
          if (isset ( $object-&gt;distErrPct )) {
            $ignoreList [] = &quot;distErrPct&quot;;
            if (is_numeric ( $object-&gt;distErrPct )) {
              $object-&gt;__options [] = &quot;facet.heatmap.distErrPct=&quot;.$object-&gt;distErrPct;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetranges - distErrPct should be numeric&quot;;
            }
          }
          if (isset ( $object-&gt;distErr )) {
            $ignoreList [] = &quot;distErr&quot;;
            if (is_numeric ( $object-&gt;distErr )) {
              $object-&gt;__options [] = &quot;facet.heatmap.distErr=&quot;.$object-&gt;distErr;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetheatmaps - distErr should be numeric&quot;;
            }
          }
          if (isset ( $object-&gt;maxCells )) {
            $ignoreList [] = &quot;maxCells&quot;;
            if (is_numeric ( $object-&gt;maxCells )) {
              $object-&gt;__options [] = &quot;facet.heatmap.maxCells=&quot;.$object-&gt;maxCells;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetheatmaps - maxCells should be numeric&quot;;
            }
          }
          if (isset ( $object-&gt;ex )) {
            $ignoreList [] = &quot;ex&quot;;
            if (is_string ( $object-&gt;ex )) {
              $object-&gt;__options [] = &quot;ex=\&quot;&quot; . implode ( &quot;,&quot;, array_map ( &quot;base64_encode&quot;, explode ( &quot;,&quot;, $object-&gt;ex ) ) ) . &quot;\&quot;&quot;;
            } else {
              $this-&gt;warnings [] = &quot;facets - facetheatmaps - ex should be a string&quot;;
            }
          }
          if (isset ( $object-&gt;key )) {
            if (is_string ( $object-&gt;key )) {
              $counter = 0;
              if (in_array ( $object-&gt;key, $keyList )) {
                $this-&gt;warnings [] = &quot;facets - facetheatmaps - key &quot; . $object-&gt;key . &quot; already exists&quot;;
                $counter = 0;
                $originalKey = $object-&gt;key;
                while ( in_array ( $object-&gt;key, $keyList ) ) {
                  $counter ++;
                  $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
                }
              }
            } else {
              unset ( $object-&gt;key );
              $this-&gt;warnings [] = &quot;facets - facetheatmaps - key should be a string&quot;;
            }
          }
          if (! isset ( $object-&gt;key )) {
            $counter = 0;
            $object-&gt;key = $object-&gt;field;
            $originalKey = $object-&gt;key;
            while ( in_array ( $object-&gt;key, $keyList ) ) {
              $counter ++;
              $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
            }
          }
          $object-&gt;__options [] = &quot;key=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;key ) . &quot;\&quot;&quot;;
          $keyList [] = $object-&gt;key;
          foreach ( $object as $key =&gt; $value ) {
            if (in_array ( $key, $ignoreList )) {
              // ignore
            } else {
              $this-&gt;warnings [] = &quot;facets - facetheatmaps - {$key} not expected&quot;;
            }
          }
          return array (
              $object,
              $keyList
          );
        } else {
          $this-&gt;warnings [] = &quot;facets - facetheatmaps - unexpected field (type)&quot;;
          return array (
              null,
              $keyList
          );
        }
      } else {
        $this-&gt;errors [] = &quot;facets - facetheatmaps - no (valid) heatmap provided&quot;;
        return array (
            null,
            $keyList
        );
      }
    } else {
      $this-&gt;warnings [] = &quot;facets - facetheatmaps - unexpected type&quot;;
      return array (
          null,
          $keyList
      );
    }
  }
  
  /**
   * Check stats in response
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseStats($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      $statsFieldKeyList = array ();
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;statsfields&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            list ( $object-&gt;statsfields, $statsFieldKeyList ) = $this-&gt;checkResponseStatsFields ( $object-&gt;statsfields, $statsFieldKeyList );
          } else {
            $this-&gt;errors [] = &quot;stats - statsfields should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else {
          $this-&gt;warnings [] = &quot;stats - {$key} not expected&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;stats - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check stats fields in response
   *
   * @param array $statsfields          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseStatsFields($statsfields, $keyList) {
    if (count ( $statsfields ) &gt; 0) {
      for($i = 0; $i &lt; count ( $statsfields ); $i ++) {
        list ( $statsfields [$i], $keyList ) = $this-&gt;checkResponseStatsField ( $statsfields [$i], $keyList );
      }
    }
    return array (
        $statsfields,
        $keyList 
    );
  }
  /**
   * Check stats field
   *
   * @param object $object          
   * @param array $keyList          
   * @return array
   */
  private function checkResponseStatsField($object, $keyList) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        if (isset ( $object-&gt;__options )) {
          $this-&gt;warnings [] = &quot;stats - statsfields - __options not expected&quot;;
        }
        $object-&gt;__options = array ();
        // check field
        $validField = false;
        if (preg_match ( &quot;/^(\&quot;[^\&quot;]+\&quot;|'[^']+')$/&quot;, $object-&gt;field ) || preg_match ( &quot;/^[^\(]+\(.*\)$/&quot;, $object-&gt;field )) {
          // function
          $validField = true;
          $object-&gt;__options [] = &quot;func&quot;;
        } else {
          $configurations = $this-&gt;getConfigurationsForField ( $object-&gt;field );
          if (count ( $configurations ) &gt; 0) {
            $this-&gt;__configurations [] = $configurations;
            $validField = true;
          }
        }
        if ($validField) {
          if (isset ( $object-&gt;key )) {
            if (is_string ( $object-&gt;key )) {
              $counter = 0;
              if (in_array ( $object-&gt;key, $keyList )) {
                $this-&gt;warnings [] = &quot;stats - statsfields - key &quot; . $object-&gt;key . &quot; already exists&quot;;
                $counter = 0;
                $originalKey = $object-&gt;key;
                while ( in_array ( $object-&gt;key, $keyList ) ) {
                  $counter ++;
                  $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
                }
              }
            } else {
              unset ( $object-&gt;key );
              $this-&gt;warnings [] = &quot;stats - statsfields - key should be a string&quot;;
            }
          }
          if (! isset ( $object-&gt;key )) {
            $counter = 0;
            $object-&gt;key = $object-&gt;field;
            $originalKey = $object-&gt;key;
            while ( in_array ( $object-&gt;key, $keyList ) ) {
              $counter ++;
              $object-&gt;key = $originalKey . &quot; (&quot; . $counter . &quot;)&quot;;
            }
          }
          $object-&gt;__options [] = &quot;key=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;key ) . &quot;\&quot;&quot;;
          $keyList [] = $object-&gt;key;
          foreach ( $object as $key =&gt; $value ) {
            if ($key == &quot;field&quot; || $key == &quot;key&quot; || $key == &quot;__options&quot;) {
              // ignore
            } else if ($key == &quot;countDistinct&quot;) {
              if (is_bool ( $value )) {
                $object-&gt;__options [] = $key . &quot;=&quot; . ($value ? &quot;true&quot; : &quot;false&quot;);
              } else {
                $this-&gt;warnings [] = &quot;stats - statsfields - {$key} should be a boolean&quot;;
              }
            } else if ($key == &quot;tag&quot;) {
              if (is_string ( $value )) {
                $object-&gt;__options [] = $key . &quot;=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $value ) . &quot;\&quot;&quot;;
              } else {
                $this-&gt;warnings [] = &quot;stats - statsfields - {$key} should be a string&quot;;
              }
            } else if ($key == &quot;ex&quot;) {
              if (is_string ( $value )) {
                $object-&gt;__options [] = &quot;ex=\&quot;&quot; . implode ( &quot;,&quot;, array_map ( &quot;base64_encode&quot;, explode ( &quot;,&quot;, $object-&gt;ex ) ) ) . &quot;\&quot;&quot;;
              } else {
                $this-&gt;warnings [] = &quot;stats - statsfields - {$key} should be a string&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;stats - statsfields - {$key} not expected&quot;;
            }
          }
          return array (
              $object,
              $keyList 
          );
        } else {
          $this-&gt;errors [] = &quot;stats - statsfields - field '&quot; . $object-&gt;field . &quot;' not found in any configuration&quot;;
          return array (
              null,
              $keyList 
          );
        }
      } else {
        $this-&gt;errors [] = &quot;stats - statsfields - no (valid) field provided&quot;;
        return array (
            null,
            $keyList 
        );
      }
    } else {
      $this-&gt;warnings [] = &quot;stats - statsfields - unexpected type&quot;;
      return array (
          null,
          $keyList 
      );
    }
  }
  /**
   * Check mtas in response
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtas($object) {
    if (($object &amp;&amp; is_object ( $object ))) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;stats&quot;) {
          if (!is_null($value) &amp;&amp; is_object ( $value )) {
            $object-&gt;{$key} = $this-&gt;checkResponseMtasStats ( $value );
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be object&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;document&quot;) {
          if (!is_null($value) &amp;&amp; is_array ( $value )) {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasDocument ( $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;kwic&quot; || $key == &quot;list&quot;) {          
          if (!is_null($value) &amp;&amp; is_array ( $value ))  { 
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasKwicAndList ( $key, $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;page&quot;) {
          if (!is_null($value) &amp;&amp; is_array ( $value ))  {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasPage ( $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;heatmap&quot;) {
          if (!is_null($value) &amp;&amp; is_array ( $value ))  {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasHeatmap ( $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;termvector&quot;) { 
          if (!is_null($value) &amp;&amp; is_array ( $value )) { 
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasTermvector ( $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;facet&quot;) {
          if (!is_null($value) &amp;&amp; is_array ( $value )) {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasFacet ( $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;group&quot;) {
          if (!is_null($value) &amp;&amp; is_array ( $value )) {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasGroup ( $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;prefix&quot;) {
          if (!is_null($value) &amp;&amp; is_array ( $value )) {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasPrefix ( $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;collection&quot;) {
          if (!is_null($value) &amp;&amp; is_array ( $value )) {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;collection [$i] = $this-&gt;checkResponseMtasCollection ( $value [$i] );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;version&quot;) {
          if (!is_null($value) &amp;&amp; is_bool ( $value )) {
            $object-&gt;version = $this-&gt;checkResponseMtasVersion ( $value );
          } else {
            $this-&gt;errors [] = &quot;mtas - {$key} should be boolean&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - {$key} not expected&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas stats
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasStats($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;positions&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasStatsPositions ( $value [$i], $i );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - stats - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;tokens&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasStatsTokens ( $value [$i], $i );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - stats - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else if ($key == &quot;spans&quot;) {
          if ($value != null &amp;&amp; is_array ( $value )) {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasStatsSpans ( $value [$i], $i );
            }
          } else {
            $this-&gt;errors [] = &quot;mtas - stats - {$key} should be array&quot;;
            unset ( $object-&gt;{$key} );
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - stats - {$key} not expected&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - stats - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas stats positions
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasStatsPositions($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - positions - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - stats - positions - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;key&quot; || $key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - positions - {$key} should be string&quot;;
          }
        } else if ($key == &quot;minimum&quot; || $key == &quot;maximum&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - positions - {$key} should be integer&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - stats - positions - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - stats - positions - field is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - stats - positions unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas stats tokens
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasStatsTokens($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - tokens - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - stats - tokens - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;key&quot; || $key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - tokens - {$key} should be string&quot;;
          }
        } else if ($key == &quot;minimum&quot; || $key == &quot;maximum&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - tokens - {$key} should be integer&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - stats - tokens - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - stats - tokens - field is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - stats - tokens unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas stats spans
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasStatsSpans($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - spans - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - stats - spans - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;key&quot; || $key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - spans - {$key} should be string&quot;;
          }
        } else if ($key == &quot;queries&quot;) {
          if (! is_array ( $value ) || count ( $object-&gt;queries ) == 0) {
            $this-&gt;errors [] = &quot;mtas - stats - spans - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasQuery ( $value [$i], &quot;mtas - stats - spans - query - &quot; );
            }
          }
        } else if ($key == &quot;functions&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - spans - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkMtasStatsFunction ( $value [$i], &quot;mtas - stats - spans - query - &quot; );
            }
          }
        } else if ($key == &quot;minimum&quot; || $key == &quot;maximum&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - stats - spans - {$key} should be integer&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - stats - spans - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - stats - spans - field is obligatory&quot;;
        }
        if (! isset ( $object-&gt;queries )) {
          $this-&gt;errors [] = &quot;mtas - stats - spans - queries is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - stats - tokens unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas documents
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasDocument($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - document - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - document - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;prefix&quot; || $key == &quot;key&quot; || $key == &quot;type&quot; || $key == &quot;regexp&quot; || $key == &quot;ignoreRegexp&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - document - {$key} should be string&quot;;
          }
        } else if ($key == &quot;number&quot; || $key == &quot;listExpandNumber&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - document - {$key} should be integer&quot;;
          }
        } else if ($key == &quot;listRegexp&quot; || $key == &quot;listExpand&quot; || $key == &quot;ignoreListRegexp&quot;) {
          if (! is_bool ( $value )) {
            $this-&gt;errors [] = &quot;mtas - document - {$key} should be boolean&quot;;
          }
        } else if ($key == &quot;list&quot; || $key == &quot;ignoreList&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - document - {$key} should be non empty array of strings&quot;;
          } else {
            foreach ( $value as $valueItem ) {
              if (! is_string ( $valueItem )) {
                $this-&gt;errors [] = &quot;mtas - document - {$key} array should contain only strings&quot;;
                break;
              }
            }
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - document - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - document - field is obligatory&quot;;
        }
        if (! isset ( $object-&gt;prefix )) {
          $this-&gt;errors [] = &quot;mtas - document - prefix is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - document - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas kwic and list
   *
   * @param string $type          
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasKwicAndList($type, $object) {
    if ($type != &quot;list&quot; &amp;&amp; $type != &quot;kwic&quot;) {
      die ( &quot;incorrect call&quot; );
    }
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - {$type} - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - {$type} - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;prefix&quot; || $key == &quot;key&quot; || $key == &quot;output&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - {$type} - {$key} should be string&quot;;
          }
        } else if ($key == &quot;number&quot; || $key == &quot;start&quot; || $key == &quot;left&quot; || $key == &quot;right&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - {$type} - {$key} should be integer&quot;;
          }
        } else if ($key == &quot;query&quot;) {
          if (! is_object ( $value )) {
            $this-&gt;errors [] = &quot;mtas - {$type} - {$key} should be object&quot;;
          } else {
            $object-&gt;{$key} = $this-&gt;checkResponseMtasQuery ( $value, &quot;mtas - {$type} - {$key} - &quot; );
          }
        } else if ($type==&quot;kwic&quot; &amp;&amp; $key == &quot;page&quot;) {
          if (! is_object ( $value )) {
            $this-&gt;errors [] = &quot;mtas - {$type} - {$key} should be object&quot;;
          } else {
            $object-&gt;{$key} = $this-&gt;checkPage ( $value, &quot;mtas - {$type} - &quot; );
          }
        } else if ($type==&quot;list&quot; &amp;&amp; $key == &quot;fields&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - {$type} - {$key} should be list&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $item = $value [$i];
              if ($item != null) {
                if (is_string ( $item )) {
                  if ($item == &quot;*&quot; || preg_match ( &quot;/^\[[^\]]*\]$/&quot;, $item )) {
                    // do nothing
                  } else {
                    if (preg_match ( &quot;/^([^:]+):([^:]+)$/&quot;, $item, $match )) {
                      $checkItem = $match [2];
                    } else {
                      $checkItem = $item;
                    }
                    $configurations = $this-&gt;getConfigurationsForField ( $checkItem );
                    if (count ( $configurations ) &gt; 0) {
                      $this-&gt;__configurations [] = $configurations;
                    } else {
                      $this-&gt;warnings [] = &quot;mtas - {$type} - field '&quot; . $checkItem . &quot;' not found in any configuration&quot;;
                    }
                  }
                } else {
                  $this-&gt;errors [] = &quot;mtas - {$type} - unrecognized field type&quot;;
                }
              }
            }
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - {$type} - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - {$type} - field is obligatory&quot;;
        }
        if (! isset ( $object-&gt;query )) {
          $this-&gt;errors [] = &quot;mtas - {$type} - query is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - {$type} unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas page
   *
   * @param object $object
   * @return object
   */
  private function checkResponseMtasPage($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - page - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - page - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;prefix&quot; || $key == &quot;key&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - page - {$key} should be string&quot;;
          }
        } else if ($key == &quot;start&quot; || $key == &quot;end&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - page - {$key} should be integer&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - page - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - page - field is obligatory&quot;;
        }
        if (! isset ( $object-&gt;start )) {
          $this-&gt;errors [] = &quot;mtas - page - start is obligatory&quot;;
        }
        if (! isset ( $object-&gt;end )) {
          $this-&gt;errors [] = &quot;mtas - page - end is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - page - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas heatmap
   *
   * @param object $object
   * @return object
   */
  private function checkResponseMtasHeatmap($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;heatmapField&quot; || $key == &quot;queryField&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - heatmap - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - heatmap - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;queries&quot;) {
          if (! is_array ( $value ) || count ( $object-&gt;queries ) == 0) {
            $this-&gt;errors [] = &quot;mtas - heatmap - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasQuery ( $value [$i], &quot;mtas - heatmap - query - &quot; );
            }
          }          
        } else if ($key == &quot;key&quot; || $key == &quot;geom&quot; || $key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - heatmap - {$key} should be string&quot;;
          } 
        } else if ($key == &quot;gridLevel&quot; || $key == &quot;maxCells&quot;) {
          if (! is_numeric ( $value )) {
            $this-&gt;errors [] = &quot;mtas - heatmap - {$key} should be string&quot;;
          }
        } else if ($key == &quot;functions&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - heatmap - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkMtasStatsFunction ( $value [$i], &quot;mtas - heatmap - query - &quot; );
            }
          }
        } else if ($key == &quot;minimum&quot; || $key == &quot;maximum&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - heatmap - {$key} should be integer&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - heatmap - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;heatmapField )) {
          $this-&gt;errors [] = &quot;mtas - heatmap - heatmapField is obligatory&quot;;
        }
        if (! isset ( $object-&gt;queryField )) {
          $this-&gt;errors [] = &quot;mtas - heatmap - queryField is obligatory&quot;;
        }
        if (! isset ( $object-&gt;queries)) {
          $this-&gt;errors [] = &quot;mtas - heatmap - queryies is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - page - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas termvector
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasTermvector($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - termvector - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;prefix&quot; || $key == &quot;key&quot; || $key == &quot;type&quot; || $key == &quot;regexp&quot; || $key == &quot;ignoreRegexp&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be string&quot;;
          }
        } else if ($key == &quot;number&quot; || $key == &quot;start&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be integer&quot;;
          }
        } else if ($key == &quot;full&quot; || $key == &quot;listRegexp&quot; || $key == &quot;ignoreListRegexp&quot;) {
          if (! is_bool ( $value )) {
            $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be boolean&quot;;
          }
        } else if ($key == &quot;sort&quot;) {
          if (! is_object ( $value )) {
            $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be object&quot;;
          } else {
            foreach ( $value as $subKey =&gt; $subValue ) {
              if ($subKey == &quot;type&quot; || $subKey == &quot;direction&quot;) {
                if (! is_string ( $subValue )) {
                  $this-&gt;errors [] = &quot;mtas - termvector - {$key} - {$subKey} should be string&quot;;
                }
              } else {
                $this-&gt;warnings [] = &quot;mtas - termvector - {$key} - {$subKey} not expected&quot;;
              }
            }
          }
        } else if ($key == &quot;list&quot; || $key == &quot;ignoreList&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be non empty array of strings&quot;;
          } else {
            foreach ( $value as $subValue ) {
              if (! is_string ( $subValue )) {
                $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be array of only strings&quot;;
              }
            }
          }
        } else if ($key == &quot;functions&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $value [$i] = $this-&gt;checkResponseMtasFunction ( $value [$i], &quot;mtas - termvector - function - &quot; );
            }
          }
        } else if ($key == &quot;distances&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - termvector - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $value [$i] = $this-&gt;checkResponseMtasDistance ( $value [$i], &quot;mtas - termvector - distance - &quot; );
            }
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - termvector - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - termvector - field is obligatory&quot;;
        }
        if (! isset ( $object-&gt;prefix )) {
          $this-&gt;errors [] = &quot;mtas - termvector - prefix is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - termvector - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas facet
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasFacet($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - facet - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - facet - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;key&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - facet - {$key} should be string&quot;;
          }
        } else if ($key == &quot;queries&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - facet - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasQuery ( $value [$i], &quot;mtas - facet - {$key} - &quot; );
            }
          }
        } else if ($key == &quot;base&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - facet - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasBase ( $value [$i], &quot;mtas - facet - {$key} - &quot; );
            }
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - facet - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - facet - field is obligatory&quot;;
        }
        if (! isset ( $object-&gt;queries )) {
          $this-&gt;errors [] = &quot;mtas - facet - queries is obligatory&quot;;
        }
        if (! isset ( $object-&gt;base )) {
          $this-&gt;errors [] = &quot;mtas - facet - base is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - facet - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas group
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasGroup($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - group - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - group - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;key&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - group - {$key} should be string&quot;;
          }
        } else if ($key == &quot;number&quot; || $key == &quot;start&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = &quot;mtas - group - {$key} should be integer&quot;;
          }
        } else if ($key == &quot;query&quot;) {
          $object-&gt;{$key} = $this-&gt;checkResponseMtasQuery ( $value, &quot;mtas - group - {$key} - &quot; );
        } else if ($key == &quot;grouping&quot;) {
          if (! is_object ( $value )) {
            $this-&gt;errors [] = &quot;mtas - group - {$key} should be object&quot;;
          } else {
            $items = 0;
            foreach ( $value as $subKey =&gt; $subValue ) {
              if ($subKey == &quot;hit&quot;) {
                if (! is_object ( $subValue )) {
                  $this-&gt;warnings [] = &quot;mtas - group - {$key} - {$subKey} should be object&quot;;
                } else {
                  foreach ( $subValue as $subSubKey =&gt; $subSubValue ) {
                    if ($subSubKey == &quot;inside&quot;) {
                      if (! is_string ( $subSubValue )) {
                        $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} - {$subSubKey} should be string&quot;;
                      } else {
                        $items ++;
                      }
                    } else if ($subSubKey == &quot;insideLeft&quot; || $subSubKey == &quot;insideRight&quot; || $subSubKey == &quot;left&quot; || $subSubKey == &quot;right&quot;) {
                      if (! is_array ( $subSubValue )) {
                        $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} - {$subSubKey} should be non empty array&quot;;
                      } else {
                        for($i = 0; $i &lt; count ( $subSubValue ); $i ++) {
                          if (! is_object ( $subSubValue [$i] )) {
                            $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} - {$subSubKey}[{$i}] should be an object&quot;;
                          } else if (! isset ( $subSubValue [$i]-&gt;prefixes ) || ! is_string ( $subSubValue [$i]-&gt;prefixes )) {
                            $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} - {$subSubKey}[{$i}] - prefixes should be defined (as string)&quot;;
                          } else if (! isset ( $subSubValue [$i]-&gt;position ) || (! is_string ( $subSubValue [$i]-&gt;position ) &amp;&amp; ! is_int ( $subSubValue [$i]-&gt;position ))) {
                            $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} - {$subSubKey}[{$i}] - position should be defined (as string or integer)&quot;;
                          } else {
                            $items ++;
                          }
                        }
                      }
                    } else {
                      $this-&gt;warnings [] = &quot;mtas - group - {$key} - {$subKey} - {$subSubKey} not expected&quot;;
                    }
                  }
                }
              } else if ($subKey == &quot;left&quot; || $subKey == &quot;right&quot;) {
                if (! is_array ( $subValue )) {
                  $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} should be non empty array&quot;;
                } else {
                  for($i = 0; $i &lt; count ( $subValue ); $i ++) {
                    if (! is_object ( $subValue [$i] )) {
                      $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} [{$i}] should be an object&quot;;
                    } else if (! isset ( $subValue [$i]-&gt;prefixes ) || ! is_string ( $subValue [$i]-&gt;prefixes )) {
                      $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} [{$i}] - prefixes should be defined (as string)&quot;;
                    } else if (! isset ( $subValue [$i]-&gt;position ) || (! is_string ( $subValue [$i]-&gt;position ) &amp;&amp; ! is_int ( $subValue [$i]-&gt;position ))) {
                      $this-&gt;errors [] = &quot;mtas - group - {$key} - {$subKey} [{$i}] - position should be defined (as string or integer)&quot;;
                    } else {
                      $items ++;
                    }
                  }
                }
              } else {
                $this-&gt;warnings [] = &quot;mtas - group - {$key} - {$subKey} not expected&quot;;
              }
            }
            if (! $items) {
              $this-&gt;errors [] = &quot;mtas - group - {$key} - no (valid) groupings defined&quot;;
            }
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - group - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - group - field is obligatory&quot;;
        }
        if (! isset ( $object-&gt;query )) {
          $this-&gt;errors [] = &quot;mtas - group - query is obligatory&quot;;
        }
        if (! isset ( $object-&gt;grouping )) {
          $this-&gt;errors [] = &quot;mtas - group - grouping is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - group - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas prefix
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasPrefix($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - prefix - {$key} should be string&quot;;
          } else {
            $configurations = $this-&gt;getConfigurationsForField ( $value );
            if (count ( $configurations ) &gt; 0) {
              $this-&gt;__configurations [] = $configurations;
            } else {
              $this-&gt;errors [] = &quot;mtas - prefix - {$key} :  '&quot; . $value . &quot;' not found in any configuration&quot;;
            }
          }
        } else if ($key == &quot;key&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;mtas - prefix - {$key} should be string&quot;;
          }
        } else {
          $this-&gt;warnings [] = &quot;mtas - prefix - {$key} not expected&quot;;
        }
      }
      if (count ( $this-&gt;errors ) == 0) {
        if (! isset ( $object-&gt;field )) {
          $this-&gt;errors [] = &quot;mtas - prefix - field is obligatory&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;mtas - prefix - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas collection
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasCollection($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (isset ( $object-&gt;action ) &amp;&amp; is_string ( $object-&gt;action )) {
        if ($object-&gt;action == &quot;create&quot; || $object-&gt;action == &quot;post&quot; || $object-&gt;action == &quot;list&quot; || $object-&gt;action == &quot;check&quot; || $object-&gt;action == &quot;empty&quot; || $object-&gt;action == &quot;get&quot; || $object-&gt;action == &quot;import&quot; || $object-&gt;action == &quot;delete&quot;) {
          foreach ( $object as $key =&gt; $value ) {
            if ($key == &quot;action&quot;) {
              // ignore
            } else if ($key == &quot;key&quot;) {
              if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;mtas - collection - {$key} should be string&quot;;
              }
            } else if ($key == &quot;field&quot;) {
              if ($object-&gt;action != &quot;create&quot;) {
                $this-&gt;warnings [] = &quot;mtas - collection - {$key} not expected for &quot; . $object-&gt;action;
              } else if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;mtas - collection - {$key} should be string&quot;;
              } else {
                $fields = explode ( &quot;,&quot;, $value );
                foreach ( $fields as $field ) {
                  $configurations = $this-&gt;getConfigurationsForField ( $field );
                  if (count ( $configurations ) &gt; 0) {
                    $this-&gt;__configurations [] = $configurations;
                  } else {
                    $this-&gt;errors [] = &quot;mtas - collection - {$key} :  '&quot; . $field . &quot;' not found in any configuration&quot;;
                  }
                }
              }
            } else if ($key == &quot;post&quot;) {
              if ($object-&gt;action != &quot;post&quot;) {
                $this-&gt;warnings [] = &quot;mtas - collection - {$key} not expected for &quot; . $object-&gt;action;
              } else if (! is_array ( $value ) || count ( $value ) == 0) {
                $this-&gt;errors [] = &quot;mtas - collection - {$key} should be array of strings or integers&quot;;
              } else {
                foreach ( $value as $valueItem ) {
                  if (! is_string ( $valueItem ) &amp;&amp; ! is_int ( $valueItem )) {
                    $this-&gt;errors [] = &quot;mtas - collection - {$key} should be array of strings or integers&quot;;
                  }
                }
              }
            } else if ($key == &quot;id&quot;) {
              if ($object-&gt;action != &quot;create&quot; &amp;&amp; $object-&gt;action != &quot;post&quot; &amp;&amp; $object-&gt;action != &quot;delete&quot; &amp;&amp; $object-&gt;action != &quot;check&quot; &amp;&amp; $object-&gt;action != &quot;import&quot; &amp;&amp; $object-&gt;action != &quot;get&quot;) {
                $this-&gt;warnings [] = &quot;mtas - collection - {$key} not expected for &quot; . $object-&gt;action;
              } else if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;mtas - collection - {$key} should be string&quot;;
              }
            } else if ($key == &quot;configuration&quot; || $key == &quot;collection&quot; || $key == &quot;url&quot;) {
              if ($object-&gt;action != &quot;import&quot;) {
                $this-&gt;warnings [] = &quot;mtas - collection - {$key} not expected for &quot; . $object-&gt;action;
              } else if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;mtas - collection - {$key} should be string&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;mtas - collection - {$key} not expected&quot;;
            }
          }
          if ($object-&gt;action == &quot;create&quot;) {
            if (! isset ( $object-&gt;field )) {
              $this-&gt;errors [] = &quot;mtas - collection - field is obligatory for action {$object-&gt;action}&quot;;
            }
          } else if ($object-&gt;action == &quot;post&quot;) {
            if (! isset ( $object-&gt;post )) {
              $this-&gt;errors [] = &quot;mtas - collection - post is obligatory for action {$object-&gt;action}&quot;;
            }
          } else if ($object-&gt;action == &quot;get&quot; || $object-&gt;action == &quot;delete&quot; || $object-&gt;action == &quot;check&quot;) {
            if (! isset ( $object-&gt;id )) {
              $this-&gt;errors [] = &quot;mtas - collection - id is obligatory for action {$object-&gt;action}&quot;;
            }
          }
          return $object;
        } else {
          $this-&gt;errors [] = &quot;mtas - collection - no (valid) action provided&quot;;
        }
      } else {
        $this-&gt;errors [] = &quot;mtas - collection - no (valid) action provided&quot;;
        return null;
      }
    } else {
      $this-&gt;warnings [] = &quot;mtas - collection - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas collection
   *
   * @param object $object          
   * @return object
   */
  private function checkResponseMtasVersion($object) {
    return $object;
  }
  /**
   * Check query mtas
   *
   * @param object $object          
   * @param string $prefix          
   * @return object
   */
  private function checkResponseMtasQuery($object, $prefix) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;type&quot; || $key == &quot;value&quot; || $key == &quot;prefix&quot; || $key == &quot;ignore&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be string&quot;;
          }
        } else if ($key == &quot;maximumIgnoreLength&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be integer&quot;;
          }
        } else if ($key == &quot;variables&quot;) {
          $object-&gt;{$key} = $this-&gt;checkVariables ( $value, false, $prefix );
        } else {
          $this-&gt;warnings [] = $prefix . &quot;{$key} not expected&quot;;
        }
      }
      if (! isset ( $object-&gt;type )) {
        $this-&gt;errors [] = $prefix . &quot;type is obligatory&quot;;
      } else if($object-&gt;type==&quot;simple&quot;) {
        if (! isset ( $object-&gt;prefix )) {
          $this-&gt;errors [] = $prefix . &quot;prefix is obligatory for type &quot;.$object-&gt;type;
        }
      }
      if (! isset ( $object-&gt;value )) {
        $this-&gt;errors [] = $prefix . &quot;value is obligatory&quot;;
      }
      return $object;
    } else {
      $this-&gt;warnings [] = $prefix . &quot;unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas base (facets)
   *
   * @param object $object          
   * @param string $prefix          
   * @return object
   */
  private function checkResponseMtasBase($object, $prefix) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;field&quot; || $key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be string&quot;;
          }
        } else if ($key == &quot;number&quot; || $key == &quot;maximum&quot; || $key == &quot;minimum&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be integer&quot;;
          }
        } else if ($key == &quot;sort&quot;) {
          if (! is_object ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be object&quot;;
          } else {
            foreach ( $value as $subKey =&gt; $subValue ) {
              if ($subKey == &quot;type&quot; || $subKey == &quot;direction&quot;) {
                if (! is_string ( $subValue )) {
                  $this-&gt;errors [] = $prefix . &quot;{$key} - {$subKey} should be string&quot;;
                }
              } else {
                $this-&gt;warnings [] = $prefix . &quot;{$key} - {$subkey} not expected&quot;;
              }
            }
          }
        } else if ($key == &quot;range&quot;) {
          if (! is_object ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be object&quot;;
          } else {
            foreach ( $value as $subKey =&gt; $subValue ) {
              if ($subKey == &quot;size&quot; || $subKey == &quot;base&quot;) {
                if (! is_int ( $subValue )) {
                  $this-&gt;errors [] = $prefix . &quot;{$key} - {$subKey} should be integer&quot;;
                }
              } else {
                $this-&gt;warnings [] = $prefix . &quot;{$key} - {$subkey} not expected&quot;;
              }
            }
          }
        } else if ($key == &quot;functions&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = &quot;mtas - facet - {$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkResponseMtasFunction ( $value [$i], &quot;mtas - facet - {$key} - &quot; );
            }
          }
        } else {
          $this-&gt;warnings [] = $prefix . &quot;{$key} not expected&quot;;
        }
      }
      if (! isset ( $object-&gt;field )) {
        $this-&gt;errors [] = $prefix . &quot;value is obligatory&quot;;
      }
      return $object;
    } else {
      $this-&gt;warnings [] = $prefix . &quot;unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas function
   *
   * @param object $object          
   * @param string $prefix          
   * @return object
   */
  private function checkResponseMtasFunction($object, $prefix) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;expression&quot; || $key == &quot;key&quot; || $key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be string&quot;;
          }
        } else {
          $this-&gt;warnings [] = $prefix . &quot;{$key} not expected&quot;;
        }
      }
      if (! isset ( $object-&gt;expression )) {
        $this-&gt;errors [] = $prefix . &quot;expression is obligatory&quot;;
      }
      return $object;
    } else {
      $this-&gt;warnings [] = $prefix . &quot;unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas distance
   *
   * @param object $object          
   * @param string $prefix          
   * @return object
   */
  private function checkResponseMtasDistance($object, $prefix) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;type&quot; || $key == &quot;key&quot; || $key == &quot;base&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be string&quot;;
          }
        } else if ($key == &quot;minimum&quot; || $key == &quot;maximum&quot;) {
          if (! is_numeric ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be numeric&quot;;
          }
        } else if ($key == &quot;parameter&quot;) {
          if (! is_object ( $value )) {
            $this-&gt;errors [] = $prefix . &quot;{$key} should be an object&quot;;
          } else {
            foreach ( $value as $subKey =&gt; $subValue ) {
              if (! preg_match ( &quot;/^[a-z0-9]+$/i&quot;, $subKey )) {
                $this-&gt;errors [] = $prefix . &quot;parameter - {$subKey} not allowed&quot;;
              } else if (! is_string ( $subValue ) &amp;&amp; ! is_numeric ( $subValue )) {
                $this-&gt;errors [] = $prefix . &quot;parameter - {$subKey} should be string or numeric&quot;;
              }
            }
          }
        } else {
          $this-&gt;warnings [] = $prefix . &quot;{$key} not expected&quot;;
        }
      }
      if (! isset ( $object-&gt;type )) {
        $this-&gt;errors [] = $prefix . &quot;type is obligatory&quot;;
      }
      if (! isset ( $object-&gt;base )) {
        $this-&gt;errors [] = $prefix . &quot;base is obligatory&quot;;
      }
      return $object;
    } else {
      $this-&gt;warnings [] = $prefix . &quot;unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check condition
   *
   * @param object $object          
   * @return object
   */
  private function checkCondition($object) {
    static $availableTypes = array (
        &quot;and&quot;,
        &quot;or&quot;,
        &quot;collection&quot;,
        &quot;equals&quot;,
        &quot;phrase&quot;,
        &quot;wildcard&quot;,
        &quot;regexp&quot;,
        &quot;cql&quot;,
        &quot;simple&quot;,
        &quot;geojson&quot;,
        &quot;range&quot;,
        &quot;join&quot; 
    );
    static $basicTypes = array (
        &quot;equals&quot;,
        &quot;phrase&quot;,
        &quot;wildcard&quot;,
        &quot;regexp&quot;,
        &quot;cql&quot;,
        &quot;simple&quot;,
        &quot;range&quot;,
        &quot;geojson&quot;
    );
    static $valueTypes = array (
        &quot;equals&quot;,
        &quot;phrase&quot;,
        &quot;wildcard&quot;,
        &quot;regexp&quot;,
        &quot;cql&quot;,
        &quot;simple&quot;
    );
    if ($object &amp;&amp; is_object ( $object )) {
      $keys = array ();
      // first checks key/values
      foreach ( $object as $key =&gt; $value ) {
        $keys [] = $key;
        if ($key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = &quot;condition - {$key} should be string&quot;;
          } else if (! in_array ( $value, $availableTypes )) {
            $this-&gt;errors [] = &quot;condition - unknown {$key} '&quot; . $value . &quot;'&quot;;
          }
        } else if (isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type )) {
          if ($key == &quot;field&quot;) {
            if (in_array ( $object-&gt;type, $basicTypes )) {
              if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be string&quot;;
              } else {
                $configurations = $this-&gt;getConfigurationsForField ( $value );
                if (count ( $configurations ) &gt; 0) {
                  $this-&gt;__configurations [] = $configurations;
                } else {
                  $this-&gt;errors [] = &quot;condition - {$key} '&quot; . $value . &quot;' not found in any configuration&quot;;
                }
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;value&quot;) {
            if (in_array ( $object-&gt;type, $valueTypes )) {
              if (is_array ( $value )) {
                if (count ( $value ) == 0) {
                  $this-&gt;errors [] = &quot;condition - array {$key} should not be empty&quot;;
                }
                foreach ( $value as $valueItem ) {
                  if (! is_string ( $valueItem ) &amp;&amp; ! (is_bool ( $value ) &amp;&amp; $object-&gt;type == &quot;equals&quot;)) {
                    $this-&gt;errors [] = &quot;condition - item in array {$key} should be string&quot; . (($object-&gt;type == &quot;equals&quot;) ? &quot; or boolean&quot; : &quot;&quot;);
                    break;
                  }
                }
              } else if (! is_string ( $value ) &amp;&amp; ! (is_bool ( $value ) &amp;&amp; $object-&gt;type == &quot;equals&quot;)) {
                $this-&gt;errors [] = &quot;condition - {$key} should be string&quot; . (($object-&gt;type == &quot;equals&quot;) ? &quot; or boolean&quot; : &quot;&quot;) . &quot;, or list of them&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;not&quot; || $key == &quot;facetquery&quot;) {
            if (in_array ( $object-&gt;type, $basicTypes )) {
              if (! is_bool ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be boolean&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;expansion&quot;) {
            if ($object-&gt;type == &quot;equals&quot; || $object-&gt;type == &quot;phrase&quot;) {
              if (! is_object ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be an object&quot;;
              } else if (! isset ( $value-&gt;type )) {
                $this-&gt;errors [] = &quot;condition - {$key} should have a type defined&quot;;
              } else if (! is_string ( $value-&gt;type )) {
                $this-&gt;errors [] = &quot;condition - {$key} - type should be a string&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;start&quot; || $key == &quot;end&quot;) {
            if ($object-&gt;type == &quot;range&quot;) {
              if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be string&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;geometry&quot;) {
            if ($object-&gt;type == &quot;geojson&quot;) {
              if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be string&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;predicate&quot;) {
            if ($object-&gt;type == &quot;geojson&quot;) {
              if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be string&quot;;
              } else if(!in_array($value, array(&quot;intersects&quot;, &quot;iswithin&quot;, &quot;contains&quot;, &quot;isdisjointto&quot;))) {
                $this-&gt;errors [] = &quot;condition - {$key} cannot be &quot;.$value;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;list&quot;) {
            if ($object-&gt;type == &quot;and&quot; || $object-&gt;type == &quot;or&quot;) {
              if (is_array ( $value )) {
                if (count ( $value ) == 0) {
                  $this-&gt;errors [] = &quot;condition - list should not be empty&quot;;
                } else {
                  $newvalue = array ();
                  for($i = 0; $i &lt; count ( $value ); $i ++) {
                    $newvalue [$i] = $this-&gt;checkCondition ( $value [$i] );                    
                    if (! $newvalue [$i] || ! is_object ( $newvalue [$i] )) {
                      $this-&gt;errors [] = &quot;condition - could not check condition from {$object-&gt;type} list&quot;;
                    }
                  }
                  $object-&gt;{$key} = $newvalue;
                }
              } else {
                $this-&gt;errors [] = &quot;condition - {$key} should be array&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;ignore&quot; || $key == &quot;prefix&quot;) {
            if ($object-&gt;type == &quot;cql&quot; || $object-&gt;type == &quot;simple&quot;) {
              if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be string&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;maximumIgnoreLength&quot;) {
            if ($object-&gt;type == &quot;cql&quot; || $object-&gt;type == &quot;simple&quot;) {
              if (! is_int ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be integer&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;variables&quot;) {
            if ($object-&gt;type == &quot;cql&quot;) {
              if (! is_object ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be an object&quot;;
              } else {
                $object-&gt;{$key} = $this-&gt;checkVariables ( $value, true, &quot;condition - &quot; );
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;from&quot; || $key == &quot;to&quot;) {
            if ($object-&gt;type == &quot;join&quot;) {
              if (! is_string ( $value ) &amp;&amp; (!is_array($value) || count($value)==0)) {
                $this-&gt;errors [] = &quot;condition - {$key} should be a string or non-empty array of strings&quot;;
              } else {
                if(is_array($value)) {
                  foreach($value AS $valueItem) {
                    if (! is_string ( $valueItem )) {
                      $this-&gt;errors [] = &quot;condition - {$key} should be a string or array of strings&quot;;
                    }
                  }
                }
                if ($key == &quot;to&quot;) {
                  if(is_array($value) &amp;&amp; count($this-&gt;errors)==0) {
                    foreach($value AS $valueItem) {
                      $configurations = $this-&gt;getConfigurationsForField ( $valueItem );
                      if (count ( $configurations ) &gt; 0) {
                        $this-&gt;__configurations [] = $configurations;
                      } else {
                        $this-&gt;errors [] = &quot;condition - {$key} '&quot; . $valueItem . &quot;' not found in any configuration&quot;;
                      }
                    }
                  } else if(is_string($value)) {
                    $configurations = $this-&gt;getConfigurationsForField ( $value );
                    if (count ( $configurations ) &gt; 0) {
                      $this-&gt;__configurations [] = $configurations;
                    } else {
                      $this-&gt;errors [] = &quot;condition - {$key} '&quot; . $value . &quot;' not found in any configuration&quot;;
                    }
                  }
                }
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;configuration&quot;) {
            if ($object-&gt;type == &quot;join&quot;) {
              if (! is_string ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be a string&quot;;
              } 
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;condition&quot; || $key == &quot;filter&quot;) {
            if ($object-&gt;type == &quot;join&quot;) {
              if (! is_object ( $value )) {
                $this-&gt;errors [] = &quot;condition - {$key} should be an object&quot;;
              }
            } else {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected for type '{$object-&gt;type}'&quot;;
            }
          } else if ($key == &quot;key&quot;) {
            if (! isset ( $object-&gt;facetquery ) || ! $object-&gt;facetquery) {
              $this-&gt;warnings [] = &quot;condition - {$key} not expected without 'facetquery'&quot;;
            }
          } else {
            $this-&gt;warnings [] = &quot;condition - {$key} not expected&quot;;
          }
        }
      }
      // check obligatory keys
      if (! in_array ( &quot;type&quot;, $keys )) {
        $this-&gt;errors [] = &quot;condition - no type defined&quot;;
      } else {
        if (in_array ( $object-&gt;type, $basicTypes ) &amp;&amp; ! in_array ( &quot;field&quot;, $keys )) {
          $this-&gt;errors [] = &quot;condition - no field defined&quot;;
        }
        if (in_array ( $object-&gt;type, $valueTypes ) &amp;&amp; ! in_array ( &quot;value&quot;, $keys )) {
          $this-&gt;errors [] = &quot;condition - no value defined&quot;;
        }
        if ($object-&gt;type == &quot;and&quot; || $object-&gt;type == &quot;or&quot;) {
          if (! in_array ( &quot;list&quot;, $keys )) {
            $this-&gt;errors [] = &quot;condition - no list defined&quot;;
          }
        } else if ($object-&gt;type == &quot;geojson&quot;) {
          if (! in_array ( &quot;predicate&quot;, $keys )) {
            $this-&gt;errors [] = &quot;condition - no predicate defined&quot;;
          }
          if (! in_array ( &quot;geometry&quot;, $keys )) {
            $this-&gt;errors [] = &quot;condition - no geometry defined&quot;;
          }
        } else if ($object-&gt;type == &quot;collection&quot;) {
          if (! in_array ( &quot;url&quot;, $keys )) {
            $this-&gt;errors [] = &quot;condition - no url defined&quot;;
          }
          if (! in_array ( &quot;id&quot;, $keys )) {
            $this-&gt;errors [] = &quot;condition - no id defined&quot;;
          }
        } else if ($object-&gt;type == &quot;join&quot;) {
          if (! in_array ( &quot;from&quot;, $keys )) {
            $this-&gt;errors [] = &quot;condition - no from defined&quot;;
          }
          if (! in_array ( &quot;to&quot;, $keys )) {
            $this-&gt;errors [] = &quot;condition - no to defined&quot;;
          }
        } else if ($object-&gt;type == &quot;simple&quot;) {
          if (! in_array ( &quot;prefix&quot;, $keys )) {
            $this-&gt;errors [] = &quot;condition - no prefix defined&quot;;
          }
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;condition - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check page
   *
   * @param object $object
   * @param string $prefix          
   * * @return object
   */
  private function checkPage($object, $prefix) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;start&quot; || $key == &quot;end&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;warnings [] = $prefix.&quot;page - '{$key}' should be an integer&quot;;
          }
        } else {
          $this-&gt;warnings [] = $prefix.&quot;page - key '{$key}' not expected&quot;;
        }
      }
      if (! isset ( $object-&gt;start )) {
        $this-&gt;errors [] = $prefix.&quot;page - no start defined&quot;;
      }
      if (! isset ( $object-&gt;end )) {
        $this-&gt;errors [] = $prefix.&quot;page - no end defined&quot;;
      }
      return $object;
    } else {
      $this-&gt;warnings [] = $prefix.&quot;page - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check filter
   *
   * @param object $object          
   * @return object
   */
  private function checkFilter($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;tag&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;warnings [] = &quot;filter - tag should be a string&quot;;
          }
        } else if ($key == &quot;condition&quot;) {
          $this-&gt;checkCondition ( $value );
        } else {
          $this-&gt;warnings [] = &quot;filter - key '{$key}' not expected&quot;;
        }
      }
      if (! isset ( $object-&gt;condition )) {
        $this-&gt;errors [] = &quot;filter - no condition&quot;;
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;filter - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check filters
   *
   * @param object $object          
   * @return object
   */
  private function checkFilters($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      return $this-&gt;checkFilter ( $object );
    } else if ($object &amp;&amp; is_array ( $object ) &amp;&amp; count ( $object ) &gt; 0) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        $object [$i] = $this-&gt;checkFilter ( $object [$i] );
      }
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;filter - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check variables
   *
   * @param object $object          
   * @param object $fromCondition          
   * @param string $prefixMessage          
   * @return object
   */
  private function checkVariables($object, $fromCondition, $prefixMessage = &quot;&quot;) {
    if ($object &amp;&amp; is_object ( $object )) {
      $variables = array ();
      $stats = null;
      foreach ( $object as $subkey =&gt; $subvalue ) {
        if ($subkey == &quot;definitions&quot;) {
          if (! is_array ( $subvalue )) {
            $this-&gt;errors [] = $prefixMessage . &quot;definitions in variables should be an array&quot;;
          } else {
            foreach ( $subvalue as $subitem ) {
              if ($subitem &amp;&amp; is_object ( $subitem )) {
                foreach ( $subitem as $subsubitem =&gt; $subsubvalue ) {
                  if ($subsubitem == &quot;name&quot;) {
                    if (! is_string ( $subsubvalue )) {
                      $this-&gt;errors [] = $prefixMessage . &quot;name in definition for variables should be a string&quot;;
                    } else if (! preg_match ( &quot;/^[a-z0-9]+$/i&quot;, $subsubvalue )) {
                      $this-&gt;errors [] = $prefixMessage . &quot;name '&quot; . $subsubvalue . &quot;' in definition for variables not valid&quot;;
                    }
                  } else if ($subsubitem == &quot;value&quot;) {
                    if (! is_string ( $subsubvalue )) {
                      $this-&gt;errors [] = $prefixMessage . &quot;value in definition for variables should be a string&quot;;
                    }
                  } else if ($subsubitem == &quot;expansion&quot;) {
                    if (! is_object ( $subsubvalue )) {
                      $this-&gt;errors [] = $prefixMessage . &quot;expansion in definition for variables should be an object&quot;;
                    }
                  } else {
                    $this-&gt;warnings [] = $prefixMessage . &quot;unexpected &quot; . $subsubitem . &quot; in definition for variables&quot;;
                  }
                }
                if (! isset ( $subitem-&gt;name )) {
                  $this-&gt;errors [] = $prefixMessage . &quot;no name defined in definition for variables&quot;;
                  $name = null;
                } else {
                  $name = $subitem-&gt;name;
                }
                if (! isset ( $subitem-&gt;value )) {
                  $this-&gt;errors [] = $prefixMessage . &quot;no value defined in definition for variables&quot;;
                  $value = null;
                } else {
                  $value = $subitem-&gt;value;
                }
                if (! isset ( $subitem-&gt;expansion )) {
                  $this-&gt;errors [] = $prefixMessage . &quot;no expansion defined in definition for variables&quot;;
                  $expansion = null;
                } else {
                  $expansion = $subitem-&gt;expansion;
                }
                if ($name != null &amp;&amp; $value != null &amp;&amp; $expansion != null) {
                  if (isset ( $variables [$name] )) {
                    $this-&gt;errors [] = $prefixMessage . &quot;variable '&quot; . $name . &quot;' in definition for variables already defined&quot;;
                  } else {
                    $variables [$name] = $this-&gt;computeExpansionValues ( $value, $expansion, $prefixMessage );
                  }
                }
              } else {
                $this-&gt;errors [] = $prefixMessage . &quot;definition for variables should be an object&quot;;
              }
            }
          }
        } else if ($subkey == &quot;stats&quot;) {
          if (! is_object ( $subvalue )) {
            $this-&gt;errors [] = $prefixMessage . &quot;stats in variables should be object&quot;;
          } else {
            $object-&gt;{$subkey} = $this-&gt;checkMtasStats ( $subvalue, $prefixMessage );
            if ($object-&gt;{$subkey} &amp;&amp; count ( $this-&gt;errors ) == 0) {
              $stats = new \stdClass ();
              if (isset ( $object-&gt;{$subkey}-&gt;key )) {
                $stats-&gt;key = $object-&gt;{$subkey}-&gt;key;
              }
              if (isset ( $object-&gt;{$subkey}-&gt;type )) {
                $stats-&gt;type = $object-&gt;{$subkey}-&gt;type;
              }
              if (isset ( $object-&gt;{$subkey}-&gt;minimum )) {
                $stats-&gt;minimum = $object-&gt;{$subkey}-&gt;minimum;
              }
              if (isset ( $object-&gt;{$subkey}-&gt;maximum )) {
                $stats-&gt;maximum = $object-&gt;{$subkey}-&gt;maximum;
              }
              if (isset ( $object-&gt;{$subkey}-&gt;functions )) {
                $stats-&gt;functions = array ();
                for($i = 0; $i &lt; count ( $object-&gt;{$subkey}-&gt;functions ); $i ++) {
                  $stats-&gt;functions [$i] = clone $object-&gt;{$subkey}-&gt;functions [$i];
                }
              }
            }
          }
        } else {
          $this-&gt;warnings [] = $prefixMessage . $subkey . &quot; not expected in variables&quot;;
        }
      }
      $object-&gt;__stats = array ();
      $object-&gt;__variables = $variables;
      if ($stats) {
        if ($fromCondition) {
          $statsItem = clone $stats;
          $statsItem-&gt;__variables = $variables;
          $object-&gt;__stats [] = $statsItem;
        }
        $variableCombinations = $this-&gt;createVariableCombinations ( $variables, array () );
        foreach ( $variableCombinations as $variableCombination ) {
          $statsItem = clone $stats;
          $itemKeyList = array ();
          foreach ( $variableCombination as $combinationKey =&gt; $combinationValue ) {
            $itemKeyList [] = $combinationKey . &quot;:&quot; . implode ( &quot;,&quot;, $combinationValue );
          }
          if (isset ( $statsItem-&gt;key )) {
            $statsItem-&gt;key .= &quot; - &quot; . implode ( &quot;,&quot;, $itemKeyList );
          } else {
            $statsItem-&gt;key = implode ( &quot;,&quot;, $itemKeyList );
          }
          $statsItem-&gt;__variables = $variableCombination;
          $object-&gt;__stats [] = $statsItem;
        }
      }
      return $object;
    } else {
      $this-&gt;errors [] = $prefixMessage . &quot;variables should be an object&quot;;
      return null;
    }
  }
  /**
   * Check mtas stats
   *
   * @param object $object          
   * @param string $prefixMessage          
   * @return object
   */
  private function checkMtasStats($object, $prefixMessage = &quot;&quot;) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;key&quot; || $key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = $prefixMessage . &quot;{$key} should be string&quot;;
          }
        } else if ($key == &quot;functions&quot;) {
          if (! is_array ( $value )) {
            $this-&gt;errors [] = $prefixMessage . &quot;{$key} should be array&quot;;
          } else {
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;checkMtasStatsFunction ( $value [$i] );
            }
          }
        } else if ($key == &quot;minimum&quot; || $key == &quot;maximum&quot;) {
          if (! is_int ( $value )) {
            $this-&gt;errors [] = $prefixMessage . &quot;{$key} should be integer&quot;;
          }
        } else {
          $this-&gt;warnings [] = $prefixMessage . &quot;{$key} not expected&quot;;
        }
      }
      return $object;
    } else {
      $this-&gt;warnings [] = $prefixMessage . &quot;unexpected type&quot;;
      return null;
    }
  }
  /**
   * Check mtas stats functions
   *
   * @param object $object          
   * @param string $prefixMessage          
   * @return object
   */
  private function checkMtasStatsFunction($object, $prefixMessage = &quot;&quot;) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;key&quot; || $key == &quot;expression&quot; || $key == &quot;type&quot;) {
          if (! is_string ( $value )) {
            $this-&gt;errors [] = $prefixMessage . &quot;{$key} should be string&quot;;
          }
        } else {
          $this-&gt;warnings [] = $prefixMessage . &quot;{$key} not expected&quot;;
        }
      }
      if (! isset ( $object-&gt;expression )) {
        $this-&gt;errors [] = $prefixMessage . &quot;expression is obligatory&quot;;
      }
      return $object;
    } else {
      $this-&gt;warnings [] = $prefixMessage . &quot;unexpected type&quot;;
      return null;
    }
  }
  /**
   * Parse cache
   *
   * @param object $object          
   * @return null
   */
  private function parseCache($object) {
    return null;
  }
  /**
   * Parse timeAllowed
   *
   * @param object $object          
   * @return null
   */
  private function parseTimeAllowed($object) {
    if ($object &amp;&amp; is_numeric ( $object )) {
      return &quot;timeAllowed=&quot; . urlencode ( $object );
    }
    return null;
  }
  /**
   * Parse debug
   *
   * @param object $object          
   * @return string|NULL
   */
  private function parseDebug($object) {
    if ($object &amp;&amp; is_string ( $object )) {
      return &quot;debug=&quot; . urlencode ( $object );
    }
    return null;
  }
  /**
   * parse Sort
   *
   * @param object $object          
   * @return string|NULL
   */
  private function parseSort($object) {
    if ($object &amp;&amp; is_array ( $object )) {
      $sortList = array ();
      foreach ( $object as $sortItem ) {
        if (isset ( $sortItem-&gt;direction ) &amp;&amp; ($sortItem-&gt;direction == &quot;asc&quot;)) {
          $sortList [] = $sortItem-&gt;field . &quot; ASC&quot;;
        } else if (isset ( $sortItem-&gt;direction ) &amp;&amp; ($sortItem-&gt;direction == &quot;desc&quot;)) {
          $sortList [] = $sortItem-&gt;field . &quot; DESC&quot;;
        } else if ($sortItem-&gt;field == &quot;sort&quot;) {
          $sortList [] = $sortItem-&gt;field . &quot; DESC&quot;;
        } else {
          $sortList [] = $sortItem-&gt;field . &quot; ASC&quot;;
        }
      }
      if (count ( $sortList ) &gt; 0) {
        return &quot;sort=&quot; . urlencode ( implode ( &quot;,&quot;, $sortList ) );
      }
    }
    return null;
  }
  /**
   * Parse response
   *
   * @param object $object          
   * @param array $facetQueries          
   * @param array $mtasStats          
   * @return object
   */
  private function parseResponse($object, $facetQueries, $mtasStats) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      $requestAdditionalList = array ();
      if (! isset ( $object-&gt;documents )) {
        $requestList [] = &quot;rows=0&quot;;
      } else {
        $object-&gt;documents = $this-&gt;parseResponseDocuments ( $object-&gt;documents );
        if ($object-&gt;documents != null &amp;&amp; isset ( $object-&gt;documents-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object-&gt;documents-&gt;__requestList );
        }
      }
      if (isset ( $object-&gt;facets ) || count ( $facetQueries ) &gt; 0) {
        if (! isset ( $object-&gt;facets )) {
          $object-&gt;facets = new \stdClass ();
        }
        $object-&gt;facets = $this-&gt;parseResponseFacets ( $object-&gt;facets, $facetQueries );
        if ($object-&gt;facets != null &amp;&amp; isset ( $object-&gt;facets-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object-&gt;facets-&gt;__requestList );
        }
      }
      if (isset ( $object-&gt;stats )) {
        $object-&gt;stats = $this-&gt;parseResponseStats ( $object-&gt;stats );
        if ($object-&gt;stats != null &amp;&amp; isset ( $object-&gt;stats-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object-&gt;stats-&gt;__requestList );
        }
      }
      if (isset ( $object-&gt;mtas ) || count ( $mtasStats ) &gt; 0 || $this-&gt;statusKey != null) {
        if(isset ( $object-&gt;mtas ) || count ( $mtasStats ) &gt; 0) {
          if(!isset ( $object-&gt;mtas )) {
            $object-&gt;mtas = new \stdClass();
          }
          $object-&gt;mtas = $this-&gt;parseResponseMtas ( $object-&gt;mtas, $mtasStats);
        } else {
          $object-&gt;mtas = $this-&gt;parseResponseMtas ( null, $mtasStats);          
        }
        if ($object-&gt;mtas != null) {
          if (isset ( $object-&gt;mtas-&gt;__requestList )) {
            $requestList = array_merge ( $requestList, $object-&gt;mtas-&gt;__requestList );
          }
          if (isset ( $object-&gt;mtas-&gt;__requestAdditionalList )) {
            $requestAdditionalList = array_merge ( $requestAdditionalList, $object-&gt;mtas-&gt;__requestAdditionalList );
          }
        }
      }
      $object-&gt;__requestList = $requestList;
      $object-&gt;__requestAdditionalList = $requestAdditionalList;
      return $object;
    } else if ($this-&gt;statusKey != null) {
      $object = new \stdClass ();
      $object-&gt;mtas = new \stdClass ();
      $object-&gt;mtas = $this-&gt;parseResponseMtas ( $object-&gt;mtas, $mtasStats);
      if ($object-&gt;mtas != null) {
        if (isset ( $object-&gt;mtas-&gt;__requestList )) {
          $object-&gt;__requestList = $object-&gt;mtas-&gt;__requestList;
        }
        if (isset ( $object-&gt;mtas-&gt;__requestAdditionalList )) {
          $object-&gt;__requestAdditionalList = $object-&gt;mtas-&gt;__requestAdditionalList;
        }        
      }
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse documents in response
   *
   * @param object $object          
   * @return object
   */
  private function parseResponseDocuments($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;fields&quot;) {
          $fields = array ();
          foreach ( $value as $fieldItem ) {
            if (is_string ( $fieldItem )) {
              $fields [] = $fieldItem;
            } else if (is_object ( $fieldItem ) &amp;&amp; isset ( $fieldItem-&gt;type ) &amp;&amp; is_string ( $fieldItem-&gt;type )) {
              if ($fieldItem-&gt;type == &quot;join&quot;) {
                $fields [] = $fieldItem-&gt;from;
                $object-&gt;{$key} = $this-&gt;parseResponseDocumentsJoin ( $fieldItem );
              }
            }
          }
          $requestList [] = &quot;fl=&quot; . urlencode ( implode ( &quot;,&quot;, array_unique ( $fields ) ) );
        } else if ($key == &quot;start&quot;) {
          $requestList [] = &quot;start=&quot; . $value;
        } else if ($key == &quot;rows&quot;) {
          $requestList [] = &quot;rows=&quot; . $value;
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse join in documents
   *
   * @param object $object          
   * @return object
   */
  private function parseResponseDocumentsJoin($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (! isset ( $this-&gt;responseJoins-&gt;documents )) {
        $this-&gt;responseJoins-&gt;documents = array ();
      }
      $responseJoinItem = new \stdClass ();
      $responseJoinItem-&gt;to = $object-&gt;to;
      $responseJoinItem-&gt;from = $object-&gt;from;
      $responseJoinItem-&gt;fields = $object-&gt;fields;
      $responseJoinItem-&gt;name = $object-&gt;name;
      $responseJoinItem-&gt;configuration = isset ( $object-&gt;configuration ) ? $object-&gt;configuration : $this-&gt;solrConfiguration;
      if (isset ( $object-&gt;condition ) &amp;&amp; is_object ( $object-&gt;condition )) {
        $responseJoinItem-&gt;condition = clone $object-&gt;condition;
      }
      if (isset ( $object-&gt;filter ) &amp;&amp; is_object ( $object-&gt;filter )) {
        $responseJoinItem-&gt;filter = clone $object-&gt;filter;
      }
      $this-&gt;responseJoins-&gt;documents [] = $responseJoinItem;
    }
    return $object;
  }
  /**
   * Parse facets in response
   *
   * @param object $object          
   * @param object $facetqueries          
   * @return object
   */
  private function parseResponseFacets($object, $facetqueries) {
    if (($object &amp;&amp; is_object ( $object ))) {
      $requestList = array ();
      $requestList [] = &quot;facet=true&quot;;
      $keyListFacetQueries = array ();
      // create defined facetqueries
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;facetfields&quot;) {
          $requestList = $this-&gt;parseResponseFacetFields ( $value, $requestList );
        } else if ($key == &quot;facetqueries&quot;) {
          list ( $requestList, $keyListFacetQueries ) = $this-&gt;parseResponseFacetQueries ( $value, $requestList, $keyListFacetQueries );
        } else if ($key == &quot;facetranges&quot;) {
          $requestList = $this-&gt;parseResponseFacetRanges ( $value, $requestList );
        } else if ($key == &quot;facetpivots&quot;) {
          $requestList = $this-&gt;parseResponseFacetPivots ( $value, $requestList );
        } else if ($key == &quot;facetheatmaps&quot;) {
          $requestList = $this-&gt;parseResponseFacetHeatmaps ( $value, $requestList );
        } else if ($key == &quot;prefix&quot; || $key == &quot;sort&quot; || $key == &quot;method&quot; || $key == &quot;contains&quot;) {
          $requestList [] = &quot;facet.{$key}=&quot; . urlencode ( $value );
        } else if ($key == &quot;limit&quot; || $key == &quot;offset&quot; || $key == &quot;mincount&quot;) {
          $requestList [] = &quot;facet.{$key}=&quot; . intval ( $value );
        } else if ($key == &quot;missing&quot;) {
          $requestList [] = &quot;facet.{$key}=&quot; . ($value ? &quot;true&quot; : &quot;false&quot;);
        } else if ($key == &quot;excludeTerms&quot;) {
          $requestList [] = &quot;facet.{$key}=&quot; . urlencode ( implode ( &quot;,&quot;, $value ) );
        }
      }
      // add automatically generated facetqueries
      if ($facetqueries &amp;&amp; is_array ( $facetqueries ) &amp;&amp; count ( $facetqueries ) &gt; 0) {
        list ( $requestList, $keyListFacetQueries ) = $this-&gt;parseResponseFacetQueries ( $facetqueries, $requestList, $keyListFacetQueries );
      }
      // return results
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;facets - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Parse facet fields
   *
   * @param object $object          
   * @param array $requestList          
   * @return array
   */
  private function parseResponseFacetFields($object, array $requestList) {
    if ($object != null &amp;&amp; is_array ( $object )) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        $object [$i] = $this-&gt;parseResponseFacetField ( $object [$i], $i );
        if ($object [$i] &amp;&amp; is_object ( $object [$i] ) &amp;&amp; isset ( $object [$i]-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object [$i]-&gt;__requestList );
        }
      }
    }
    return $requestList;
  }
  /**
   * Parse facet field
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseFacetField($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;__options ) &amp;&amp; is_array ( $object-&gt;__options ) &amp;&amp; count ( $object-&gt;__options ) &gt; 0) {
        $requestList [] = &quot;facet.field=&quot; . urlencode ( &quot;{!&quot; . implode ( &quot; &quot;, $object-&gt;__options ) . &quot;}&quot; . $object-&gt;field );
      } else {
        $requestList [] = &quot;facet.field=&quot; . urlencode ( $object-&gt;field );
      }
      $ignoreList = array (
          &quot;field&quot;,
          &quot;ex&quot;,
          &quot;key&quot;,
          &quot;prefix&quot;,
          &quot;sort&quot;,
          &quot;method&quot;,
          &quot;contains&quot;,
          &quot;missing&quot; 
      );
      foreach ( $object as $key =&gt; $value ) {
        if (in_array ( $key, $ignoreList )) {
          // ignore
        } else if ($key == &quot;limit&quot; || $key == &quot;offset&quot; || $key == &quot;mincount&quot;) {
          if (is_integer ( $value )) {
            $requestList [] = &quot;f.&quot; . urlencode ( $object-&gt;field ) . &quot;.facet.{$key}=&quot; . $value;
          }
        } else if ($key == &quot;join&quot;) {
          $object-&gt;join = $this-&gt;parseResponseFacetFieldJoin ( $value, isset ( $object-&gt;key ) ? $object-&gt;key : $object-&gt;field, $i );
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse join facet field
   *
   * @param object $object          
   * @param string $key          
   * @param number $i          
   * @return object
   */
  private function parseResponseFacetFieldJoin($object, $key, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      if (! isset ( $this-&gt;responseJoins-&gt;facetfield )) {
        $this-&gt;responseJoins-&gt;facetfield = array ();
      }
      $responseJoinItem = new \stdClass ();
      $responseJoinItem-&gt;to = $object-&gt;to;
      $responseJoinItem-&gt;fields = $object-&gt;fields;
      $responseJoinItem-&gt;key = $key;
      $responseJoinItem-&gt;configuration = isset ( $object-&gt;configuration ) ? $object-&gt;configuration : $this-&gt;solrConfiguration;
      $this-&gt;responseJoins-&gt;facetfield [] = $responseJoinItem;
    }
    return $object;
  }
  /**
   * Parse facet queries
   *
   * @param object $object          
   * @param array $requestList          
   * @param array $keyListFacetQueries          
   * @return array
   */
  private function parseResponseFacetQueries($object, $requestList, $keyListFacetQueries) {
    if ($object != null &amp;&amp; is_array ( $object )) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        list ( $object [$i], $keyItem ) = $this-&gt;parseResponseFacetQuery ( $object [$i], $keyListFacetQueries, $i );
        if ($object [$i] &amp;&amp; is_object ( $object [$i] ) &amp;&amp; isset ( $object [$i]-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object [$i]-&gt;__requestList );
          $keyListFacetQueries [] = $keyItem;
        }
      }
    }
    return array (
        $requestList,
        $keyListFacetQueries 
    );
  }
  /**
   * Parse facet query
   *
   * @param object $object          
   * @param array $keyListFacetQueries          
   * @param number $i          
   * @return array
   */
  private function parseResponseFacetQuery($object, $keyListFacetQueries, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      $key = null;
      if (isset ( $object-&gt;__query ) &amp;&amp; $object-&gt;__query &amp;&amp; is_string ( $object-&gt;__query )) {
        $options = array ();
        // check provided key
        if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
          $key = $object-&gt;key;
        }
        // define key to be used
        $key = ($key == null) ? $object-&gt;__query : $key;
        // check uniqueness
        $counter = 0;
        if (in_array ( $key, $keyListFacetQueries )) {
          $counter ++;
          while ( in_array ( $key . &quot; (&quot; . $counter . &quot;)&quot;, $keyListFacetQueries ) ) {
            $counter ++;
          }
          $key = $key . &quot; (&quot; . $counter . &quot;)&quot;;
        }
        // decide to set key
        if ($counter &gt; 0 || (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key ))) {
          $options [] = &quot;key=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $key ) . &quot;\&quot;&quot;;
        }
        // check provided exclusion of filters
        if (isset ( $object-&gt;ex ) &amp;&amp; is_string ( $object-&gt;ex )) {
          $options [] = &quot;ex=\&quot;&quot; . implode ( &quot;,&quot;, array_map ( &quot;base64_encode&quot;, explode ( &quot;,&quot;, $object-&gt;ex ) ) ) . &quot;\&quot;&quot;;
        }
        if (isset ( $object-&gt;tag ) &amp;&amp; is_string ( $object-&gt;tag )) {
          $options [] = &quot;tag=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;tag ) . &quot;\&quot;&quot;;
        }
        // create request
        if (count ( $options ) &gt; 0) {
          $requestList [] = &quot;facet.query=&quot; . urlencode ( &quot;{!&quot; . implode ( &quot; &quot;, $options ) . &quot;}&quot; . $object-&gt;__query );
        } else {
          $requestList [] = &quot;facet.query=&quot; . urlencode ( $object-&gt;__query );
        }
      } else if (is_object ( $object ) &amp;&amp; isset ( $object-&gt;condition ) &amp;&amp; $object-&gt;condition &amp;&amp; is_object ( $object-&gt;condition )) {
        $object-&gt;condition = $this-&gt;parseCondition ( $object-&gt;condition );
        if (isset ( $object-&gt;condition-&gt;__query )) {
          $options = array ();
          // check provided key
          if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
            $key = $object-&gt;key;
          } else {
            $key = null;
          }
          // define key to be used
          $key = ($key == null) ? $object-&gt;condition-&gt;__query : $key;
          // check uniqueness
          $counter = 0;
          if (in_array ( $key, $keyListFacetQueries )) {
            $counter ++;
            while ( in_array ( $key . &quot; (&quot; . $counter . &quot;)&quot;, $keyListFacetQueries ) ) {
              $counter ++;
            }
            $key = $key . &quot; (&quot; . $counter . &quot;)&quot;;
          }
          $options [] = &quot;key=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $key ) . &quot;\&quot;&quot;;
          // check provided exclusion of filters
          if (isset ( $object-&gt;ex ) &amp;&amp; is_string ( $object-&gt;ex )) {
            $options [] = &quot;ex=\&quot;&quot; . implode ( &quot;,&quot;, array_map ( &quot;base64_encode&quot;, explode ( &quot;,&quot;, $object-&gt;ex ) ) ) . &quot;\&quot;&quot;;
          }
          if (isset ( $object-&gt;tag ) &amp;&amp; is_string ( $object-&gt;tag )) {
            $options [] = &quot;tag=\&quot;&quot; . str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $object-&gt;tag ) . &quot;\&quot;&quot;;
          }
          // create request
          if (count ( $options ) &gt; 0) {
            $requestList [] = &quot;facet.query=&quot; . urlencode ( &quot;{!&quot; . implode ( &quot; &quot;, $options ) . &quot;}&quot; . $object-&gt;condition-&gt;__query );
          } else {
            $requestList [] = &quot;facet.query=&quot; . urlencode ( $object-&gt;condition-&gt;__query );
          }
          if (count ( $object-&gt;condition-&gt;__facetQueries ) &gt; 0) {
            $this-&gt;warnings [] = &quot;facets - facetqueries - condition in facetquery should not produce facetqueries&quot;;
          }
          if (count ( $object-&gt;condition-&gt;__mtasStats ) &gt; 0) {
            $this-&gt;warnings [] = &quot;facets - facetqueries - condition in facetquery should not produce mtasStats&quot;;
          }
        }
      }
      if (is_object ( $object )) {
        $object-&gt;__requestList = $requestList;
      }
      return array (
          $object,
          $key 
      );
    } else {
      return array (
          null,
          null 
      );
    }
  }
  /**
   * Parse facet range
   *
   * @param object $object          
   * @param array $requestList          
   * @return array
   */
  private function parseResponseFacetRanges($object, $requestList) {
    if ($object != null &amp;&amp; is_array ( $object )) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        $object [$i] = $this-&gt;parseResponseFacetRange ( $object [$i], $i );
        if ($object [$i] &amp;&amp; is_object ( $object [$i] ) &amp;&amp; isset ( $object [$i]-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object [$i]-&gt;__requestList );
        }
      }
    }
    return $requestList;
  }
  /**
   * Parse facet range
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseFacetRange($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;__options ) &amp;&amp; is_array ( $object-&gt;__options ) &amp;&amp; count ( $object-&gt;__options ) &gt; 0) {
        $requestList [] = &quot;facet.range=&quot; . urlencode ( &quot;{!&quot; . implode ( &quot; &quot;, $object-&gt;__options ) . &quot;}&quot; . $object-&gt;field );
      } else {
        $requestList [] = &quot;facet.range=&quot; . urlencode ( $object-&gt;field );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse facet pivots
   *
   * @param object $object          
   * @param array $requestList          
   * @return array
   */
  private function parseResponseFacetPivots($object, array $requestList) {
    if ($object != null &amp;&amp; is_array ( $object )) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        $object [$i] = $this-&gt;parseResponseFacetPivot ( $object [$i], $i );
        if ($object [$i] &amp;&amp; is_object ( $object [$i] ) &amp;&amp; isset ( $object [$i]-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object [$i]-&gt;__requestList );
        }
      }
    }
    return $requestList;
  }
  /**
   * Parse facet pivot
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseFacetPivot($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;__options ) &amp;&amp; is_array ( $object-&gt;__options ) &amp;&amp; count ( $object-&gt;__options ) &gt; 0) {
        $requestList [] = &quot;facet.pivot=&quot; . urlencode ( &quot;{!&quot; . implode ( &quot; &quot;, $object-&gt;__options ) . &quot;}&quot; . implode ( &quot;,&quot;, $object-&gt;pivot ) );
      } else {
        $requestList [] = &quot;facet.pivot=&quot; . urlencode ( implode ( &quot;,&quot;, $object-&gt;pivot ) );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse facet heatmaps
   *
   * @param object $object
   * @param array $requestList
   * @return array
   */
  private function parseResponseFacetHeatmaps($object, array $requestList) {
    if ($object != null &amp;&amp; is_array ( $object )) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        $object [$i] = $this-&gt;parseResponseFacetHeatmap ( $object [$i], $i );
        if ($object [$i] &amp;&amp; is_object ( $object [$i] ) &amp;&amp; isset ( $object [$i]-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object [$i]-&gt;__requestList );
        }
      }
    }
    return $requestList;
  }
  /**
   * Parse facet heatmap
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseFacetHeatmap($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;__options ) &amp;&amp; is_array ( $object-&gt;__options ) &amp;&amp; count ( $object-&gt;__options ) &gt; 0) {
        $requestList [] = &quot;facet.heatmap=&quot; . urlencode ( &quot;{!&quot; . implode ( &quot; &quot;, $object-&gt;__options ) . &quot;}&quot; . $object-&gt;field );
      } else {
        $requestList [] = &quot;facet.heatmap=&quot; . urlencode ( $object-&gt;field );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse stats in response
   *
   * @param object $object
   *          return unknown
   */
  private function parseResponseStats($object) {
    if (($object &amp;&amp; is_object ( $object ))) {
      $requestList = array ();
      $requestList [] = &quot;stats=true&quot;;
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;statsfields&quot;) {
          $requestList = $this-&gt;parseResponseStatsFields ( $value, $requestList );
        }
      }
      // return results
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      $this-&gt;warnings [] = &quot;stats - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Parse stats fields
   *
   * @param object $object          
   * @param array $requestList          
   * @return array
   */
  private function parseResponseStatsFields($object, array $requestList) {
    if ($object != null &amp;&amp; is_array ( $object )) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        $object [$i] = $this-&gt;parseResponseStatsField ( $object [$i], $i );
        if ($object [$i] &amp;&amp; is_object ( $object [$i] ) &amp;&amp; isset ( $object [$i]-&gt;__requestList )) {
          $requestList = array_merge ( $requestList, $object [$i]-&gt;__requestList );
        }
      }
    }
    return $requestList;
  }
  /**
   * Parse stats field
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseStatsField($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;__options ) &amp;&amp; is_array ( $object-&gt;__options ) &amp;&amp; count ( $object-&gt;__options ) &gt; 0) {
        $requestList [] = &quot;stats.field=&quot; . urlencode ( &quot;{!&quot; . implode ( &quot; &quot;, $object-&gt;__options ) . &quot;}&quot; . $object-&gt;field );
      } else {
        $requestList [] = &quot;stats.field=&quot; . urlencode ( $object-&gt;field );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas in response
   *
   * @param object $object          
   * @param array $mtasStats          
   * @return object
   */
  private function parseResponseMtas($object, $mtasStats) {
    $localErrors = array ();
    $localWarnings = array ();
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      $requestAdditionalList = array ();
      $requestList [] = &quot;mtas=true&quot;;
      // add status key
      if ($this-&gt;statusKey != null) {
        $requestAdditionalList [] = &quot;mtas.status=true&quot;;
        $requestAdditionalList [] = &quot;mtas.status.key=&quot;.urlencode($this-&gt;statusKey);
      }
      // check response
      foreach ( $object as $key =&gt; $value ) {
        if ($key == &quot;stats&quot;) {
          if ($value &amp;&amp; is_object ( $value )) {
            $object-&gt;{$key} = $this-&gt;parseResponseMtasStats ( $value, $mtasStats );
            $requestList = array_merge ( $requestList, $object-&gt;{$key}-&gt;__requestList );
          }
        } else if ($key == &quot;document&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.{$key}=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;parseResponseMtasDocument ( $object-&gt;{$key} [$i], $i );
              if ($object-&gt;{$key} [$i] &amp;&amp; is_object ( $object-&gt;{$key} [$i] ) &amp;&amp; isset ( $object-&gt;{$key} [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $object-&gt;{$key} [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;kwic&quot; || $key == &quot;list&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.{$key}=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;parseResponseMtasKwicAndList ( $key, $object-&gt;{$key} [$i], $i );
              if ($object-&gt;{$key} [$i] &amp;&amp; is_object ( $object-&gt;{$key} [$i] ) &amp;&amp; isset ( $object-&gt;{$key} [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $object-&gt;{$key} [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;page&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.{$key}=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;parseResponseMtasPage ( $object-&gt;{$key} [$i], $i );
              if ($object-&gt;{$key} [$i] &amp;&amp; is_object ( $object-&gt;{$key} [$i] ) &amp;&amp; isset ( $object-&gt;{$key} [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $object-&gt;{$key} [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;heatmap&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.{$key}=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;parseResponseMtasHeatmap ( $object-&gt;{$key} [$i], $i );
              if ($object-&gt;{$key} [$i] &amp;&amp; is_object ( $object-&gt;{$key} [$i] ) &amp;&amp; isset ( $object-&gt;{$key} [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $object-&gt;{$key} [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;termvector&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.{$key}=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;parseResponseMtasTermvector ( $object-&gt;{$key} [$i], $i );
              if ($object-&gt;{$key} [$i] &amp;&amp; is_object ( $object-&gt;{$key} [$i] ) &amp;&amp; isset ( $object-&gt;{$key} [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $object-&gt;{$key} [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;facet&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.{$key}=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;parseResponseMtasFacet ( $object-&gt;{$key} [$i], $i );
              if ($object-&gt;{$key} [$i] &amp;&amp; is_object ( $object-&gt;{$key} [$i] ) &amp;&amp; isset ( $object-&gt;{$key} [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $object-&gt;{$key} [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;group&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.{$key}=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;parseResponseMtasGroup ( $object-&gt;{$key} [$i], $i );
              if ($object-&gt;{$key} [$i] &amp;&amp; is_object ( $object-&gt;{$key} [$i] ) &amp;&amp; isset ( $object-&gt;{$key} [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $object-&gt;{$key} [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;prefix&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.{$key}=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $object-&gt;{$key} [$i] = $this-&gt;parseResponseMtasPrefix ( $object-&gt;{$key} [$i], $i );
              if ($object-&gt;{$key} [$i] &amp;&amp; is_object ( $object-&gt;{$key} [$i] ) &amp;&amp; isset ( $object-&gt;{$key} [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $object-&gt;{$key} [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;collection&quot;) {
          if ($value &amp;&amp; is_array ( $value )) {
            $requestList [] = &quot;mtas.collection=true&quot;;
            for($i = 0; $i &lt; count ( $value ); $i ++) {
              $value [$i] = $this-&gt;parseResponseMtasCollection ( $value [$i], $i );
              if ($value [$i] &amp;&amp; is_object ( $value [$i] ) &amp;&amp; isset ( $value [$i]-&gt;__requestList )) {
                $requestList = array_merge ( $requestList, $value [$i]-&gt;__requestList );
              }
            }
          }
        } else if ($key == &quot;version&quot;) {
          if ($value &amp;&amp; is_bool ( $value )) {
            $requestList [] = &quot;mtas.version=&quot;.($value?&quot;true&quot;:&quot;false&quot;); 
          }
        }
      }
      if (! isset ( $object-&gt;stats ) &amp;&amp; $mtasStats &amp;&amp; count ( $mtasStats ) &gt; 0) {
        $object-&gt;stats = $this-&gt;parseResponseMtasStats ( new \stdClass (), $mtasStats );
        $requestList = array_merge ( $requestList, $object-&gt;stats-&gt;__requestList );
      }
      $object-&gt;__requestList = $requestList;
      $object-&gt;__requestAdditionalList = $requestAdditionalList;
      $this-&gt;errors = array_merge ( $this-&gt;errors, $localErrors );
      $this-&gt;warnings = array_merge ( $this-&gt;warnings, $localWarnings );
      return $object;
    } else if($this-&gt;statusKey!=null) {
      $object = new \stdClass();
      $requestAdditionalList = array();
      $requestAdditionalList [] = &quot;mtas=true&quot;;
      $requestAdditionalList [] = &quot;mtas.status=true&quot;;
      $requestAdditionalList [] = &quot;mtas.status.key=&quot;.urlencode($this-&gt;statusKey);
      $object-&gt;__requestList = array();
      $object-&gt;__requestAdditionalList = $requestAdditionalList;
      return $object;
    } else {
      $localWarnings [] = &quot;mtas - unexpected type&quot;;
      return null;
    }
  }
  /**
   * Parse mtas stats
   *
   * @param object $object          
   * @param array $mtasStats          
   * @return object
   */
  private function parseResponseMtasStats($object, $mtasStats) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      $requestList [] = &quot;mtas.stats=true&quot;;
      if (isset ( $object-&gt;positions ) &amp;&amp; is_array ( $object-&gt;positions )) {
        $requestList [] = &quot;mtas.stats.positions=true&quot;;
        for($i = 0; $i &lt; count ( $object-&gt;positions ); $i ++) {
          $object-&gt;positions [$i] = $this-&gt;parseResponseMtasStatsPositions ( $object-&gt;positions [$i], $i );
          if ($object-&gt;positions [$i] &amp;&amp; is_object ( $object-&gt;positions [$i] ) &amp;&amp; isset ( $object-&gt;positions [$i]-&gt;__requestList )) {
            $requestList = array_merge ( $requestList, $object-&gt;positions [$i]-&gt;__requestList );
          }
        }
      }
      if (isset ( $object-&gt;tokens ) &amp;&amp; is_array ( $object-&gt;tokens )) {
        $requestList [] = &quot;mtas.stats.tokens=true&quot;;
        for($i = 0; $i &lt; count ( $object-&gt;tokens ); $i ++) {
          $object-&gt;tokens [$i] = $this-&gt;parseResponseMtasStatsTokens ( $object-&gt;tokens [$i], $i );
          if ($object-&gt;tokens [$i] &amp;&amp; is_object ( $object-&gt;tokens [$i] ) &amp;&amp; isset ( $object-&gt;tokens [$i]-&gt;__requestList )) {
            $requestList = array_merge ( $requestList, $object-&gt;tokens [$i]-&gt;__requestList );
          }
        }
      }
      if (isset ( $object-&gt;spans ) &amp;&amp; is_array ( $object-&gt;spans ) || ($mtasStats &amp;&amp; is_array ( $mtasStats ) &amp;&amp; count ( $mtasStats ) &gt; 0)) {
        $requestList [] = &quot;mtas.stats.spans=true&quot;;
        if (isset ( $object-&gt;spans ) &amp;&amp; is_array ( $object-&gt;spans )) {
          for($i = 0; $i &lt; count ( $object-&gt;spans ); $i ++) {
            $object-&gt;spans [$i] = $this-&gt;parseResponseMtasStatsSpans ( $object-&gt;spans [$i], $i );
            if ($object-&gt;spans [$i] &amp;&amp; is_object ( $object-&gt;spans [$i] ) &amp;&amp; isset ( $object-&gt;spans [$i]-&gt;__requestList )) {
              $requestList = array_merge ( $requestList, $object-&gt;spans [$i]-&gt;__requestList );
            }
          }
        } else {
          $object-&gt;spans = array ();
        }
        if ($mtasStats &amp;&amp; is_array ( $mtasStats )) {
          $base = count ( $object-&gt;spans );
          for($i = 0; $i &lt; count ( $mtasStats ); $i ++) {
            $object-&gt;spans [($i + $base)] = $this-&gt;parseResponseMtasStatsSpans ( $mtasStats [$i], ($i + $base) );
            if ($object-&gt;spans [($i + $base)] &amp;&amp; is_object ( $object-&gt;spans [($i + $base)] ) &amp;&amp; isset ( $object-&gt;spans [($i + $base)]-&gt;__requestList )) {
              $requestList = array_merge ( $requestList, $object-&gt;spans [($i + $base)]-&gt;__requestList );
            }
          }
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas stats positions
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasStatsPositions($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.stats.positions.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.stats.positions.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type )) {
        $requestList [] = &quot;mtas.stats.positions.&quot; . $i . &quot;.type=&quot; . urlencode ( $object-&gt;type );
      }
      if (isset ( $object-&gt;minimum ) &amp;&amp; is_int ( $object-&gt;minimum )) {
        $requestList [] = &quot;mtas.stats.positions.&quot; . $i . &quot;.minimum=&quot; . urlencode ( $object-&gt;minimum );
      }
      if (isset ( $object-&gt;maximum ) &amp;&amp; is_int ( $object-&gt;maximum )) {
        $requestList [] = &quot;mtas.stats.positions.&quot; . $i . &quot;.maximum=&quot; . urlencode ( $object-&gt;maximum );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas stats tokens
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasStatsTokens($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.stats.tokens.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.stats.tokens.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type )) {
        $requestList [] = &quot;mtas.stats.tokens.&quot; . $i . &quot;.type=&quot; . urlencode ( $object-&gt;type );
      }
      if (isset ( $object-&gt;minimum ) &amp;&amp; is_int ( $object-&gt;minimum )) {
        $requestList [] = &quot;mtas.stats.tokens.&quot; . $i . &quot;.minimum=&quot; . urlencode ( $object-&gt;minimum );
      }
      if (isset ( $object-&gt;maximum ) &amp;&amp; is_int ( $object-&gt;maximum )) {
        $requestList [] = &quot;mtas.stats.tokens.&quot; . $i . &quot;.maximum=&quot; . urlencode ( $object-&gt;maximum );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas stats spans
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasStatsSpans($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type )) {
        $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.type=&quot; . urlencode ( $object-&gt;type );
      }
      if (isset ( $object-&gt;minimum ) &amp;&amp; is_int ( $object-&gt;minimum )) {
        $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.minimum=&quot; . urlencode ( $object-&gt;minimum );
      }
      if (isset ( $object-&gt;maximum ) &amp;&amp; is_int ( $object-&gt;maximum )) {
        $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.maximum=&quot; . urlencode ( $object-&gt;maximum );
      }
      if (isset ( $object-&gt;queries ) &amp;&amp; is_array ( $object-&gt;queries )) {
        for($j = 0; $j &lt; count ( $object-&gt;queries ); $j ++) {
          if (isset ( $object-&gt;queries [$j]-&gt;type ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;type )) {
            $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.query.&quot; . $j . &quot;.type=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;type );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;value ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;value )) {
            $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.query.&quot; . $j . &quot;.value=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;value );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;prefix )) {
            $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.query.&quot; . $j . &quot;.prefix=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;prefix );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;ignore ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;ignore )) {
            $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.query.&quot; . $j . &quot;.ignore=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;ignore );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength ) &amp;&amp; is_int ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength )) {
            $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.query.&quot; . $j . &quot;.maximumIgnoreLength=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;variables )) {
            $counter = 0;
            foreach ( $object-&gt;queries [$j]-&gt;variables-&gt;__variables as $key =&gt; $value ) {
              $values = $this-&gt;createVariablesList($value);
              $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.query.&quot; . $j . &quot;.variable.&quot; . $counter . &quot;.name=&quot; . urlencode ( $key );
              $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.query.&quot; . $j . &quot;.variable.&quot; . $counter . &quot;.value=&quot; . urlencode ( implode ( &quot;,&quot;, $values ) );
              $counter ++;
            }
            for($k = 0; $k &lt; count ( $object-&gt;queries [$j]-&gt;variables-&gt;__stats ); $k ++) {
              $stats = $object-&gt;queries [$j]-&gt;variables-&gt;__stats [$k];
              if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
                $stats-&gt;field = $object-&gt;field;
              }
              $stats-&gt;queries = array ();
              $stats-&gt;queries [0] = new \stdClass ();
              if (isset ( $stats-&gt;__variables )) {
                $stats-&gt;queries [0]-&gt;variables = new \stdClass ();
                $stats-&gt;queries [0]-&gt;variables-&gt;__variables = $stats-&gt;__variables;
                unset ( $stats-&gt;__variables );
                $stats-&gt;queries [0]-&gt;variables-&gt;__stats = array ();
              }
              if (isset ( $object-&gt;queries [$j]-&gt;type ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;type )) {
                $stats-&gt;queries [0]-&gt;type = $object-&gt;queries [$j]-&gt;type;
              }
              if (isset ( $object-&gt;queries [$j]-&gt;value ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;value )) {
                $stats-&gt;queries [0]-&gt;value = $object-&gt;queries [$j]-&gt;value;
              }
              if (isset ( $object-&gt;queries [$j]-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;prefix )) {
                $stats-&gt;queries [0]-&gt;prefix = $object-&gt;queries [$j]-&gt;prefix;
              }
              if (isset ( $object-&gt;queries [$j]-&gt;ignore ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;ignore )) {
                $stats-&gt;queries [0]-&gt;ignore = $object-&gt;queries [$j]-&gt;ignore;
              }
              if (isset ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength ) &amp;&amp; is_int ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength )) {
                $stats-&gt;queries [0]-&gt;maximumIgnoreLength = $object-&gt;queries [$j]-&gt;maximumIgnoreLength;
              }
              if ($stats = $this-&gt;parseResponseMtasStatsSpans ( $stats, $i . &quot;_&quot; . $j . &quot;_&quot; . $k )) {
                $requestList = array_merge ( $requestList, $stats-&gt;__requestList );
              }
            }
          }
        }
      }
      if (isset ( $object-&gt;functions ) &amp;&amp; is_array ( $object-&gt;functions )) {
        for($j = 0; $j &lt; count ( $object-&gt;functions ); $j ++) {
          if (isset ( $object-&gt;functions [$j]-&gt;key ) &amp;&amp; is_string ( $object-&gt;functions [$j]-&gt;key )) {
            $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.function.&quot; . $j . &quot;.key=&quot; . urlencode ( $object-&gt;functions [$j]-&gt;key );
          }
          if (isset ( $object-&gt;functions [$j]-&gt;expression ) &amp;&amp; is_string ( $object-&gt;functions [$j]-&gt;expression )) {
            $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.function.&quot; . $j . &quot;.expression=&quot; . urlencode ( $object-&gt;functions [$j]-&gt;expression );
          }
          if (isset ( $object-&gt;functions [$j]-&gt;type ) &amp;&amp; is_string ( $object-&gt;functions [$j]-&gt;type )) {
            $requestList [] = &quot;mtas.stats.spans.&quot; . $i . &quot;.function.&quot; . $j . &quot;.type=&quot; . urlencode ( $object-&gt;functions [$j]-&gt;type );
          }
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas documents
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasDocument($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;prefix )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.prefix=&quot; . urlencode ( $object-&gt;prefix );
      }
      if (isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.type=&quot; . urlencode ( $object-&gt;type );
      }
      if (isset ( $object-&gt;regexp ) &amp;&amp; is_string ( $object-&gt;regexp )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.regexp=&quot; . urlencode ( $object-&gt;regexp );
      }
      if (isset ( $object-&gt;ignoreRegexp ) &amp;&amp; is_string ( $object-&gt;ignoreRegexp )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.ignoreRegexp=&quot; . urlencode ( $object-&gt;ignoreRegexp );
      }
      if (isset ( $object-&gt;list ) &amp;&amp; is_array ( $object-&gt;list ) &amp;&amp; count($object-&gt;list)&gt;0) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.list=&quot; . urlencode ( implode ( &quot;,&quot;, str_replace ( &quot;,&quot;, &quot;\\,&quot;, str_replace ( &quot;\\&quot;, &quot;\\\\&quot;, $object-&gt;list ) ) ) );
      }
      if (isset ( $object-&gt;listRegexp ) &amp;&amp; is_bool ( $object-&gt;listRegexp )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.listRegexp=&quot; . urlencode ( $object-&gt;listRegexp ? &quot;true&quot; : &quot;false&quot; );
      }
      if (isset ( $object-&gt;listExpand ) &amp;&amp; is_bool ( $object-&gt;listExpand )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.listExpand=&quot; . urlencode ( $object-&gt;listExpand ? &quot;true&quot; : &quot;false&quot; );
      }
      if (isset ( $object-&gt;listExpandNumber ) &amp;&amp; is_int ( $object-&gt;listExpandNumber )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.listExpandNumber=&quot; . urlencode ( $object-&gt;listExpandNumber );
      }
      if (isset ( $object-&gt;ignoreList ) &amp;&amp; is_array ( $object-&gt;ignoreList ) &amp;&amp; count($object-&gt;ignoreList)&gt;0) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.ignoreList=&quot; . urlencode ( implode ( &quot;,&quot;, $object-&gt;ignoreList ) );
      }
      if (isset ( $object-&gt;ignoreListRegexp ) &amp;&amp; is_bool ( $object-&gt;ignoreListRegexp )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.ignoreListRegexp=&quot; . urlencode ( $object-&gt;ignoreListRegexp ? &quot;true&quot; : &quot;false&quot; );
      }
      if (isset ( $object-&gt;number ) &amp;&amp; is_int ( $object-&gt;number )) {
        $requestList [] = &quot;mtas.document.&quot; . $i . &quot;.number=&quot; . urlencode ( $object-&gt;number );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas kwic and list
   *
   * @param string $type          
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasKwicAndList($type, $object, $i) {
    if ($type != &quot;list&quot; &amp;&amp; $type != &quot;kwic&quot;) {
      die ( &quot;incorrect call&quot; );
    }
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;prefix )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.prefix=&quot; . urlencode ( $object-&gt;prefix );
      }
      if (isset ( $object-&gt;output ) &amp;&amp; is_string ( $object-&gt;output )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.output=&quot; . urlencode ( $object-&gt;output );
      }
      if (isset ( $object-&gt;number ) &amp;&amp; is_int ( $object-&gt;number )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.number=&quot; . urlencode ( $object-&gt;number );
      }
      if (isset ( $object-&gt;start ) &amp;&amp; is_int ( $object-&gt;start )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.start=&quot; . urlencode ( $object-&gt;start );
      }
      if ($type==&quot;kwic&quot; &amp;&amp; isset ( $object-&gt;page ) &amp;&amp; is_object ( $object-&gt;page )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.page.start=&quot; . urlencode ( $object-&gt;page-&gt;start );
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.page.end=&quot; . urlencode ( $object-&gt;page-&gt;end );
      }            
      if ($type==&quot;list&quot; &amp;&amp; isset ( $object-&gt;fields ) &amp;&amp; is_array ( $object-&gt;fields )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.fields=&quot; . urlencode ( implode ( &quot;,&quot;, array_unique ( $object-&gt;fields ) ) );
      }      
      if (isset ( $object-&gt;left ) &amp;&amp; is_int ( $object-&gt;left )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.left=&quot; . urlencode ( $object-&gt;left );
      }
      if (isset ( $object-&gt;right ) &amp;&amp; is_int ( $object-&gt;right )) {
        $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.right=&quot; . urlencode ( $object-&gt;right );
      }
      if (isset ( $object-&gt;query ) &amp;&amp; is_object ( $object-&gt;query )) {
        if (isset ( $object-&gt;query-&gt;type ) &amp;&amp; is_string ( $object-&gt;query-&gt;type )) {
          $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.query.type=&quot; . urlencode ( $object-&gt;query-&gt;type );
        }
        if (isset ( $object-&gt;query-&gt;value ) &amp;&amp; is_string ( $object-&gt;query-&gt;value )) {
          $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.query.value=&quot; . urlencode ( $object-&gt;query-&gt;value );
        }
        if (isset ( $object-&gt;query-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;query-&gt;prefix )) {
          $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.query.prefix=&quot; . urlencode ( $object-&gt;query-&gt;prefix );
        }
        if (isset ( $object-&gt;query-&gt;ignore ) &amp;&amp; is_string ( $object-&gt;query-&gt;ignore )) {
          $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.query.ignore=&quot; . urlencode ( $object-&gt;query-&gt;ignore );
        }
        if (isset ( $object-&gt;query-&gt;maximumIgnoreLength ) &amp;&amp; is_int ( $object-&gt;query-&gt;maximumIgnoreLength )) {
          $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.query.maximumIgnoreLength=&quot; . urlencode ( $object-&gt;query-&gt;maximumIgnoreLength );
        }
        if (isset ( $object-&gt;query-&gt;variables )) {
          $counter = 0;
          foreach ( $object-&gt;query-&gt;variables-&gt;__variables as $key =&gt; $value ) {
            $values = $this-&gt;createVariablesList($value);
            $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.query.variable.&quot; . $counter . &quot;.name=&quot; . urlencode ( $key );
            $requestList [] = &quot;mtas.{$type}.&quot; . $i . &quot;.query.variable.&quot; . $counter . &quot;.value=&quot; . urlencode ( implode ( &quot;,&quot;, $values ) );
            $counter ++;
          }
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas page
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasPage($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.page.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.page.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;prefix )) {
        $requestList [] = &quot;mtas.page.&quot; . $i . &quot;.prefix=&quot; . urlencode ( $object-&gt;prefix );
      }
      if (isset ( $object-&gt;start ) &amp;&amp; is_int ( $object-&gt;start )) {
        $requestList [] = &quot;mtas.page.&quot; . $i . &quot;.start=&quot; . urlencode ( $object-&gt;start );
      }
      if (isset ( $object-&gt;start ) &amp;&amp; is_int ( $object-&gt;start )) {
        $requestList [] = &quot;mtas.page.&quot; . $i . &quot;.end=&quot; . urlencode ( $object-&gt;end );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas heatmap
   *
   * @param object $object
   * @param number $i
   * @return object
   */
  private function parseResponseMtasHeatmap($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;heatmapField ) &amp;&amp; is_string ( $object-&gt;heatmapField )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.heatmapField=&quot; . urlencode ( $object-&gt;heatmapField );
      }
      if (isset ( $object-&gt;queryField ) &amp;&amp; is_string ( $object-&gt;queryField )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.queryField=&quot; . urlencode ( $object-&gt;queryField );
      }
      if (isset ( $object-&gt;geom) &amp;&amp; is_string ( $object-&gt;geom )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.geom=&quot; . urlencode ( $object-&gt;geom );
      }
      if (isset ( $object-&gt;gridLevel ) &amp;&amp; is_numeric ( $object-&gt;gridLevel )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.gridLevel=&quot; . intval ( $object-&gt;gridLevel );
      }
      if (isset ( $object-&gt;maxCells ) &amp;&amp; is_numeric ( $object-&gt;maxCells )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.maxCells=&quot; . intval ( $object-&gt;maxCells );
      }
      if (isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.type=&quot; . urlencode ( $object-&gt;type );
      }
      if (isset ( $object-&gt;minimum ) &amp;&amp; is_int ( $object-&gt;minimum )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.minimum=&quot; . urlencode ( $object-&gt;minimum );
      }
      if (isset ( $object-&gt;functions ) &amp;&amp; is_array ( $object-&gt;functions )) {
        for($k = 0; $k &lt; count ( $object-&gt;functions ); $k ++) {
          if (is_object ( $object-&gt;functions [$k] )) {
            if (isset ( $object-&gt;functions [$k]-&gt;key ) &amp;&amp; is_string ( $object-&gt;functions [$k]-&gt;key )) {
              $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.function.&quot; . $k . &quot;.key=&quot; . urlencode ( $object-&gt;functions [$k]-&gt;key );
            }
            if (isset ( $object-&gt;functions [$k]-&gt;expression ) &amp;&amp; is_string ( $object-&gt;functions [$k]-&gt;expression )) {
              $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.function.&quot; . $k . &quot;.expression=&quot; . urlencode ( $object-&gt;functions [$k]-&gt;expression );
            }
            if (isset ( $object-&gt;functions [$k]-&gt;type ) &amp;&amp; is_string ( $object-&gt;functions [$k]-&gt;type )) {
              $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.function.&quot; . $k . &quot;.type=&quot; . urlencode ( $object-&gt;functions [$k]-&gt;type );
            }
          }
        }
      }
      if (isset ( $object-&gt;maximum ) &amp;&amp; is_int ( $object-&gt;maximum )) {
        $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.maximum=&quot; . urlencode ( $object-&gt;maximum );
      }
      if (isset ( $object-&gt;queries ) &amp;&amp; is_array ( $object-&gt;queries )) {
        for($j = 0; $j &lt; count ( $object-&gt;queries ); $j ++) {
          if (isset ( $object-&gt;queries [$j]-&gt;type ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;type )) {
            $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.query.&quot; . $j . &quot;.type=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;type );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;value ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;value )) {
            $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.query.&quot; . $j . &quot;.value=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;value );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;prefix )) {
            $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.query.&quot; . $j . &quot;.prefix=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;prefix );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;ignore ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;ignore )) {
            $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.query.&quot; . $j . &quot;.ignore=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;ignore );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength ) &amp;&amp; is_int ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength )) {
            $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.query.&quot; . $j . &quot;.maximumIgnoreLength=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;variables )) {
            $counter = 0;
            foreach ( $object-&gt;queries [$j]-&gt;variables-&gt;__variables as $key =&gt; $value ) {
              $values = $this-&gt;createVariablesList($value);
              $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.query.&quot; . $j . &quot;.variable.&quot; . $counter . &quot;.name=&quot; . urlencode ( $key );
              $requestList [] = &quot;mtas.heatmap.&quot; . $i . &quot;.query.&quot; . $j . &quot;.variable.&quot; . $counter . &quot;.value=&quot; . urlencode ( implode ( &quot;,&quot;, $values ) );
              $counter ++;
            }
          }
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas termvector
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasTermvector($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;prefix )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.prefix=&quot; . urlencode ( $object-&gt;prefix );
      }
      if (isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.type=&quot; . urlencode ( $object-&gt;type );
      }
      if (isset ( $object-&gt;full ) &amp;&amp; is_bool ( $object-&gt;full )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.full=&quot; . urlencode ( $object-&gt;full ? &quot;true&quot; : &quot;false&quot; );
      }
      if (isset ( $object-&gt;regexp ) &amp;&amp; is_string ( $object-&gt;regexp )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.regexp=&quot; . urlencode ( $object-&gt;regexp );
      }
      if (isset ( $object-&gt;ignorRegexp ) &amp;&amp; is_string ( $object-&gt;ignoreRegexp )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.ignoreRegexp=&quot; . urlencode ( $object-&gt;ignoreRegexp );
      }
      if (isset ( $object-&gt;list ) &amp;&amp; is_array ( $object-&gt;list ) &amp;&amp; count($object-&gt;list)&gt;0) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.list=&quot; . urlencode ( implode ( &quot;,&quot;, str_replace ( &quot;,&quot;, &quot;\\,&quot;, str_replace ( &quot;\\&quot;, &quot;\\\\&quot;, $object-&gt;list ) ) ) );
      }
      if (isset ( $object-&gt;listRegexp ) &amp;&amp; is_bool ( $object-&gt;listRegexp )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.listRegexp=&quot; . urlencode ( $object-&gt;listRegexp ? &quot;true&quot; : &quot;false&quot; );
      }
      if (isset ( $object-&gt;ignoreList ) &amp;&amp; is_array ( $object-&gt;ignoreList ) &amp;&amp; count($object-&gt;ignoreList)&gt;0) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.ignoreList=&quot; . urlencode ( implode ( &quot;,&quot;, $object-&gt;ignoreList ) );
      }
      if (isset ( $object-&gt;ignoreListRegexp ) &amp;&amp; is_bool ( $object-&gt;ignoreListRegexp )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.ignoreListRegexp=&quot; . urlencode ( $object-&gt;ignoreListRegexp ? &quot;true&quot; : &quot;false&quot; );
      }
      if (isset ( $object-&gt;start ) &amp;&amp; is_int ( $object-&gt;start )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.start=&quot; . urlencode ( $object-&gt;start );
      }
      if (isset ( $object-&gt;number ) &amp;&amp; is_int ( $object-&gt;number )) {
        $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.number=&quot; . urlencode ( $object-&gt;number );
      }
      if (isset ( $object-&gt;distances ) &amp;&amp; is_array ( $object-&gt;distances )) {
        for($j = 0; $j &lt; count ( $object-&gt;distances ); $j ++) {
          if (isset ( $object-&gt;distances [$j]-&gt;key ) &amp;&amp; is_string ( $object-&gt;distances [$j]-&gt;key )) {
            $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.distance.&quot; . $j . &quot;.key=&quot; . urlencode ( $object-&gt;distances [$j]-&gt;key );
          }
          if (isset ( $object-&gt;distances [$j]-&gt;type ) &amp;&amp; is_string ( $object-&gt;distances [$j]-&gt;type )) {
            $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.distance.&quot; . $j . &quot;.type=&quot; . urlencode ( $object-&gt;distances [$j]-&gt;type );
          }
          if (isset ( $object-&gt;distances [$j]-&gt;base ) &amp;&amp; is_string ( $object-&gt;distances [$j]-&gt;base )) {
            $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.distance.&quot; . $j . &quot;.base=&quot; . urlencode ( $object-&gt;distances [$j]-&gt;base );
          }
          if (isset ( $object-&gt;distances [$j]-&gt;minimum ) &amp;&amp; is_numeric ( $object-&gt;distances [$j]-&gt;minimum )) {
            $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.distance.&quot; . $j . &quot;.minimum=&quot; . urlencode ( $object-&gt;distances [$j]-&gt;minimum );
          }
          if (isset ( $object-&gt;distances [$j]-&gt;maximum ) &amp;&amp; is_numeric ( $object-&gt;distances [$j]-&gt;maximum )) {
            $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.distance.&quot; . $j . &quot;.maximum=&quot; . urlencode ( $object-&gt;distances [$j]-&gt;maximum );
          }
          if (isset ( $object-&gt;distances [$j]-&gt;parameter ) &amp;&amp; is_object ( $object-&gt;distances [$j]-&gt;parameter )) {
            foreach ( $object-&gt;distances [$j]-&gt;parameter as $parameterKey =&gt; $parameterValue ) {
              $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.distance.&quot; . $j . &quot;.parameter.&quot; . $parameterKey . &quot;=&quot; . urlencode ( $parameterValue );
            }
          }
        }
      }
      if (isset ( $object-&gt;functions ) &amp;&amp; is_array ( $object-&gt;functions )) {
        for($j = 0; $j &lt; count ( $object-&gt;functions ); $j ++) {
          if (isset ( $object-&gt;functions [$j]-&gt;key ) &amp;&amp; is_string ( $object-&gt;functions [$j]-&gt;key )) {
            $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.function.&quot; . $j . &quot;.key=&quot; . urlencode ( $object-&gt;functions [$j]-&gt;key );
          }
          if (isset ( $object-&gt;functions [$j]-&gt;expression ) &amp;&amp; is_string ( $object-&gt;functions [$j]-&gt;expression )) {
            $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.function.&quot; . $j . &quot;.expression=&quot; . urlencode ( $object-&gt;functions [$j]-&gt;expression );
          }
          if (isset ( $object-&gt;functions [$j]-&gt;type ) &amp;&amp; is_string ( $object-&gt;functions [$j]-&gt;type )) {
            $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.function.&quot; . $j . &quot;.type=&quot; . urlencode ( $object-&gt;functions [$j]-&gt;type );
          }
        }
      }
      if (isset ( $object-&gt;sort ) &amp;&amp; is_object ( $object-&gt;sort )) {
        if (isset ( $object-&gt;sort-&gt;type ) &amp;&amp; is_string ( $object-&gt;sort-&gt;type )) {
          $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.sort.type=&quot; . urlencode ( $object-&gt;sort-&gt;type );
        }
        if (isset ( $object-&gt;sort-&gt;direction ) &amp;&amp; is_string ( $object-&gt;sort-&gt;direction )) {
          $requestList [] = &quot;mtas.termvector.&quot; . $i . &quot;.sort.direction=&quot; . urlencode ( $object-&gt;sort-&gt;direction );
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas facet
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasFacet($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;queries ) &amp;&amp; is_array ( $object-&gt;queries )) {
        for($j = 0; $j &lt; count ( $object-&gt;queries ); $j ++) {
          if (isset ( $object-&gt;queries [$j]-&gt;type ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;type )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.query.&quot; . $j . &quot;.type=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;type );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;value ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;value )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.query.&quot; . $j . &quot;.value=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;value );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;prefix )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.query.&quot; . $j . &quot;.prefix=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;prefix );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;ignore ) &amp;&amp; is_string ( $object-&gt;queries [$j]-&gt;ignore )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.query.&quot; . $j . &quot;.ignore=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;ignore );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength ) &amp;&amp; is_int ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.query.&quot; . $j . &quot;.maximumIgnoreLength=&quot; . urlencode ( $object-&gt;queries [$j]-&gt;maximumIgnoreLength );
          }
          if (isset ( $object-&gt;queries [$j]-&gt;variables ) &amp;&amp; is_object ( $object-&gt;queries [$j]-&gt;variables )) {
            $counter = 0;
            foreach ( $object-&gt;queries [$j]-&gt;variables-&gt;__variables as $key =&gt; $value ) {
              $values = $this-&gt;createVariablesList($value);
              $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.query.&quot; . $j . &quot;.variable.&quot; . $counter . &quot;.name=&quot; . urlencode ( $key );
              $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.query.&quot; . $j . &quot;.variable.&quot; . $counter . &quot;.value=&quot; . urlencode ( implode ( &quot;,&quot;, $values ) );
              $counter ++;
            }
          }
        }
      }
      if (isset ( $object-&gt;base ) &amp;&amp; is_array ( $object-&gt;base )) {
        for($j = 0; $j &lt; count ( $object-&gt;base ); $j ++) {
          if (isset ( $object-&gt;base [$j]-&gt;field ) &amp;&amp; is_string ( $object-&gt;base [$j]-&gt;field )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.field=&quot; . urlencode ( $object-&gt;base [$j]-&gt;field );
          }
          if (isset ( $object-&gt;base [$j]-&gt;type ) &amp;&amp; is_string ( $object-&gt;base [$j]-&gt;type )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.type=&quot; . urlencode ( $object-&gt;base [$j]-&gt;type );
          }
          if (isset ( $object-&gt;base [$j]-&gt;sort ) &amp;&amp; is_object ( $object-&gt;base [$j]-&gt;sort )) {
            if (isset ( $object-&gt;base [$j]-&gt;sort-&gt;type ) &amp;&amp; is_string ( $object-&gt;base [$j]-&gt;sort-&gt;type )) {
              $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.sort.type=&quot; . urlencode ( $object-&gt;base [$j]-&gt;sort-&gt;type );
            }
            if (isset ( $object-&gt;base [$j]-&gt;sort-&gt;direction ) &amp;&amp; is_string ( $object-&gt;base [$j]-&gt;sort-&gt;direction )) {
              $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.sort.direction=&quot; . urlencode ( $object-&gt;base [$j]-&gt;sort-&gt;direction );
            }
          }
          if (isset ( $object-&gt;base [$j]-&gt;number ) &amp;&amp; is_int ( $object-&gt;base [$j]-&gt;number )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.number=&quot; . urlencode ( $object-&gt;base [$j]-&gt;number );
          }
          if (isset ( $object-&gt;base [$j]-&gt;minimum ) &amp;&amp; is_int ( $object-&gt;base [$j]-&gt;minimum )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.minimum=&quot; . urlencode ( $object-&gt;base [$j]-&gt;minimum );
          }
          if (isset ( $object-&gt;base [$j]-&gt;maximum ) &amp;&amp; is_int ( $object-&gt;base [$j]-&gt;maximum )) {
            $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.maximum=&quot; . urlencode ( $object-&gt;base [$j]-&gt;maximum );
          }
          if (isset ( $object-&gt;base [$j]-&gt;range ) &amp;&amp; is_object ( $object-&gt;base [$j]-&gt;range )) {
            if (isset ( $object-&gt;base [$j]-&gt;range-&gt;size ) &amp;&amp; is_int ( $object-&gt;base [$j]-&gt;range-&gt;size )) {
              $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.range.size=&quot; . urlencode ( $object-&gt;base [$j]-&gt;range-&gt;size );
            }
            if (isset ( $object-&gt;base [$j]-&gt;range-&gt;base ) &amp;&amp; is_int ( $object-&gt;base [$j]-&gt;range-&gt;base )) {
              $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.range.base=&quot; . urlencode ( $object-&gt;base [$j]-&gt;range-&gt;base );
            }
          }
          if (isset ( $object-&gt;base [$j]-&gt;functions ) &amp;&amp; is_array ( $object-&gt;base [$j]-&gt;functions )) {
            for($k = 0; $k &lt; count ( $object-&gt;base [$j]-&gt;functions ); $k ++) {
              if (is_object ( $object-&gt;base [$j]-&gt;functions [$k] )) {
                if (isset ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;key ) &amp;&amp; is_string ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;key )) {
                  $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.function.&quot; . $k . &quot;.key=&quot; . urlencode ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;key );
                }
                if (isset ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;expression ) &amp;&amp; is_string ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;expression )) {
                  $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.function.&quot; . $k . &quot;.expression=&quot; . urlencode ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;expression );
                }
                if (isset ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;type ) &amp;&amp; is_string ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;type )) {
                  $requestList [] = &quot;mtas.facet.&quot; . $i . &quot;.base.&quot; . $j . &quot;.function.&quot; . $k . &quot;.type=&quot; . urlencode ( $object-&gt;base [$j]-&gt;functions [$k]-&gt;type );
                }
              }
            }
          }
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas group
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasGroup($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;number ) &amp;&amp; is_int ( $object-&gt;number )) {
        $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.number=&quot; . urlencode ( $object-&gt;number );
      }
      if (isset ( $object-&gt;start ) &amp;&amp; is_int ( $object-&gt;start )) {
        $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.start=&quot; . urlencode ( $object-&gt;start );
      }
      if (isset ( $object-&gt;query ) &amp;&amp; is_object ( $object-&gt;query )) {
        if (isset ( $object-&gt;query-&gt;type ) &amp;&amp; is_string ( $object-&gt;query-&gt;type )) {
          $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.query.type=&quot; . urlencode ( $object-&gt;query-&gt;type );
        }
        if (isset ( $object-&gt;query-&gt;value ) &amp;&amp; is_string ( $object-&gt;query-&gt;value )) {
          $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.query.value=&quot; . urlencode ( $object-&gt;query-&gt;value );
        }
        if (isset ( $object-&gt;query-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;query-&gt;prefix )) {
          $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.query.prefix=&quot; . urlencode ( $object-&gt;query-&gt;prefix );
        }
        if (isset ( $object-&gt;query-&gt;ignore ) &amp;&amp; is_string ( $object-&gt;query-&gt;ignore )) {
          $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.query.ignore=&quot; . urlencode ( $object-&gt;query-&gt;ignore );
        }
        if (isset ( $object-&gt;query-&gt;maximumIgnoreLength ) &amp;&amp; is_int ( $object-&gt;query-&gt;maximumIgnoreLength )) {
          $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.query.maximumIgnoreLength=&quot; . urlencode ( $object-&gt;query-&gt;maximumIgnoreLength );
        }
        if (isset ( $object-&gt;query-&gt;variables ) &amp;&amp; is_object ( $object-&gt;query-&gt;variables )) {
          $counter = 0;
          foreach ( $object-&gt;query-&gt;variables-&gt;__variables as $key =&gt; $value ) {
            $values = $this-&gt;createVariablesList($value);
            $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.query.variable.&quot; . $counter . &quot;.name=&quot; . urlencode ( $key );
            $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.query.variable.&quot; . $counter . &quot;.value=&quot; . urlencode ( implode ( &quot;,&quot;, $values ) );
            $counter ++;
          }
        }
      }
      if (isset ( $object-&gt;grouping ) &amp;&amp; is_object ( $object-&gt;grouping )) {
        if (isset ( $object-&gt;grouping-&gt;hit ) &amp;&amp; is_object ( $object-&gt;grouping-&gt;hit )) {
          if (isset ( $object-&gt;grouping-&gt;hit-&gt;inside ) &amp;&amp; is_string ( $object-&gt;grouping-&gt;hit-&gt;inside )) {
            $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.hit.inside.prefixes=&quot; . urlencode ( $object-&gt;grouping-&gt;hit-&gt;inside );
          }
          if (isset ( $object-&gt;grouping-&gt;hit-&gt;insideLeft ) &amp;&amp; is_array ( $object-&gt;grouping-&gt;hit-&gt;insideLeft )) {
            for($j = 0; $j &lt; count ( $object-&gt;grouping-&gt;hit-&gt;insideLeft ); $j ++) {
              if (isset ( $object-&gt;grouping-&gt;hit-&gt;insideLeft [$j]-&gt;prefixes ) &amp;&amp; is_string ( $object-&gt;grouping-&gt;hit-&gt;insideLeft [$j]-&gt;prefixes )) {
                $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.hit.insideLeft.&quot; . $j . &quot;.prefixes=&quot; . urlencode ( $object-&gt;grouping-&gt;hit-&gt;insideLeft [$j]-&gt;prefixes );
              }
              if (isset ( $object-&gt;grouping-&gt;hit-&gt;insideLeft [$j]-&gt;position ) &amp;&amp; (is_string ( $object-&gt;grouping-&gt;hit-&gt;insideLeft [$j]-&gt;position ) || is_int ( $object-&gt;grouping-&gt;hit-&gt;insideLeft [$j]-&gt;position ))) {
                $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.hit.insideLeft.&quot; . $j . &quot;.position=&quot; . urlencode ( $object-&gt;grouping-&gt;hit-&gt;insideLeft [$j]-&gt;position );
              }
            }
          }
          if (isset ( $object-&gt;grouping-&gt;hit-&gt;insideRight ) &amp;&amp; is_array ( $object-&gt;grouping-&gt;hit-&gt;insideRight )) {
            for($j = 0; $j &lt; count ( $object-&gt;grouping-&gt;hit-&gt;insideRight ); $j ++) {
              if (isset ( $object-&gt;grouping-&gt;hit-&gt;insideRight [$j]-&gt;prefixes ) &amp;&amp; is_string ( $object-&gt;grouping-&gt;hit-&gt;insideRight [$j]-&gt;prefixes )) {
                $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.hit.insideRight.&quot; . $j . &quot;.prefixes=&quot; . urlencode ( $object-&gt;grouping-&gt;hit-&gt;insideRight [$j]-&gt;prefixes );
              }
              if (isset ( $object-&gt;grouping-&gt;hit-&gt;insideRight [$j]-&gt;position ) &amp;&amp; (is_string ( $object-&gt;grouping-&gt;hit-&gt;insideRight [$j]-&gt;position ) || is_int ( $object-&gt;grouping-&gt;hit-&gt;insideRight [$j]-&gt;position ))) {
                $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.hit.insideRight.&quot; . $j . &quot;.position=&quot; . urlencode ( $object-&gt;grouping-&gt;hit-&gt;insideRight [$j]-&gt;position );
              }
            }
          }
        }
        if (isset ( $object-&gt;grouping-&gt;right ) &amp;&amp; is_array ( $object-&gt;grouping-&gt;right )) {
          for($j = 0; $j &lt; count ( $object-&gt;grouping-&gt;right ); $j ++) {
            if (isset ( $object-&gt;grouping-&gt;right [$j]-&gt;prefixes ) &amp;&amp; is_string ( $object-&gt;grouping-&gt;right [$j]-&gt;prefixes )) {
              $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.right.&quot; . $j . &quot;.prefixes=&quot; . urlencode ( $object-&gt;grouping-&gt;right [$j]-&gt;prefixes );
            }
            if (isset ( $object-&gt;grouping-&gt;right [$j]-&gt;position ) &amp;&amp; (is_string ( $object-&gt;grouping-&gt;right [$j]-&gt;position ) || is_int ( $object-&gt;grouping-&gt;right [$j]-&gt;position ))) {
              $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.right.&quot; . $j . &quot;.position=&quot; . urlencode ( $object-&gt;grouping-&gt;right [$j]-&gt;position );
            }
          }
        }
        if (isset ( $object-&gt;grouping-&gt;left ) &amp;&amp; is_array ( $object-&gt;grouping-&gt;left )) {
          for($j = 0; $j &lt; count ( $object-&gt;grouping-&gt;left ); $j ++) {
            if (isset ( $object-&gt;grouping-&gt;left [$j]-&gt;prefixes ) &amp;&amp; is_string ( $object-&gt;grouping-&gt;left [$j]-&gt;prefixes )) {
              $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.left.&quot; . $j . &quot;.prefixes=&quot; . urlencode ( $object-&gt;grouping-&gt;left [$j]-&gt;prefixes );
            }
            if (isset ( $object-&gt;grouping-&gt;left [$j]-&gt;position ) &amp;&amp; (is_string ( $object-&gt;grouping-&gt;left [$j]-&gt;position ) || is_int ( $object-&gt;grouping-&gt;left [$j]-&gt;position ))) {
              $requestList [] = &quot;mtas.group.&quot; . $i . &quot;.grouping.left.&quot; . $j . &quot;.position=&quot; . urlencode ( $object-&gt;grouping-&gt;left [$j]-&gt;position );
            }
          }
        }
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas prefix
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasPrefix($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.prefix.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.prefix.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse mtas collection
   *
   * @param object $object          
   * @param number $i          
   * @return object
   */
  private function parseResponseMtasCollection($object, $i) {
    if ($object &amp;&amp; is_object ( $object )) {
      $requestList = array ();
      if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
        $requestList [] = &quot;mtas.collection.&quot; . $i . &quot;.key=&quot; . urlencode ( $object-&gt;key );
      }
      if (isset ( $object-&gt;action ) &amp;&amp; is_string ( $object-&gt;action )) {
        $requestList [] = &quot;mtas.collection.&quot; . $i . &quot;.action=&quot; . urlencode ( $object-&gt;action );
      }
      if (isset ( $object-&gt;id ) &amp;&amp; is_string ( $object-&gt;id )) {
        $requestList [] = &quot;mtas.collection.&quot; . $i . &quot;.id=&quot; . urlencode ( $object-&gt;id );
      }
      if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
        $requestList [] = &quot;mtas.collection.&quot; . $i . &quot;.field=&quot; . urlencode ( $object-&gt;field );
      }
      if (isset ( $object-&gt;post ) &amp;&amp; is_array ( $object-&gt;post )) {
        $requestList [] = &quot;mtas.collection.&quot; . $i . &quot;.post=&quot; . urlencode ( json_encode ( $object-&gt;post ) );
      }
      if (isset ( $object-&gt;collection ) &amp;&amp; is_string ( $object-&gt;collection )) {
        $requestList [] = &quot;mtas.collection.&quot; . $i . &quot;.collection=&quot; . urlencode ( $object-&gt;collection );
      }
      if (isset ( $object-&gt;configuration ) &amp;&amp; is_string ( $object-&gt;configuration )) {
        if (isset ( $this-&gt;configuration-&gt;config [&quot;solr&quot;] [$object-&gt;configuration] ) &amp;&amp; isset ( $this-&gt;configuration-&gt;config [&quot;solr&quot;] [$object-&gt;configuration] [&quot;url&quot;] )) {
          $requestList [] = &quot;mtas.collection.&quot; . $i . &quot;.url=&quot; . urlencode ( $this-&gt;configuration-&gt;config [&quot;solr&quot;] [$object-&gt;configuration] [&quot;url&quot;] );
        }
      }
      if (isset ( $object-&gt;url ) &amp;&amp; is_string ( $object-&gt;url )) {
        $requestList [] = &quot;mtas.collection.&quot; . $i . &quot;.url=&quot; . urlencode ( $object-&gt;url );
      }
      $object-&gt;__requestList = $requestList;
      return $object;
    } else {
      return null;
    }
  }
  /**
   * Parse condition
   *
   * @param object $object          
   * @return object
   */
  private function parseCondition($object) {
    if ($object &amp;&amp; is_object ( $object )) {
      // initialise
      $object-&gt;__query = &quot;*:* NOT *:*&quot;;
      $object-&gt;__facetQueries = array ();
      $object-&gt;__mtasStats = array ();
      // and + or
      if ($object-&gt;type == &quot;and&quot; || $object-&gt;type == &quot;or&quot;) {
        $subqueries = array ();
        for($i = 0; $i &lt; count ( $object-&gt;list ); $i ++) {
          $object-&gt;list [$i] = $this-&gt;parseCondition($object-&gt;list [$i]);
          $subquery = $object-&gt;list [$i]-&gt;__query;
          $object-&gt;__facetQueries = array_merge ( $object-&gt;__facetQueries, $object-&gt;list [$i]-&gt;__facetQueries );
          $object-&gt;__mtasStats = array_merge ( $object-&gt;__mtasStats, $object-&gt;list [$i]-&gt;__mtasStats );
          $subqueries [] = $subquery;
        }
        if ($object-&gt;type == &quot;and&quot;) {
          if (count ( $subqueries ) &gt; 1) {
            $object-&gt;__query = &quot;(&quot; . implode ( &quot;) AND (&quot;, $subqueries ) . &quot;)&quot;;
          } else {
            $object-&gt;__query = $subqueries [0];
          }
        } else {
          if (count ( $subqueries ) &gt; 1) {
            $object-&gt;__query = &quot;(&quot; . implode ( &quot;) OR (&quot;, $subqueries ) . &quot;)&quot;;
          } else {
            $object-&gt;__query = $subqueries [0];
          }
        }
        // equals/phrase + expansion
      } else if (($object-&gt;type == &quot;equals&quot; || $object-&gt;type == &quot;phrase&quot;) &amp;&amp; isset ( $object-&gt;expansion )) {
        $values = $this-&gt;computeExpansionValues ( $object-&gt;value, $object-&gt;expansion, &quot;condition - &quot; );
        if (count ( $values ) &gt; 0) {
          $queries = array ();
          foreach ( $values as $value ) {
            $subquery = $object-&gt;field . &quot;:&quot; . $this-&gt;solrEncode ( $value, $object-&gt;type );
            if (isset ( $object-&gt;facetquery ) &amp;&amp; $object-&gt;facetquery) {
              $facetQuery = new \stdClass ();
              if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
                $facetQuery-&gt;__query = &quot;(*:* NOT {$subquery})&quot;;
              } else {
                $facetQuery-&gt;__query = $subquery;
              }
              if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
                $facetQuery-&gt;key = $object-&gt;key . &quot; - '&quot; . $value . &quot;'&quot;;
              }
              $object-&gt;__facetQueries [] = $facetQuery;
            }
            $queries [] = $subquery;
          }
          if (count ( $queries ) &gt; 1) {
            if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
              $object-&gt;__query = &quot;(*:* NOT (&quot; . implode ( &quot;) AND (&quot;, $queries ) . &quot;))&quot;;
            } else {
              $object-&gt;__query = &quot;(&quot; . implode ( &quot;) OR (&quot;, $queries ) . &quot;)&quot;;
            }
          } else {
            if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
              $object-&gt;__query = &quot;(*:* NOT {$queries [0]})&quot;;
            } else {
              $object-&gt;__query = $queries [0];
            }
          }
        } else {
          if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
            $object-&gt;__query = &quot;*:*&quot;;
          } else {
            $object-&gt;__query = &quot;(*:* NOT *:*)&quot;;
          }
        }
      } else if (($object-&gt;type == &quot;equals&quot; || $object-&gt;type == &quot;phrase&quot; || $object-&gt;type == &quot;wildcard&quot; || $object-&gt;type == &quot;regexp&quot;) &amp;&amp; is_array ( $object-&gt;value )) {
        $subqueries = array ();
        foreach ( $object-&gt;value as $valueItem ) {
          $subquery = $object-&gt;field . &quot;:&quot; . $this-&gt;solrEncode ( $valueItem, $object-&gt;type );
          $subqueries [] = $subquery;
          // create facetQuery
          if (isset ( $object-&gt;facetquery ) &amp;&amp; $object-&gt;facetquery) {
            $facetQuery = new \stdClass ();
            if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
              $facetQuery-&gt;__query = &quot;(*:* NOT {$subquery})&quot;;
            } else {
              $facetQuery-&gt;__query = $subquery;
            }
            if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
              $facetQuery-&gt;key = $object-&gt;key . &quot; - '&quot; . $valueItem . &quot;'&quot;;
            }
            $object-&gt;__facetQueries [] = $facetQuery;
          }
        }
        if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
          if (count ( $subqueries ) &gt; 1) {
            $object-&gt;__query = &quot;(*:* NOT (&quot; . implode ( &quot;) AND (&quot;, $subqueries ) . &quot;))&quot;;
          } else {
            $object-&gt;__query = &quot;(*:* NOT {$subqueries [0]})&quot;;
          }
        } else {
          if (count ( $subqueries ) &gt; 1) {
            $object-&gt;__query = &quot;(&quot; . implode ( &quot;) OR (&quot;, $subqueries ) . &quot;)&quot;;
          } else {
            $object-&gt;__query = $subqueries [0];
          }
        }
        // equals, phrase, wildcard or regexp
      } else if ($object-&gt;type == &quot;equals&quot; || $object-&gt;type == &quot;phrase&quot; || $object-&gt;type == &quot;wildcard&quot; || $object-&gt;type == &quot;regexp&quot;) {
        $object-&gt;__query = $object-&gt;field . &quot;:&quot; . $this-&gt;solrEncode ( $object-&gt;value, $object-&gt;type );
        if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
          $object-&gt;__query = &quot;(*:* NOT {$object-&gt;__query})&quot;;
        }
      } else if ($object-&gt;type == &quot;range&quot;) {
        $start = isset ( $object-&gt;start ) ? $object-&gt;start : &quot;*&quot;;
        $end = isset ( $object-&gt;end ) ? $object-&gt;end : &quot;*&quot;;
        $object-&gt;__query = $object-&gt;field . &quot;:[&quot; . $this-&gt;solrEncode ( $start, $object-&gt;type ) . &quot; TO &quot; . $this-&gt;solrEncode ( $end, $object-&gt;type ) . &quot;]&quot;;
        if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
          $object-&gt;__query = &quot;(*:* NOT &quot; . $object-&gt;__query . &quot;)&quot;;
        }
      } else if ($object-&gt;type == &quot;geojson&quot;) {
        if($object-&gt;predicate==&quot;intersects&quot;) {
          $value  = &quot;Intersects(&quot;.$object-&gt;geometry.&quot;)&quot;; 
        } else if($object-&gt;predicate==&quot;iswithin&quot;) {
          $value  = &quot;IsWithin(&quot;.$object-&gt;geometry.&quot;)&quot;;
        } else if($object-&gt;predicate==&quot;contains&quot;) {
          $value  = &quot;Contains(&quot;.$object-&gt;geometry.&quot;)&quot;;
        } else if($object-&gt;predicate==&quot;isdisjointto&quot;) {
          $value  = &quot;IsDisjointTo(&quot;.$object-&gt;geometry.&quot;)&quot;;
        }
        $object-&gt;__query = $object-&gt;field . &quot;:&quot;.$this-&gt;solrEncode ( $value, $object-&gt;type );
        if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
          $object-&gt;__query = &quot;(*:* NOT &quot; . $object-&gt;__query . &quot;)&quot;;
        }
      } else if ($object-&gt;type == &quot;cql&quot;  || $object-&gt;type == &quot;simple&quot;) {
        if (isset ( $object-&gt;ignore ) &amp;&amp; (trim ( $object-&gt;ignore ) != &quot;&quot;)) {
          $ignore = $object-&gt;ignore;
          if (isset ( $object-&gt;maximumIgnoreLength ) &amp;&amp; is_int ( $object-&gt;maximumIgnoreLength )) {
            $maximumIgnoreLength = $object-&gt;maximumIgnoreLength;
          } else {
            $maximumIgnoreLength = null;
          }
        } else {
          $ignore = null;
          $maximumIgnoreLength = null;
        }
        if (isset ( $object-&gt;prefix ) &amp;&amp; (trim ( $object-&gt;prefix ) != &quot;&quot;)) {
          $prefix = $object-&gt;prefix;
        } else {
          $prefix = null;
        }
        
        if ($object-&gt;type == &quot;cql&quot; &amp;&amp; isset ( $object-&gt;variables )) {
          $variables = $object-&gt;variables-&gt;__variables;
          $stats = $object-&gt;variables-&gt;__stats;
        } else {
          $variables = null;
          $stats = null;
        }
        if ($object-&gt;type == &quot;cql&quot;) {
          $object-&gt;__query = &quot;{!&quot; . $this-&gt;configuration-&gt;solr [$this-&gt;solrConfiguration] [&quot;queryParserCql&quot;] . &quot; field=\&quot;&quot; . $object-&gt;field . &quot;\&quot; query=&quot; . $this-&gt;solrEncode ( $object-&gt;value, $object-&gt;type ) . &quot; &quot; . ($prefix != null ? &quot;prefix=&quot; . $this-&gt;solrEncode ( $prefix, &quot;equals&quot; ) : &quot;&quot;) . &quot; &quot; . ($ignore != null ? (&quot;ignore=&quot; . $this-&gt;solrEncode ( $ignore, $object-&gt;type )) : &quot;&quot;) . &quot; &quot; . ($maximumIgnoreLength != null ? (&quot;maximumIgnoreLength=&quot; . $maximumIgnoreLength) : &quot;&quot;) . &quot; &quot; . $this-&gt;createVariablesString ( $variables ) . &quot;}&quot;;
        } else if ($object-&gt;type == &quot;simple&quot;) {
          $object-&gt;__query = &quot;{!&quot; . $this-&gt;configuration-&gt;solr [$this-&gt;solrConfiguration] [&quot;queryParserSimple&quot;] . &quot; field=\&quot;&quot; . $object-&gt;field . &quot;\&quot; query=&quot; . $this-&gt;solrEncode ( $object-&gt;value, $object-&gt;type ) . &quot; prefix=&quot; . $this-&gt;solrEncode ( $prefix, &quot;equals&quot; ) . &quot; &quot; . ($ignore != null ? (&quot;ignore=&quot; . $this-&gt;solrEncode ( $ignore, $object-&gt;type )) : &quot;&quot;) . &quot; &quot; . ($maximumIgnoreLength != null ? (&quot;maximumIgnoreLength=&quot; . $maximumIgnoreLength) : &quot;&quot;) . &quot;}&quot;;
        }
        if (isset ( $object-&gt;not ) &amp;&amp; $object-&gt;not) {
          $object-&gt;__query = &quot;(*:* NOT &quot; . $object-&gt;__query . &quot;)&quot;;
        }
        if ($stats) {
          foreach ( $stats as $statsItem ) {
            $statsItem-&gt;queries = array ();
            $statsItem-&gt;queries [0] = new \stdClass ();
            if (isset ( $object-&gt;field ) &amp;&amp; is_string ( $object-&gt;field )) {
              $statsItem-&gt;field = $object-&gt;field;
            }
            if (isset ( $object-&gt;type ) &amp;&amp; is_string ( $object-&gt;type )) {
              $statsItem-&gt;queries [0]-&gt;type = $object-&gt;type;
            }
            if (isset ( $object-&gt;value ) &amp;&amp; is_string ( $object-&gt;value )) {
              $statsItem-&gt;queries [0]-&gt;value = $object-&gt;value;
            }
            if (isset ( $object-&gt;prefix ) &amp;&amp; is_string ( $object-&gt;prefix )) {
              $statsItem-&gt;queries [0]-&gt;prefix = $object-&gt;prefix;
            }
            if (isset ( $object-&gt;ignore ) &amp;&amp; is_string ( $object-&gt;ignore )) {
              $statsItem-&gt;queries [0]-&gt;ignore = $object-&gt;ignore;
            }
            if (isset ( $object-&gt;maximumIgnoreLength ) &amp;&amp; is_int ( $object-&gt;maximumIgnoreLength )) {
              $statsItem-&gt;queries [0]-&gt;maximumIgnoreLength = $object-&gt;maximumIgnoreLength;
            }
            if (isset ( $statsItem-&gt;__variables )) {
              $statsItem-&gt;queries [0]-&gt;variables = new \stdClass ();
              $statsItem-&gt;queries [0]-&gt;variables-&gt;__variables = $statsItem-&gt;__variables;
              $statsItem-&gt;queries [0]-&gt;variables-&gt;__stats = array ();
              unset ( $statsItem-&gt;__variables );
            }
            $object-&gt;__mtasStats [] = $statsItem;
          }
        }
      } else if ($object-&gt;type == &quot;join&quot;) {
        $object-&gt;_collectionId = $this-&gt;createCollectionIdFromJoin ( $object, $this-&gt;solrConfiguration );
        $this-&gt;collectionIds [] = $object-&gt;_collectionId;
        if(is_string($object-&gt;to)) {
          $queryToPart = &quot;field=\&quot;&quot;.$object-&gt;to.&quot;\&quot;&quot;; 
        } else if(is_array($object-&gt;to)) {
          $queryToPart = array();
          foreach($object-&gt;to AS $toItem) {
            $queryToPart[] = &quot;field=\&quot;&quot;.$toItem.&quot;\&quot;&quot;; 
          }          
          $queryToPart = implode(&quot; &quot;, $queryToPart);
        } else {
          die(&quot;unexpected to field in join&quot;);
        }
        $object-&gt;__query = &quot;{!&quot; . $this-&gt;configuration-&gt;solr [$this-&gt;solrConfiguration] [&quot;queryParserJoin&quot;] . &quot; &quot;.$queryToPart.&quot; collection=\&quot;&quot; . $object-&gt;_collectionId . &quot;\&quot;}&quot;;
      } else {
        // should not happen
        die ( &quot;unknown type: &quot; . $object-&gt;type );
      }
      // create (main) facetquery
      if (isset ( $object-&gt;facetquery ) &amp;&amp; $object-&gt;facetquery) {
        $facetQuery = new \stdClass ();
        $facetQuery-&gt;__query = $object-&gt;__query;
        if (isset ( $object-&gt;key ) &amp;&amp; is_string ( $object-&gt;key )) {
          $facetQuery-&gt;key = $object-&gt;key;
        }
        $object-&gt;__facetQueries [] = $facetQuery;
      }
    }
    return $object;
  }
  /**
   * Parse filters
   *
   * @param object $object          
   * @return array
   */
  private function parseFilters($object) {
    $localErrors = array ();
    $localWarnings = array ();
    $requestList = array ();
    $facetQueries = array ();
    $mtasStats = array ();
    if ($object &amp;&amp; is_object ( $object )) {
      list ( $object, $requestList, $facetQueries, $mtasStats ) = $this-&gt;parseFilter ( $object, $requestList, $facetQueries, $mtasStats );
    } else if ($object &amp;&amp; is_array ( $object ) &amp;&amp; count ( $object ) &gt; 0) {
      for($i = 0; $i &lt; count ( $object ); $i ++) {
        list ( $object [$i], $requestList, $facetQueries, $mtasStats ) = $this-&gt;parseFilter ( $object [$i], $requestList, $facetQueries, $mtasStats );
      }
    } else {
      $localWarnings [] = &quot;filter - unexpected type&quot;;
    }
    $this-&gt;errors = array_merge ( $this-&gt;errors, $localErrors );
    $this-&gt;warnings = array_merge ( $this-&gt;warnings, $localWarnings );
    return array (
        $object,
        $requestList,
        $facetQueries,
        $mtasStats 
    );
  }
  /**
   * Parse filter
   *
   * @param object $object          
   * @param array $requestList          
   * @param array $facetQueries          
   * @param array $mtasStats          
   * @return array
   */
  private function parseFilter($object, array $requestList, array $facetQueries, array $mtasStats) {
    $localErrors = array ();
    $localWarnings = array ();
    if ($object &amp;&amp; is_object ( $object )) {
      $options = array ();
      if (isset ( $object-&gt;tag ) &amp;&amp; is_string ( $object-&gt;tag )) {
        $options [] = &quot;tag=\&quot;&quot; . base64_encode ( $object-&gt;tag ) . &quot;\&quot;&quot;;
      }
      if ($object-&gt;condition &amp;&amp; is_object ( $object-&gt;condition )) {
        $object-&gt;condition = $this-&gt;parseCondition ( $object-&gt;condition );
        if ($object-&gt;condition &amp;&amp; is_object ( $object-&gt;condition ) &amp;&amp; isset ( $object-&gt;condition-&gt;__query )) {
          $requestList [] = &quot;fq=&quot; . urlencode ( (count ( $options ) &gt; 0 ? &quot;{!&quot; . implode ( &quot; &quot;, $options ) . &quot;}&quot; : &quot;&quot;) . $object-&gt;condition-&gt;__query );
          $facetQueries = array_merge ( $facetQueries, $object-&gt;condition-&gt;__facetQueries );
          $mtasStats = array_merge ( $mtasStats, $object-&gt;condition-&gt;__mtasStats );
        }
      } else {
        $localErrors [] = &quot;filter - condition should be an object&quot;;
      }
    } else {
      $localWarnings [] = &quot;filter - unexpected type&quot;;
    }
    $this-&gt;errors = array_merge ( $this-&gt;errors, $localErrors );
    $this-&gt;warnings = array_merge ( $this-&gt;warnings, $localWarnings );
    return array (
        $object,
        $requestList,
        $facetQueries,
        $mtasStats 
    );
  }
  /**
   * Create collectionId from join
   *
   * @param object $object          
   * @param object $configuration          
   * @return string
   */
  private function createCollectionIdFromJoin($object, $configuration) {
    $collectionId = null;
    if (count ( $this-&gt;errors ) == 0) {
      if (isset ( $object-&gt;configuration )) {
        $subConfiguration = $object-&gt;configuration;
      } else {
        $subConfiguration = null;
      }
      if (isset ( $object-&gt;filter )) {
        $subFilter = clone $object-&gt;filter;
      } else {
        $subFilter = null;
      }
      if (isset ( $object-&gt;condition )) {
        $subCondition = clone $object-&gt;condition;
      } else {
        $subCondition = null;
      }
      if ($this-&gt;collection == null) {
        $this-&gt;getCollection ();
      }
      $collectionId = $this-&gt;collection-&gt;create ( $subConfiguration, $subFilter, $subCondition, $object-&gt;from );
      return $this-&gt;finishCollectionIdFromJoin ( $collectionId, $configuration );
    }
    return $collectionId;
  }
  /**
   * Finish collectionId from join
   *
   * @param object $collectionId          
   * @param object $configuration          
   * @return string
   */
  private function finishCollectionIdFromJoin($collectionId, $configuration) {
    if ($collectionId) {
      $checkInfo = $this-&gt;collection-&gt;check ( $collectionId );
      if (! $checkInfo || $checkInfo [&quot;key&quot;] != $collectionId) {
        $this-&gt;errors [] = &quot;collection - couldn't check collection &quot; . $collectionId;
      } else {
        // initialise if necessary
        if (! $checkInfo [&quot;initialised&quot;]) {
          list ( $localWarnings, $localErrors ) = $this-&gt;collection-&gt;doInitialise ( $collectionId );
          foreach ( $localErrors as $localError ) {
            $this-&gt;errors [] = &quot;collection &quot; . $collectionId . &quot; - &quot; . $localError;
          }
          foreach ( $localWarnings as $localWarning ) {
            $this-&gt;warnings [] = &quot;collection &quot; . $collectionId . &quot; - &quot; . $localWarning;
          }
          $checkInfo = $this-&gt;collection-&gt;check ( $collectionId );
          if (! $checkInfo || ! $checkInfo [&quot;initialised&quot;]) {
            $this-&gt;errors [] = &quot;collection - couldn't initialise collection &quot; . $collectionId;
          }
        }
        // check if necessary
        if ($checkInfo &amp;&amp; $checkInfo [&quot;check&quot;] &amp;&amp; ! $this-&gt;collection-&gt;check ( $collectionId )) {
          $this-&gt;errors [] = &quot;collection - collection &quot; . $collectionId . &quot; couldn't be checked&quot;;
        }
        if ($checkInfo [&quot;configuration&quot;] != $configuration) {
          return $this-&gt;finishCollectionIdFromJoin ( $this-&gt;collection-&gt;createFromCollection ( $configuration, $collectionId ), $checkInfo [&quot;configuration&quot;] );
        }
      }
    }
    return $collectionId;
  }
  /**
   * Create variables string
   *
   * @param array $variables          
   * @return string
   */
  private function createVariablesString($variables) {
    $result = &quot;&quot;;
    if ($variables &amp;&amp; is_array ( $variables )) {
      foreach ( $variables as $key =&gt; $item ) {
        $value = &quot;&quot;;
        if (is_array ( $item ) &amp;&amp; count ( $item ) &gt; 0) {
          for($i = 0; $i &lt; count ( $item ); $i ++) {
            if ($i &gt; 0) {
              $value .= &quot;,&quot;;
            }
            $escapedItem = str_replace ( &quot;,&quot;, &quot;\\\\\\,&quot;, str_replace ( &quot;\\&quot;, &quot;\\\\&quot;, $item [$i] ) );
            if(strpos($item[$i], &quot;\&quot;&quot;)!==false) {
              $escapedItem = str_replace ( &quot;\&quot;&quot;, &quot;\\\\\\\&quot;&quot;, $escapedItem );
              //only for cql?
              $escapeList = array(&quot;&lt;&quot;,&quot;(&quot;,&quot;[&quot;,&quot;{&quot;,&quot;^&quot;,&quot;-&quot;,&quot;=&quot;,&quot;$&quot;,&quot;!&quot;,&quot;|&quot;,&quot;]&quot;,&quot;}&quot;,&quot;)&quot;,&quot;?&quot;,&quot;*&quot;,&quot;+&quot;,&quot;.&quot;,&quot;&gt;&quot;);
              foreach($escapeList AS $escapeItem) {
                $escapedItem = str_replace ( $escapeItem, &quot;\\\\\\&quot;.$escapeItem, $escapedItem );
              }
              $escapedItem = &quot;\\\&quot;&quot;.$escapedItem.&quot;\\\&quot;&quot;;
            } 
            $value .= $escapedItem;
          }
        }
        $result .= &quot;variable_{$key}=\&quot;&quot; . $value . &quot;\&quot; &quot;;
      }
    }
    return $result;
  }
  /**
   * Create variables list
   *
   * @param array $variables
   * @return array
   */
  private function createVariablesList($variables) {
    foreach ( $variables as $valueItem ) {
      $escapedItem = str_replace ( &quot;,&quot;, &quot;\\,&quot;, str_replace ( &quot;\\&quot;, &quot;\\\\&quot;, $valueItem ) );
      if(strpos($valueItem, &quot;\&quot;&quot;)!==false) {
        $escapedItem = str_replace ( &quot;\&quot;&quot;, &quot;\\\&quot;&quot;, $escapedItem );
        //only for cql?
        $escapeList = array(&quot;&lt;&quot;,&quot;(&quot;,&quot;[&quot;,&quot;{&quot;,&quot;^&quot;,&quot;-&quot;,&quot;=&quot;,&quot;$&quot;,&quot;!&quot;,&quot;|&quot;,&quot;]&quot;,&quot;}&quot;,&quot;)&quot;,&quot;?&quot;,&quot;*&quot;,&quot;+&quot;,&quot;.&quot;,&quot;&gt;&quot;);
        foreach($escapeList AS $escapeItem) {
          $escapedItem = str_replace ( $escapeItem, &quot;\\&quot;.$escapeItem, $escapedItem );
        }
        $escapedItem = &quot;\&quot;&quot;.$escapedItem.&quot;\&quot;&quot;;
      }
      $values [] = $escapedItem;      
    }
    return $values;
  }
  /**
   * Create variable combinations
   *
   * @param array $variables          
   * @param array $combinations          
   * @return array
   */
  private function createVariableCombinations($variables, $combinations) {
    $list = array ();
    $combinationKeys = array_keys ( $combinations );
    if (count ( $combinationKeys ) == count ( $variables )) {
      $list [] = $combinations;
      return $list;
    } else {
      foreach ( $variables as $key =&gt; $value ) {
        if (! in_array ( $key, $combinationKeys )) {
          foreach ( $value as $valueItem ) {
            $combinations [$key] = array (
                $valueItem 
            );
            $list = array_merge ( $list, $this-&gt;createVariableCombinations ( $variables, $combinations ) );
          }
          return $list;
        }
      }
    }
  }
  /**
   * Get configurations for field
   *
   * @param object $field          
   * @return array
   */
  private function getConfigurationsForField($field) {
    $list = array ();
    if ($this-&gt;configuration-&gt;getConfig ( &quot;solr&quot; ) != null) {
      $configurations = array_keys ( $this-&gt;configuration-&gt;getConfig ( &quot;solr&quot; ) );
      foreach ( $configurations as $configuration ) {
        $data = $this-&gt;configuration-&gt;getSolrConfig ( $configuration );
        if ($data != null) {
          if (in_array ( $field, $data [&quot;fields&quot;] )) {
            $list [] = $configuration;
          } else {
            // do nothing
          }
        }
      }
    }
    return array_unique ( $list );
  }
  /**
   * Compute expansions values
   *
   * @param array|string $value          
   * @param object $expansion          
   * @param string $prefixMessage          
   * @return array
   */
  private function computeExpansionValues($value, $expansion, $prefixMessage = &quot;&quot;) {    
    $values = array ();
    if ($expansion &amp;&amp; is_object ( $expansion )) {
      foreach ( $expansion as $key =&gt; $item ) {
        if ($key != &quot;type&quot; &amp;&amp; $key != &quot;parameters&quot;) {
          $this-&gt;warnings [] = $prefixMessage . &quot;expansion - unexpected key '{$key}'&quot;;
        }
      }
      if (! isset ( $expansion-&gt;type ) || ! is_string ( $expansion-&gt;type )) {
        $this-&gt;errors [] = $prefixMessage . &quot;expansion - no (valid) type provided&quot;;
      } else if (isset ( $expansion-&gt;parameters ) &amp;&amp; ! is_object ( $expansion-&gt;parameters )) {
        $this-&gt;errors [] = $prefixMessage . &quot;expansion - invalid parameters provided&quot;;
      } else {
        $expansionObjectClass = &quot;\\BrokerExpansion\\&quot; . ucfirst ( $expansion-&gt;type ) . &quot;Expansion&quot;;
        if (! class_exists ( $expansionObjectClass, true )) {
          $this-&gt;errors [] = $prefixMessage . &quot;expansion - could not find expansion module '&quot; . $expansion-&gt;type . &quot;'&quot;;
        } else if (! in_array ( &quot;Broker\\Expansion&quot;, class_implements ( $expansionObjectClass, true ) )) {
          $this-&gt;errors [] = $prefixMessage . &quot;expansion - expansion module '&quot; . $expansion-&gt;type . &quot;' does not implement Extension interface&quot;;
        } else {
          if (isset ( $expansion-&gt;parameters )) {
            $parameters = $expansionObjectClass::parameters ();
            foreach ( $expansion-&gt;parameters as $parameter =&gt; $parameterValue ) {
              if (! isset ( $parameters [$parameter] )) {
                $this-&gt;warnings [] = $prefixMessage . &quot;expansion - unexpected parameter '{$parameter}'&quot;;
              }
            }
          }
          if (is_array ( $value )) {
            foreach ( $value as $valueItem ) {
              $expansionObject = new $expansionObjectClass ( $valueItem, $expansion , $this-&gt;configuration, $this-&gt;solrConfiguration);
              $values = array_merge ( $values, $expansionObject-&gt;getValues () );
            }
          } else {
            $expansionObject = new $expansionObjectClass ( $value, $expansion, $this-&gt;configuration, $this-&gt;solrConfiguration );
            // check cache
            if ($expansionObject-&gt;cached ()) {
              if (! $this-&gt;expansionCache) {
                $this-&gt;expansionCache = new \Broker\ExpansionCache ( SITE_CACHE_DATABASE_DIR );
              }
              list ( $id, $cachedValues ) = $this-&gt;expansionCache-&gt;check ( $expansion-&gt;type, $value, isset ( $expansion-&gt;parameters ) ? array($this-&gt;solrConfiguration, $expansion-&gt;parameters) : $this-&gt;solrConfiguration );
              if ($id) {
                $values = $cachedValues;
              } else {
                $values = $expansionObject-&gt;getValues ();
                if (! ($expansionErrors = $expansionObject-&gt;getErrors ())) {
                  $this-&gt;expansionCache-&gt;create ( $expansion-&gt;type, $value, isset ( $expansion-&gt;parameters ) ? array($this-&gt;solrConfiguration, $expansion-&gt;parameters) : $this-&gt;solrConfiguration, $values );
                } else {
                  foreach ( $expansionErrors as $expansionError ) {
                    $this-&gt;warnings [] = $prefixMessage . &quot;expansion - &quot; . $expansionError;
                  }
                }
              }
            } else {
              $values = $expansionObject-&gt;getValues ();
              if ($expansionErrors = $expansionObject-&gt;getErrors ()) {
                foreach ( $expansionErrors as $expansionError ) {
                  $this-&gt;warnings [] = $prefixMessage . &quot;expansion - &quot; . $expansionError;
                }
              }
            }
          }
        }
      }
    }
    return $values;
  }
  /**
   * Compute configuration
   *
   * @param string $config          
   * @return object
   */
  private function computeConfiguration($config) {
    $availableConfigs = array_keys ( $this-&gt;configuration-&gt;getConfig ( &quot;solr&quot; ) );
    if ($config != null) {
      if (! in_array ( $config, $availableConfigs )) {
        $this-&gt;errors [] = &quot;configuration - configuration '{$config}' unknown&quot;;
        return null;
      }
    } else if (count ( $this-&gt;__configurations ) == 0) {
      if (count ( $availableConfigs ) &gt; 0) {
        return $availableConfigs [0];
      } else {
        // continue
      }
    }
    if (count ( $this-&gt;__configurations ) == 0) {
      if ($config != null) {
        return $config;
      } else {
        return null;
      }
    } else {
      $candidates = $this-&gt;__configurations [0];
      for($i = 1; $i &lt; count ( $this-&gt;__configurations ); $i ++) {
        $candidates = array_intersect ( $candidates, $this-&gt;__configurations [$i] );
        if (count ( $candidates ) == 0) {
          return null;
        }
      }
      if (count ( $candidates ) == 0) {
        return null;
      } else {
        if ($config == null) {
          return $candidates [0];
        } else if (in_array ( $config, $candidates )) {
          return $config;
        } else {
          return null;
        }
      }
    }
  }
  /**
   * Solr encode
   *
   * @param object $value          
   * @param string $type          
   * @return string
   */
  private function solrEncode($value, $type = null) {
    if (($type == &quot;equals&quot;) &amp;&amp; is_bool ( $value )) {
      if ($value) {
        $string = &quot;true&quot;;
      } else {
        $string = &quot;false&quot;;
      }
    } else if ($type == &quot;query&quot;) {
      $match = array (
          '\\' 
      );
      $replace = array (
          '\\\\' 
      );
      $string = &quot;\&quot;&quot; . str_replace ( $match, $replace, $value ) . &quot;\&quot;&quot;;
    } else if ($type == &quot;range&quot;) {
      $match = array (
          '\\',
          '+',
          '-',
          '&amp;',
          '|',
          '!',
          '(',
          ')',
          '{',
          '}',
          '[',
          ']',
          '^',
          '~',
          '?',
          ':',
          '&quot;',
          ';',
          ' ' 
      );
      $replace = array (
          '\\\\',
          '\\+',
          '\\-',
          '\\&amp;',
          '\\|',
          '\\!',
          '\\(',
          '\\)',
          '\\{',
          '\\}',
          '\\[',
          '\\]',
          '\\^',
          '\\~',
          '\\?',
          '\\:',
          '\\&quot;',
          '\\;',
          '\\ ' 
      );
      $string = str_replace ( $match, $replace, $value );
    } else if ($type == &quot;wildcard&quot;) {
      $match = array (
          '\\',
          '+',
          '-',
          '&amp;',
          '|',
          '!',
          '(',
          ')',
          '{',
          '}',
          '[',
          ']',
          '^',
          '~',
          ':',
          '&quot;',
          ';',
          ' ' 
      );
      $replace = array (
          '\\\\',
          '\\+',
          '\\-',
          '\\&amp;',
          '\\|',
          '\\!',
          '\\(',
          '\\)',
          '\\{',
          '\\}',
          '\\[',
          '\\]',
          '\\^',
          '\\~',
          '\\:',
          '\\&quot;',
          '\\;',
          '\\ ' 
      );
      $string = str_replace ( $match, $replace, $value );
    } else if ($type == &quot;phrase&quot;) {
      $match = array (
          '\\',
          '+',
          '-',
          '&amp;',
          '|',
          '!',
          '(',
          ')',
          '{',
          '}',
          '[',
          ']',
          '^',
          '~',
          '*',
          '?',
          ':',
          '&quot;',
          ';',
          ' ' 
      );
      $replace = array (
          '\\\\',
          '\\+',
          '\\-',
          '\\&amp;',
          '\\|',
          '\\!',
          '\\(',
          '\\)',
          '\\{',
          '\\}',
          '\\[',
          '\\]',
          '\\^',
          '\\~',
          '\\*',
          '\\?',
          '\\:',
          '\\&quot;',
          '\\;',
          '\\ ' 
      );
      $string = str_replace ( $match, $replace, $value );
      $string = &quot;\&quot;&quot; . $string . &quot;\&quot;&quot;;
    } else if ($type == &quot;regexp&quot;) {
      $match = array (
          '/' 
      );
      $replace = array (
          '\\/' 
      );
      $string = str_replace ( $match, $replace, $value );
      $string = &quot;/&quot; . $string . &quot;/&quot;;
    } else if ($type == &quot;cql&quot; || $type == &quot;simple&quot;) {
      $match = array (
          '\\',
          '&quot;' 
      );
      $replace = array (
          '\\\\',
          '\\&quot;' 
      );
      $string = str_replace ( $match, $replace, $value );
      $string = &quot;\&quot;&quot; . $string . &quot;\&quot;&quot;;
    } else {
      $match = array (
          '\\',
          '+',
          '-',
          '&amp;',
          '|',
          '!',
          '(',
          ')',
          '{',
          '}',
          '[',
          ']',
          '^',
          '~',
          '*',
          '?',
          ':',
          '&quot;',
          ';',
          ' ' 
      );
      $replace = array (
          '\\\\',
          '\\+',
          '\\-',
          '\\&amp;',
          '\\|',
          '\\!',
          '\\(',
          '\\)',
          '\\{',
          '\\}',
          '\\[',
          '\\]',
          '\\^',
          '\\~',
          '\\*',
          '\\?',
          '\\:',
          '\\&quot;',
          '\\;',
          '\\ ' 
      );
      $string = str_replace ( $match, $replace, $value );
      if (! preg_match ( &quot;/ /&quot;, $string )) {
        $string = &quot;\&quot;&quot; . $string . &quot;\&quot;&quot;;
      }
    }
    return $string;
  }
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>