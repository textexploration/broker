<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

/**
 * Broker
 * @package Broker
 */
namespace Broker;

/**
 * Cache
 */
class Cache extends Database {
  /**
   * Lifetime
   *
   * @var number
   */
  private $lifetime = 3000;
  /**
   * Softlimit
   *
   * @var number
   */
  private $softlimit = 800;
  /**
   * Hardlimit
   *
   * @var number
   */
  private $hardlimit = 1000;
  /**
   * Timelimit
   *
   * @var number
   */
  private $timelimit = 60;
  /**
   * Constructor
   *
   * @param string $directory
   * @param object $configuration
   */
  public function __construct($directory, $configuration) {
    parent::__construct ( $directory, $configuration, &quot;cache&quot; );
    if(isset($configuration-&gt;config[&quot;cache&quot;])) {
      if(isset($configuration-&gt;config[&quot;cache&quot;][&quot;lifetime&quot;])) {
        $this-&gt;lifetime = intval($configuration-&gt;config[&quot;cache&quot;][&quot;lifetime&quot;]);
      }
      if(isset($configuration-&gt;config[&quot;cache&quot;][&quot;softlimit&quot;])) {
        $this-&gt;softlimit = intval($configuration-&gt;config[&quot;cache&quot;][&quot;softlimit&quot;]);
      }
      if(isset($configuration-&gt;config[&quot;cache&quot;][&quot;hardlimit&quot;])) {
        $this-&gt;hardlimit = intval($configuration-&gt;config[&quot;cache&quot;][&quot;hardlimit&quot;]);
      }
      if(isset($configuration-&gt;config[&quot;cache&quot;][&quot;timelimit&quot;])) {
        $this-&gt;timelimit = intval($configuration-&gt;config[&quot;cache&quot;][&quot;timelimit&quot;]);
      }
    }
    //check
    if($this-&gt;softlimit&lt;=0 || $this-&gt;softlimit&gt;$this-&gt;hardlimit) {
      die(&quot;invalid soft/hard limit for cache&quot;);
    } else if($this-&gt;lifetime&lt;=0 || $this-&gt;timelimit&lt;=0) {
      die(&quot;invalid time setting in cache&quot;);
    }
  }
  /**
   * Init
   */
  public function init() {
    $sql = &quot;CREATE TABLE IF NOT EXISTS \&quot;cache\&quot; (
          \&quot;id\&quot; INTEGER PRIMARY KEY ASC,
          \&quot;hash\&quot; TEXT NOT NULL,
          \&quot;configuration\&quot; TEXT NULL,
          \&quot;url\&quot; TEXT NOT NULL,
          \&quot;request\&quot; TEXT NOT NULL,
          \&quot;requestAddition\&quot; TEXT,
          \&quot;response\&quot; TEXT NOT NULL,          
          \&quot;numberOfChecks\&quot; INTEGER,
          \&quot;created\&quot; TEXT NOT NULL,
          \&quot;used\&quot; TEXT NOT NULL,          
          \&quot;expires\&quot; TEXT NOT NULL,
          UNIQUE(\&quot;hash\&quot;));&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;execute ();
    unset ( $query );
  }
  /**
   * Create
   *
   * @param string $configuration
   * @param string $url
   * @param string $request
   * @param string $requestAddition
   * @param object $response
   */
  public function create($configuration, $url, $request, $requestAddition, $response) {
    $this-&gt;clean ();
    // hash
    $hash = $this-&gt;createHash ( $configuration, $url, $request );
    // delete
    $sql = &quot;DELETE FROM \&quot;cache\&quot; WHERE hash IS :hash;&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;bindValue ( &quot;:hash&quot;, $hash );
    $query-&gt;execute ();
    unset ( $query );
    // insert
    $sql = &quot;INSERT OR IGNORE INTO \&quot;cache\&quot;
    (hash, configuration, url, request, requestAddition, response, numberOfChecks, created, used, expires)
    VALUES (:hash, :configuration, :url, :request, :requestAddition, :response, 1, datetime('now'), datetime('now'), datetime('now', '+&quot; . intval ( $this-&gt;lifetime ) . &quot; minutes'))&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;bindValue ( &quot;:hash&quot;, $hash );
    $query-&gt;bindValue ( &quot;:configuration&quot;, $configuration );
    $query-&gt;bindValue ( &quot;:url&quot;, $url );
    $query-&gt;bindValue ( &quot;:request&quot;, $request );
    $query-&gt;bindValue ( &quot;:requestAddition&quot;, $requestAddition );
    $query-&gt;bindValue ( &quot;:response&quot;, $response );
    $query-&gt;execute ();
    unset ( $query );
  }
  /**
   * Get
   *
   * @param string $hash
   * @return array
   */
  public function get($hash) {
    $sql = &quot;SELECT    
    id, hash, configuration, url, request, requestAddition, response, numberOfChecks,
    datetime(created, 'localtime') as created,
    datetime(used, 'localtime') as used,
    datetime(expires, 'localtime') as expires
    FROM \&quot;cache\&quot;
    WHERE hash IS :hash&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;bindValue ( &quot;:hash&quot;, $hash );
    if ($query-&gt;execute ()) {
      $result = $query-&gt;fetch ( \PDO::FETCH_ASSOC );
      unset ( $query );
      return $result;
    } else {
      return null;
    }
  }
  /**
   * Delete
   *
   * @param string $hash
   */
  public function delete($hash) {
    $sql = &quot;DELETE FROM \&quot;cache\&quot; WHERE hash IS :hash;&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;bindValue ( &quot;:hash&quot;, $hash );
    $query-&gt;execute ();
    unset ( $query );
  }
  /**
   * Check
   *
   * @param string $configuration
   * @param string $url
   * @param string $request
   * @return array
   */
  public function check($configuration, $url, $request) {
    $this-&gt;clean ();
    // hash
    $hash = $this-&gt;createHash ( $configuration, $url, $request );
    // get info
    $sql = &quot;SELECT
        id, response
    FROM \&quot;cache\&quot;
    WHERE hash IS :hash
    AND configuration IS :configuration
    AND url IS :url
    AND request IS :request;&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;bindValue ( &quot;:hash&quot;, $hash );
    $query-&gt;bindValue ( &quot;:configuration&quot;, $configuration );
    $query-&gt;bindValue ( &quot;:url&quot;, $url );
    $query-&gt;bindValue ( &quot;:request&quot;, $request );
    if ($query-&gt;execute ()) {
      $result = $query-&gt;fetch ( \PDO::FETCH_ASSOC );
      unset ( $query );
      if ($result &amp;&amp; $result [&quot;id&quot;]) {
        // update
        $sql = &quot;UPDATE \&quot;cache\&quot; SET
          numberOfChecks = numberOfChecks + 1,    
          used = datetime('now'),   
          expires = datetime('now', '+&quot; . intval ( $this-&gt;lifetime ) . &quot; minutes')          
        WHERE id IS :id;&quot;;
        $query = $this-&gt;database-&gt;prepare ( $sql );
        $query-&gt;bindValue ( &quot;:id&quot;, $result [&quot;id&quot;] );
        $query-&gt;execute ();
        unset ( $query );
        // return response
        return array (
            $result [&quot;id&quot;],
            $result [&quot;response&quot;] 
        );
      } else {
        return array (
            null,
            null 
        );
      }
    } else {
      return array (
          null,
          null 
      );
    }
  }
  /**
   * Get list
   *
   * @param number $start
   * @param number $number
   * @return array
   */
  public function getList($start, $number) {
    $sql = &quot;SELECT    
        id, hash, configuration, numberOfChecks,
        datetime(created, 'localtime') as created,
        datetime(used, 'localtime') as used,
        datetime(expires, 'localtime') as expires
    FROM \&quot;cache\&quot;
    ORDER BY expires DESC
    LIMIT :start,:number;&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;bindValue ( &quot;:start&quot;, $start );
    $query-&gt;bindValue ( &quot;:number&quot;, $number );
    if ($query-&gt;execute ()) {
      $result = $query-&gt;fetchAll ( \PDO::FETCH_ASSOC );
      unset ( $query );
      if ($result) {
        return ( array ) $result;
      } else {
        return null;
      }
    } else {
      return null;
    }
  }
  /**
   * Clean
   */
  public function clean() {
    $sql = &quot;DELETE FROM \&quot;cache\&quot; WHERE expires &lt; datetime('now');&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;execute ();
    unset ( $query );
    // check limits
    $number = $this-&gt;getSize ();
    if ($number &gt; $this-&gt;hardlimit) {
      // first delete everything with only one check and created longer than $this-&gt;timelimit minutes ago
      $sql = &quot;DELETE FROM \&quot;cache\&quot; 
              WHERE numberOfChecks = 1 
              AND created &lt; datetime('now', '+&quot; . intval ( $this-&gt;timelimit ) . &quot; minutes');&quot;;
      $query = $this-&gt;database-&gt;prepare ( $sql );
      $query-&gt;execute ();
      unset ( $query );
      $number = $this-&gt;getSize ();
    } else {
      return;
    }
    //recheck
    if ($number &gt; $this-&gt;hardlimit) {
      //get expires limit
      $sql = &quot;SELECT expires FROM \&quot;cache\&quot; 
              ORDER BY expires DESC 
              LIMIT :start,1;&quot;;      
      $query = $this-&gt;database-&gt;prepare ( $sql );
      $query-&gt;bindValue ( &quot;:start&quot;, $this-&gt;softLimit );
      if ($query-&gt;execute ()) {
        $result = $query-&gt;fetchAll ( \PDO::FETCH_ASSOC );
        unset ( $query );
        if ($result) {
          $sql = &quot;DELETE FROM \&quot;cache\&quot;
                  WHERE expires &gt;= :expires;&quot;;
          $query = $this-&gt;database-&gt;prepare ( $sql );
          $query-&gt;bindValue ( &quot;:expires&quot;, $result[&quot;expires&quot;] );
          $query-&gt;execute ();
        }
      } 
    }
  }
  /**
   * Get number
   *
   * @return number
   */
  private function getSize() {
    $sql = &quot;SELECT COUNT(\&quot;id\&quot;) AS \&quot;number\&quot; FROM \&quot;cache\&quot;;&quot;;
    $query = $this-&gt;database-&gt;prepare ( $sql );
    $query-&gt;execute ();
    $result = $query-&gt;fetch ( \PDO::FETCH_ASSOC );
    unset ( $query );
    if ($result &amp;&amp; is_array ( $result ) &amp;&amp; isset ( $result [&quot;number&quot;] )) {
      return intval ( $result [&quot;number&quot;] );
    } else {
      return 0;
    }
  }
  /**
   * Create hash
   *
   * @param string $configuration
   * @param string $url
   * @param string $request
   * @return string
   */
  private static function createHash($configuration, $url, $request) {
    $base = trim ( $configuration ) . &quot;\n&quot; . trim ( $url ) . &quot;\n&quot; . trim ( $request );
    return hash ( &quot;md5&quot;, $base );
  }
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>